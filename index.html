<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>groupify</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ============================================================
   DESIGN TOKENS
   ============================================================ */
:root {
  --brand:#2D6A4F; --brand-l:#52B788; --brand-p:#D8F3DC;
  --accent:#F4845F; --accent-l:#FDDCCC;
  --dark:#1B2D24; --mid:#4A6558; --text:#2C3E35; --muted:#7A9688;
  --border:#D4E8DC; --bg:#F5FAF7;
  --shadow:0 2px 12px rgba(45,106,79,.08);
  --shadow-lg:0 8px 32px rgba(45,106,79,.14);
  --r:16px; --rsm:10px;
}

/* ============================================================
   RESET & BASE
   ============================================================ */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:15px;line-height:1.5}
a{cursor:pointer;color:var(--brand);text-decoration:none;font-weight:500}
a:hover{text-decoration:underline}

/* ============================================================
   SCREENS
   ============================================================ */
.screen{display:none;min-height:100vh}
.screen.active{display:flex;flex-direction:column}
#s-app.active{flex-direction:row}

/* ============================================================
   AUTH / LOGIN
   ============================================================ */
#s-login{background:linear-gradient(145deg,#1B2D24 0%,#2D6A4F 60%,#52B788 100%);align-items:center;justify-content:center;padding:24px}
.lcard{background:#fff;border-radius:24px;padding:48px 40px;width:100%;max-width:420px;box-shadow:0 24px 64px rgba(0,0,0,.2)}
.llogo{font-family:'DM Sans',sans-serif;font-size:46px;font-weight:600;color:var(--brand);text-align:center;margin-bottom:4px;letter-spacing:-1.5px}
.ltag{text-align:center;color:var(--muted);font-size:14px;margin-bottom:28px}
.lswitch{text-align:center;font-size:13px;color:var(--muted);margin-top:16px}

/* Step dots for signup flow */
.step-dots{display:flex;gap:8px;justify-content:center;margin-bottom:22px}
.step-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all .25s}
.step-dot.active{background:var(--brand);width:22px;border-radius:4px}

/* Role picker */
.role-grid{display:grid;gap:10px;margin-bottom:20px}
.role-opt{border:1.5px solid var(--border);border-radius:var(--rsm);padding:14px 16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px}
.role-opt:hover{border-color:var(--brand-l);background:var(--brand-p)}
.role-opt.sel{border-color:var(--brand);background:var(--brand-p)}
.role-opt-em{font-size:22px;flex-shrink:0}
.role-opt-title{font-size:14px;font-weight:600;color:var(--dark)}
.role-opt-sub{font-size:12px;color:var(--muted);margin-top:2px}

/* Demo buttons */
.demo-sep{border-top:1px solid var(--border);margin-top:24px;padding-top:20px;text-align:center}
.demo-sep p{font-size:12px;color:var(--muted);margin-bottom:10px}
.demo-btn{display:block;width:100%;padding:11px;border-radius:var(--rsm);font-size:14px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);background:var(--bg);color:var(--mid);text-align:center;transition:all .2s;margin-bottom:8px;font-family:inherit}
.demo-btn:hover{border-color:var(--brand-l);background:var(--brand-p);color:var(--brand)}

/* ============================================================
   FORMS
   ============================================================ */
.fg{margin-bottom:16px}
.fg label{display:block;font-size:13px;font-weight:500;color:var(--mid);margin-bottom:6px}
.fg input,.fg select,.fg textarea{width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:11px 15px;font-family:inherit;font-size:15px;color:var(--text);background:var(--bg);outline:none;transition:border-color .2s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--brand-l);background:#fff}
.fg textarea{resize:vertical;line-height:1.5}
.field-note{font-size:12px;color:var(--muted);margin-top:4px}

/* ============================================================
   BUTTONS
   ============================================================ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:11px 22px;border-radius:var(--rsm);font-family:inherit;font-size:15px;font-weight:500;cursor:pointer;border:none;transition:all .18s;white-space:nowrap}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-p{background:var(--brand);color:#fff}
.btn-p:hover:not(:disabled){background:var(--dark);transform:translateY(-1px);box-shadow:var(--shadow)}
.btn-s{background:var(--brand-p);color:var(--brand)}
.btn-s:hover:not(:disabled){background:var(--border)}
.btn-a{background:var(--accent);color:#fff}
.btn-a:hover:not(:disabled){background:#e06a45}
.btn-g{background:transparent;color:var(--mid);border:1.5px solid var(--border)}
.btn-g:hover:not(:disabled){background:var(--brand-p);color:var(--brand);border-color:var(--brand-l)}
.btn-sm{padding:7px 14px;font-size:13px}
.btn-full{width:100%}
.btn-row{display:flex;gap:10px}
.btn-row .btn-full{flex:1}

/* ============================================================
   APP SHELL - SIDEBAR
   ============================================================ */
.sidebar{width:256px;background:var(--dark);color:#fff;display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;position:sticky;top:0;height:100vh}
.sb-logo{padding:24px 22px 16px;font-family:'DM Sans',sans-serif;font-weight:600;letter-spacing:-0.5px;font-size:28px;color:var(--brand-l);border-bottom:1px solid rgba(255,255,255,.07)}
.sb-logo small{display:block;font-size:11px;font-weight:400;color:rgba(255,255,255,.3);margin-top:-2px;letter-spacing:0}
.sb-user{padding:14px 22px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:10px}
.u-av{width:36px;height:36px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;color:#fff}
.u-name{font-size:14px;font-weight:500;color:#fff;line-height:1.3}
.u-role{font-size:11px;color:rgba(255,255,255,.38)}
.sb-nav{padding:12px 0;flex:1}
.nav-sec{padding:10px 22px 3px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,.28)}
.nav-divider{border-top:1px solid rgba(255,255,255,.07);margin:8px 0}
.ni{display:flex;align-items:center;gap:11px;padding:10px 22px;font-size:14px;color:rgba(255,255,255,.58);cursor:pointer;transition:all .15s;border-left:3px solid transparent}
.ni:hover{background:rgba(255,255,255,.06);color:#fff}
.ni.active{background:rgba(82,183,136,.14);color:var(--brand-l);border-left-color:var(--brand-l)}
.ni-ic{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.sb-foot{padding:14px 22px;border-top:1px solid rgba(255,255,255,.07)}

/* ============================================================
   APP SHELL - MAIN CONTENT
   ============================================================ */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:15px 28px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;position:sticky;top:0;z-index:10}
.topbar h1{font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark)}
#page-content{padding:24px 28px;flex:1}

/* ============================================================
   CARDS & LAYOUT
   ============================================================ */
.card{background:#fff;border-radius:var(--r);padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:18px}
.card:last-child{margin-bottom:0}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:15px;font-weight:600;color:var(--dark)}
.card-note{font-size:13px;color:var(--muted)}
.sec-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:12px;margin-top:4px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}

/* ============================================================
   STAT CARDS
   ============================================================ */
.stat-card{background:#fff;border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow);border:1px solid var(--border)}
.stat-em{font-size:24px;margin-bottom:6px}
.stat-val{font-family:'DM Serif Display',serif;font-size:32px;color:var(--dark);line-height:1}
.stat-lbl{font-size:12px;color:var(--muted);margin-top:4px}

/* ============================================================
   HERO / NEXT MEETING
   ============================================================ */
.mhero{background:linear-gradient(135deg,var(--brand) 0%,var(--brand-l) 100%);border-radius:var(--r);padding:26px;color:#fff;margin-bottom:18px;position:relative;overflow:hidden}
.mhero::before{content:'';position:absolute;right:-20px;top:-20px;width:140px;height:140px;background:rgba(255,255,255,.06);border-radius:50%}
.mhero::after{content:'';position:absolute;right:40px;bottom:-30px;width:90px;height:90px;background:rgba(255,255,255,.05);border-radius:50%}
.mhero-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.4px;opacity:.65;margin-bottom:7px}
.mhero-title{font-family:'DM Serif Display',serif;font-size:26px;margin-bottom:14px;position:relative}
.mhero-details{display:flex;flex-wrap:wrap;gap:6px 18px;position:relative}
.mhero-detail{font-size:14px;opacity:.9}
.mhero-actions{margin-top:16px;position:relative}

/* ============================================================
   ICEBREAKER CARD
   ============================================================ */
.iq-card{background:linear-gradient(135deg,var(--brand-p),#fff);border:1.5px solid var(--brand-l);border-radius:var(--r);padding:24px;margin-bottom:18px}
.iq-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--brand);margin-bottom:12px}
.iq-text{font-family:'DM Serif Display',serif;font-size:21px;color:var(--dark);line-height:1.45;margin-bottom:16px}
.iq-footer{display:flex;align-items:center;justify-content:space-between;gap:12px}
.iq-tip{font-size:13px;color:var(--mid)}

/* ============================================================
   TABS
   ============================================================ */
.tabs{display:flex;gap:4px;background:var(--bg);border-radius:var(--rsm);padding:4px;margin-bottom:18px;border:1px solid var(--border)}
.tab{flex:1;padding:8px 12px;border-radius:7px;font-size:13px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .18s;text-align:center}
.tab.active{background:#fff;color:var(--brand);box-shadow:var(--shadow)}
.tab:hover:not(.active){color:var(--mid)}

/* ============================================================
   MEMBERS LIST
   ============================================================ */
.member-row{display:flex;align-items:center;gap:14px;padding:13px 0;border-bottom:1px solid var(--border)}
.member-row:last-child{border-bottom:none}
.m-av{width:38px;height:38px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0}
.m-av.placeholder{background:var(--muted);opacity:.6}
.m-name{font-size:14px;font-weight:600;color:var(--dark)}
.m-role{font-size:12px;color:var(--muted);margin-top:2px}
.m-actions{margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0}

/* ============================================================
   BADGES & CHIPS
   ============================================================ */
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
.badge-green{background:var(--brand-p);color:var(--brand)}
.badge-blue{background:#E8F4FD;color:#2980B9}
.badge-grey{background:#f3f3f3;color:var(--muted)}
.chip{background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:12px;color:var(--mid)}

/* ============================================================
   RESOURCE CARDS
   ============================================================ */
.res-card{background:#fff;border:1.5px solid var(--border);border-radius:var(--rsm);padding:16px;margin-bottom:12px}
.res-type{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--brand);margin-bottom:5px}
.res-title{font-size:15px;font-weight:600;color:var(--dark);margin-bottom:5px}
.res-desc{font-size:13px;color:var(--mid);line-height:1.5;margin-bottom:10px}
.res-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
.res-actions{display:flex;gap:8px;flex-wrap:wrap}

/* ============================================================
   HEALTH / PROGRESS
   ============================================================ */
.health-row{margin-bottom:12px}
.health-row-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:14px}
.health-bar-bg{height:8px;background:var(--bg);border-radius:4px;border:1px solid var(--border)}
.health-bar-fill{height:100%;border-radius:4px;background:var(--brand-l);transition:width .5s ease}
.health-bar-fill.low{background:#E74C3C}
.health-bar-fill.med{background:#F39C12}

/* ============================================================
   MILESTONE BADGES
   ============================================================ */
.badge-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px}
.milestone{border-radius:var(--rsm);padding:18px 14px;text-align:center;border:1.5px solid var(--border);transition:all .2s}
.milestone.earned{background:var(--brand-p);border-color:var(--brand-l)}
.milestone.locked{background:#fafafa;opacity:.55}
.milestone-em{font-size:36px;margin-bottom:8px}
.milestone-name{font-size:13px;font-weight:600;color:var(--dark)}
.milestone-desc{font-size:11px;color:var(--muted);margin-top:3px}

/* ============================================================
   ATTENDANCE
   ============================================================ */
.att-row{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border)}
.att-row:last-child{border-bottom:none}
.att-btns{margin-left:auto;display:flex;gap:6px}
.att-btn{padding:6px 14px;border-radius:var(--rsm);font-size:13px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--mid);font-family:inherit;transition:all .15s}
.att-btn.present{background:#D8F3DC;border-color:var(--brand-l);color:var(--brand)}
.att-btn.absent{background:#FDDCCC;border-color:var(--accent-l);color:var(--accent)}

/* ============================================================
   PRAYER WALL
   ============================================================ */
.prayer-item{padding:14px 0;border-bottom:1px solid var(--border)}
.prayer-item:last-child{border-bottom:none}
.prayer-item.answered{background:linear-gradient(135deg,#fffdf5,#fff);border-left:3px solid #F1C40F;padding-left:12px;margin-left:-12px;border-bottom-color:transparent;border-radius:0 var(--rsm) var(--rsm) 0}
.prayer-meta{display:flex;justify-content:space-between;margin-bottom:6px}
.prayer-author{font-size:12px;font-weight:600;color:var(--brand)}
.prayer-date{font-size:12px;color:var(--muted)}
.prayer-text{font-size:14px;color:var(--text);line-height:1.6;margin-bottom:10px}
.prayer-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.pray-btn{background:transparent;border:none;font-size:13px;color:var(--muted);cursor:pointer;padding:4px 10px;border-radius:20px;transition:all .18s;font-family:inherit}
.pray-btn:hover,.pray-btn.prayed{background:var(--brand-p);color:var(--brand)}
.pray-count{font-size:12px;color:var(--muted)}

/* ============================================================
   SCHEDULE / POLL
   ============================================================ */
.poll-slot{background:#fff;border:1.5px solid var(--border);border-radius:var(--rsm);padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px}
.poll-slot.voted{border-color:var(--brand-l);background:var(--brand-p)}
.poll-bar-wrap{flex:1}
.poll-bar-label{font-size:13px;font-weight:500;color:var(--dark);margin-bottom:5px}
.poll-bar-bg{height:6px;background:var(--bg);border-radius:3px}
.poll-bar-fill{height:100%;border-radius:3px;background:var(--brand-l);transition:width .4s}
.poll-count{font-size:12px;color:var(--muted);margin-top:4px}
.poll-vote{padding:7px 14px;border-radius:var(--rsm);font-size:13px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--mid);font-family:inherit;transition:all .15s;flex-shrink:0}
.poll-vote.voted{background:var(--brand);color:#fff;border-color:var(--brand)}

/* ============================================================
   INVITE CODE DISPLAY
   ============================================================ */
.invite-card{background:var(--brand-p);border:1.5px solid var(--brand-l);border-radius:var(--r);padding:20px 22px;margin-bottom:18px}
.invite-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--brand);margin-bottom:8px}
.invite-code{font-size:30px;font-weight:700;color:var(--brand);letter-spacing:3px;margin-bottom:10px;font-family:'DM Sans',sans-serif}
.invite-note{font-size:13px;color:var(--mid);margin-bottom:12px;line-height:1.5}

/* ============================================================
   MODAL
   ============================================================ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal-box{background:#fff;border-radius:20px;padding:32px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 24px 64px rgba(0,0,0,.2)}
.modal-close{position:absolute;top:16px;right:16px;background:transparent;border:none;font-size:20px;color:var(--muted);cursor:pointer;line-height:1;padding:4px}
.modal-close:hover{color:var(--dark)}
.modal-title{font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark);margin-bottom:4px}
.modal-sub{font-size:14px;color:var(--muted);margin-bottom:20px;line-height:1.5}
.modal-divider{border:none;border-top:1px solid var(--border);margin:18px 0}
.modal-box h2{font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark);margin-bottom:18px}

/* ============================================================
   TOAST
   ============================================================ */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--dark);color:#fff;padding:12px 22px;border-radius:30px;font-size:14px;font-weight:500;z-index:2000;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ============================================================
   EMPTY STATES
   ============================================================ */
.empty{text-align:center;padding:52px 24px}
.empty-em{font-size:48px;margin-bottom:16px}
.empty-title{font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark);margin-bottom:10px}
.empty-body{font-size:14px;color:var(--muted);line-height:1.7;max-width:380px;margin:0 auto 22px}

/* ============================================================
   INFO BANNERS
   ============================================================ */
.banner{border-radius:var(--rsm);padding:14px 16px;font-size:13px;line-height:1.6;margin-bottom:16px}
.banner-green{background:var(--brand-p);color:var(--mid);border:1px solid var(--brand-l)}
.banner-orange{background:#FFF3E0;color:#8B4513;border:1px solid #FDDCCC}

/* ============================================================
   UTILS
   ============================================================ */
.mb-0{margin-bottom:0!important}
.mt-10{margin-top:10px}
.mt-16{margin-top:16px}
.text-muted{color:var(--muted)}
.text-brand{color:var(--brand)}
.bold{font-weight:600}
hr.divider{border:none;border-top:1px solid var(--border);margin:18px 0}
</style>
</head>

<body>

<!-- ============================================================
     SCREEN: LOGIN / SIGNUP
     ============================================================ -->
<div class="screen active" id="s-login">
  <div class="lcard">

    <!-- Sign In View -->
    <div id="v-signin">
      <div class="llogo">groupify</div>
      <div class="ltag">small groups, made simpler</div>
      <div class="fg"><label>email</label><input type="email" id="si-email" placeholder="you@email.com" autocomplete="email"></div>
      <div class="fg"><label>password</label><input type="password" id="si-pw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
      <button class="btn btn-p btn-full" id="si-btn" onclick="doSignIn()">sign in</button>
      <div class="lswitch">don't have an account? <a onclick="showView('v-ca1')">create one</a></div>
      <div class="demo-sep">
        <p>or try a demo account</p>
        <button class="demo-btn" onclick="loginDemo('ministry')">‚õ™ demo ‚Äî ministry leader</button>
        <button class="demo-btn" onclick="loginDemo('leader')">üë• demo ‚Äî group leader</button>
        <button class="demo-btn" onclick="loginDemo('member')">üôã demo ‚Äî group member</button>
      </div>
    </div>

    <!-- Signup Step 1: Role -->
    <div id="v-ca1" style="display:none">
      <div class="llogo" style="font-size:34px;margin-bottom:4px">groupify</div>
      <div class="ltag">create your account</div>
      <div class="step-dots">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
        <div class="step-dot" id="dot3"></div>
      </div>
      <div style="font-size:15px;font-weight:600;color:var(--dark);margin-bottom:14px">what's your role?</div>
      <div class="role-grid">
        <div class="role-opt" id="ro-ministry" onclick="pickRole('ministry')">
          <div class="role-opt-em">‚õ™</div>
          <div><div class="role-opt-title">ministry leader</div><div class="role-opt-sub">oversee multiple groups, view stats & health</div></div>
        </div>
        <div class="role-opt" id="ro-leader" onclick="pickRole('leader')">
          <div class="role-opt-em">üë•</div>
          <div><div class="role-opt-title">group leader</div><div class="role-opt-sub">lead a small group, track meetings & members</div></div>
        </div>
        <div class="role-opt" id="ro-member" onclick="pickRole('member')">
          <div class="role-opt-em">üôã</div>
          <div><div class="role-opt-title">group member</div><div class="role-opt-sub">join a group, pray, connect & grow together</div></div>
        </div>
      </div>
      <button class="btn btn-p btn-full" onclick="caStep2()">continue ‚Üí</button>
      <div class="lswitch">already have an account? <a onclick="showView('v-signin')">sign in</a></div>
    </div>

    <!-- Signup Step 2: Info -->
    <div id="v-ca2" style="display:none">
      <div class="llogo" style="font-size:34px;margin-bottom:4px">groupify</div>
      <div class="ltag">create your account</div>
      <div class="step-dots">
        <div class="step-dot" id="dot1b"></div>
        <div class="step-dot active" id="dot2b"></div>
        <div class="step-dot" id="dot3b"></div>
      </div>
      <div class="fg"><label>first name</label><input type="text" id="ca-fname" placeholder="first name" autocomplete="given-name"></div>
      <div class="fg"><label>last name</label><input type="text" id="ca-lname" placeholder="last name" autocomplete="family-name"></div>
      <div class="fg"><label>email</label><input type="email" id="ca-email" placeholder="you@email.com" autocomplete="email"></div>
      <div class="fg"><label>password</label><input type="password" id="ca-pw" placeholder="at least 8 characters" autocomplete="new-password"></div>
      <div class="fg"><label>confirm password</label><input type="password" id="ca-pw2" placeholder="confirm your password" autocomplete="new-password"></div>
      <div class="btn-row">
        <button class="btn btn-g" onclick="showView('v-ca1')">‚Üê back</button>
        <button class="btn btn-p btn-full" onclick="caStep3()">continue ‚Üí</button>
      </div>
      <div class="lswitch">already have an account? <a onclick="showView('v-signin')">sign in</a></div>
    </div>

    <!-- Signup Step 3: Context (varies by role) -->
    <div id="v-ca3" style="display:none">
      <div class="llogo" style="font-size:34px;margin-bottom:4px">groupify</div>
      <div class="ltag">create your account</div>
      <div class="step-dots">
        <div class="step-dot" id="dot1c"></div>
        <div class="step-dot" id="dot2c"></div>
        <div class="step-dot active" id="dot3c"></div>
      </div>
      <div id="ca3-body"></div>
      <div class="btn-row" style="margin-top:16px">
        <button class="btn btn-g" onclick="showView('v-ca2')">‚Üê back</button>
        <button class="btn btn-p btn-full" id="ca-finish-btn" onclick="caFinish()">create account üéâ</button>
      </div>
      <div class="lswitch">already have an account? <a onclick="showView('v-signin')">sign in</a></div>
    </div>

    <!-- Email Confirmation Notice -->
    <div id="v-confirm" style="display:none;text-align:center;padding:12px 0">
      <div style="font-size:48px;margin-bottom:16px">üì¨</div>
      <div style="font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark);margin-bottom:10px">check your email!</div>
      <div style="font-size:14px;color:var(--muted);line-height:1.7;margin-bottom:22px">we sent a confirmation link to your email address. click it to activate your account, then sign in.</div>
      <button class="btn btn-p btn-full" onclick="showView('v-signin')">go to sign in ‚Üí</button>
    </div>

  </div>
</div>

<!-- ============================================================
     SCREEN: APP
     ============================================================ -->
<div class="screen" id="s-app">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sb-logo">groupify<small id="sb-role-lbl">loading...</small></div>
    <div class="sb-user">
      <div class="u-av" id="sb-av">?</div>
      <div><div class="u-name" id="sb-name">...</div><div class="u-role" id="sb-role">...</div></div>
    </div>
    <nav class="sb-nav" id="sb-nav"></nav>
    <div class="sb-foot">
      <button class="btn btn-g btn-sm" onclick="doLogout()" style="width:100%;border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.5)">sign out</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <h1 id="page-title">home</h1>
      <div id="topbar-actions"></div>
    </div>
    <div id="page-content"></div>
  </div>

</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="modalClickOutside(event)">
  <div class="modal-box" id="modal-box"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
'use strict';

/* ============================================================
   SUPABASE
   ============================================================ */
const SUPA_URL = 'https://yhwiabbbbzudtjknzzbl.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlod2lhYmJiYnp1ZHRqa256emJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTY4NjgsImV4cCI6MjA4NzYzMjg2OH0.P_86ElyvMF2q6HXlrmvhbbo-txcnnXKXckcYsGk_Ocs';
var sb;
try { sb = supabase.createClient(SUPA_URL, SUPA_KEY); } catch(e) { console.error('Supabase init failed:', e); }

/* ============================================================
   APP STATE
   ============================================================ */
var DEMO = false;   // true when using a demo account
var CU   = null;   // current user object
var GD   = null;   // group data object
var caRole = null; // selected role during signup

// Current user shape:
// { id, name, init, email, type:'ministry'|'leader'|'member',
//   role:'ministry leader'|'group leader'|'group member',
//   groupId, ministryId, churchName, groupCode, minCode, groupResources:[], placeholderMembers:[] }

// Group data shape:
// { name, start, next:{day,time,loc,freq}, study, hw, stats:{meetings,answered,books} }

/* ============================================================
   DEMO DATA
   ============================================================ */
var DEMO_GROUPS = [
  {n:'Thursday Night Crew',h:87,lm:'3 days ago',members:6},
  {n:'Young Couples',h:72,lm:'1 week ago',members:8},
  {n:'Sunday Morning Men',h:91,lm:'5 days ago',members:5},
  {n:'Women of Faith',h:65,lm:'2 weeks ago',members:7},
  {n:'College Life',h:58,lm:'10 days ago',members:9}
];

var DEMO_MEMBERS = [
  {n:'Marcus Thompson',r:'leader',i:'MT',real:true},
  {n:'Jenna Thompson',r:'co-leader',i:'JT',real:true},
  {n:'Derek Richards',r:'host',i:'DR',real:true},
  {n:'Amy Chen',r:'prayer coordinator',i:'AC',real:true},
  {n:'Chris Wallace',r:'study coordinator',i:'CW',real:false}
];

var DEMO_PRAYERS = [
  {id:1,au:'Marcus T.',txt:'Praying for my mom\'s surgery next week. Would love the group to pray with us.',dt:'2 days ago',ans:false,cnt:4,prayed:false},
  {id:2,au:'Amy C.',txt:'Praise! Got the job offer I\'ve been praying about for months. God is faithful!',dt:'5 days ago',ans:true,cnt:7,prayed:true},
  {id:3,au:'Derek R.',txt:'My brother is going through a rough season. Please keep him in your prayers.',dt:'1 week ago',ans:false,cnt:3,prayed:false}
];

var DEMO_RESOURCES = [
  {type:'Video Series',title:'The Chosen - Season 1',desc:'Watch and discuss the life of Jesus through the eyes of those who knew him.',tags:['jesus','community','video']},
  {type:'Bible Study',title:'Emotionally Healthy Spirituality',desc:'Discover the connection between emotional health and spiritual maturity.',tags:['growth','emotions','spiritual']},
  {type:'Book',title:'The Ruthless Elimination of Hurry',desc:'A modern guide to slowing down and living fully in the pace of Jesus.',tags:['rest','rhythm','spiritual']}
];

var DEMO_SCHED = [
  {id:1,day:'Tuesday',date:'March 4',time:'7:30 PM',votes:4},
  {id:2,day:'Wednesday',date:'March 5',time:'7:00 PM',votes:6},
  {id:3,day:'Thursday',date:'March 6',time:'7:30 PM',votes:3},
  {id:4,day:'Saturday',date:'March 8',time:'10:00 AM',votes:2}
];

var DEMO_GD = {
  name:'Thursday Night Crew',start:'2020-01-15',
  next:{day:'Thursday',time:'7:30 PM',loc:'Marcus & Jenna\'s',freq:'weekly'},
  study:'James: Faith That Works',hw:'Read chapters 3-4. Journal about a time your words caused unintended harm.',
  stats:{meetings:48,answered:12,books:6}
};

var PRAYERS = JSON.parse(JSON.stringify(DEMO_PRAYERS));
var votedSlots = new Set([2]);

/* ============================================================
   ICEBREAKER QUESTIONS
   ============================================================ */
var IQ = [
  'What is one thing you are grateful for this week that you almost overlooked?',
  'What is a memory from childhood that shaped who you are today?',
  'If you could have dinner with anyone in history, who would it be and why?',
  'What is something God has been teaching you lately?',
  'What is a dream or goal you have not told many people about?',
  'What is the best piece of advice you have ever received?',
  'What does rest look like for you - and are you getting enough of it?',
  'What book, podcast, or message has impacted you most in the last year?',
  'Where do you feel most alive and like yourself?',
  'What is one thing you wish others understood about you?',
  'When did you last feel genuinely surprised by God?',
  'What does your prayer life look like right now - honestly?',
  'What is something you are currently struggling with that the group could pray for?',
  'What is a verse or truth you keep coming back to in this season?',
  'Who in your life right now needs someone to show up for them?',
  'What did you want to be when you grew up, and how did that change?',
  'If your life had a theme song right now, what would it be and why?',
  'What is one habit or rhythm that has made your faith feel more alive?',
  'What is something you have changed your mind about in the last few years?',
  'How have you seen God work in an unexpected way recently?'
];

/* ============================================================
   MEMBER ROLES
   ============================================================ */
var MEMBER_ROLES = ['leader','co-leader','prayer coordinator','service coordinator','study coordinator','host','social coordinator'];

/* ============================================================
   ASSESSMENT QUESTIONS
   ============================================================ */
var AQ = [
  {q:'How connected do you feel to the other members of your group?',lo:'distant',hi:'deeply connected'},
  {q:'How safe do you feel sharing honestly about your life in this group?',lo:'unsafe',hi:'completely safe'},
  {q:'How engaged is your group in studying scripture together?',lo:'minimal',hi:'fully engaged'},
  {q:'How well does your group support each other through hard times?',lo:'not much',hi:'always there'},
  {q:'How likely are you to invite a friend to join this group?',lo:'not likely',hi:'definitely'}
];
var asmAnswers = {};

/* ============================================================
   BADGES / MILESTONES
   ============================================================ */
var BADGES = [
  {em:'üå±',n:'first meeting',d:'met for the first time',e:true},
  {em:'üîü',n:'10 meetings',d:'10 group meetings completed',e:true},
  {em:'üíØ',n:'100 meetings',d:'100 group meetings together',e:false},
  {em:'üôè',n:'prayer warrior',d:'50+ prayers submitted',e:true},
  {em:'‚ú®',n:'answered prayer',d:'first answered prayer logged',e:true},
  {em:'üìñ',n:'bookworm',d:'completed first full book study',e:true},
  {em:'üóìÔ∏è',n:'1 year strong',d:'celebrating 1 year together',e:true},
  {em:'üéâ',n:'3 years!',d:'three incredible years together',e:true},
  {em:'‚ù§Ô∏è',n:'deep roots',d:'5+ years of doing life together',e:false},
  {em:'üèÜ',n:'health champion',d:'scored 90+ on group health',e:false},
  {em:'üåç',n:'six books',d:'studied 6 books of the Bible',e:true},
  {em:'üåü',n:'dozen answered',d:'12 answered prayers logged',e:true}
];

/* ============================================================
   BIBLE BOOKS (all 66)
   ============================================================ */
var BIBLE_BOOKS = [
  {t:'OT',title:'Genesis',desc:'The beginning of all things - creation, the fall, and God\'s covenant with his people.',tags:['creation','covenant','beginnings']},
  {t:'OT',title:'Exodus',desc:'God delivers his people from slavery and establishes his covenant at Sinai.',tags:['freedom','covenant','moses']},
  {t:'OT',title:'Leviticus',desc:'Laws and rituals that set Israel apart as a holy people before God.',tags:['holiness','worship','law']},
  {t:'OT',title:'Numbers',desc:'Israel\'s wilderness journey and the cost of faithlessness.',tags:['wilderness','faithfulness','journey']},
  {t:'OT',title:'Deuteronomy',desc:'Moses\' final words - a call to love God wholeheartedly and obey his commands.',tags:['obedience','love','renewal']},
  {t:'OT',title:'Joshua',desc:'God\'s faithfulness as Israel enters and conquers the promised land.',tags:['courage','faithfulness','promise']},
  {t:'OT',title:'Judges',desc:'A cycle of sin, suffering, and salvation in the days before Israel\'s kings.',tags:['sin','redemption','leadership']},
  {t:'OT',title:'Ruth',desc:'A beautiful story of loyalty, love, and redemption.',tags:['loyalty','redemption','love']},
  {t:'OT',title:'1 Samuel',desc:'The rise of Israel\'s monarchy and the calling of King David.',tags:['leadership','calling','trust']},
  {t:'OT',title:'2 Samuel',desc:'David\'s reign - his triumphs, failures, and God\'s enduring grace.',tags:['grace','failure','kingship']},
  {t:'OT',title:'1 Kings',desc:'Solomon\'s wisdom and the divided kingdom.',tags:['wisdom','obedience','leadership']},
  {t:'OT',title:'2 Kings',desc:'The fall of Israel and Judah - a warning about unfaithfulness.',tags:['faithfulness','consequences','history']},
  {t:'OT',title:'1 Chronicles',desc:'A retelling of Israel\'s history with a focus on worship and the temple.',tags:['worship','history','temple']},
  {t:'OT',title:'2 Chronicles',desc:'From Solomon\'s glory to the exile - the importance of following God.',tags:['revival','worship','consequences']},
  {t:'OT',title:'Ezra',desc:'The return from exile and rebuilding of the temple.',tags:['restoration','worship','community']},
  {t:'OT',title:'Nehemiah',desc:'Rebuilding Jerusalem\'s walls and renewing the covenant community.',tags:['leadership','restoration','prayer']},
  {t:'OT',title:'Esther',desc:'God\'s providential protection of his people through courage and faith.',tags:['courage','providence','identity']},
  {t:'OT',title:'Job',desc:'Wrestling with suffering and encountering God\'s sovereignty.',tags:['suffering','sovereignty','faith']},
  {t:'OT',title:'Psalms',desc:'150 songs of praise, lament, and trust - the prayer book of the Bible.',tags:['worship','prayer','emotion']},
  {t:'OT',title:'Proverbs',desc:'Practical wisdom for everyday life rooted in the fear of the Lord.',tags:['wisdom','practical','character']},
  {t:'OT',title:'Ecclesiastes',desc:'Searching for meaning and finding that life\'s purpose is rooted in God.',tags:['meaning','purpose','wisdom']},
  {t:'OT',title:'Song of Solomon',desc:'A celebration of love, intimacy, and the beauty of relationship.',tags:['love','marriage','relationship']},
  {t:'OT',title:'Isaiah',desc:'Prophecies of judgment and hope - pointing toward the coming Messiah.',tags:['prophecy','hope','messiah']},
  {t:'OT',title:'Jeremiah',desc:'A prophet\'s heartbreak over Israel\'s unfaithfulness and God\'s coming restoration.',tags:['faithfulness','hope','lament']},
  {t:'OT',title:'Lamentations',desc:'Raw grief over Jerusalem\'s destruction and a prayer for God\'s mercy.',tags:['grief','mercy','lament']},
  {t:'OT',title:'Ezekiel',desc:'Visions of God\'s glory and the promise of a renewed Israel.',tags:['prophecy','restoration','glory']},
  {t:'OT',title:'Daniel',desc:'Faithfulness under pressure and God\'s sovereignty over all kingdoms.',tags:['faithfulness','sovereignty','prophecy']},
  {t:'OT',title:'Hosea',desc:'God\'s unfailing love for an unfaithful people - a picture of grace.',tags:['grace','love','restoration']},
  {t:'OT',title:'Joel',desc:'A call to repentance and the promise of God\'s Spirit poured out.',tags:['repentance','spirit','restoration']},
  {t:'OT',title:'Amos',desc:'Justice for the poor and a warning to those who exploit the vulnerable.',tags:['justice','humility','warning']},
  {t:'OT',title:'Obadiah',desc:'A short prophecy against pride and a reminder that God defends his people.',tags:['pride','justice','deliverance']},
  {t:'OT',title:'Jonah',desc:'Running from God and discovering his relentless grace and mercy.',tags:['grace','mercy','missions']},
  {t:'OT',title:'Micah',desc:'Act justly, love mercy, walk humbly - the heart of what God requires.',tags:['justice','humility','mercy']},
  {t:'OT',title:'Nahum',desc:'God\'s judgment on Nineveh and comfort for those who trust in him.',tags:['justice','comfort','sovereignty']},
  {t:'OT',title:'Habakkuk',desc:'Honest questions and deep trust - learning to live by faith.',tags:['faith','trust','questions']},
  {t:'OT',title:'Zephaniah',desc:'Warning of judgment and the joy of God singing over his people.',tags:['joy','judgment','restoration']},
  {t:'OT',title:'Haggai',desc:'A call to prioritize God\'s house and trust his provision.',tags:['priorities','faithfulness','worship']},
  {t:'OT',title:'Zechariah',desc:'Visions of hope and the coming King who will reign in peace.',tags:['hope','messiah','prophecy']},
  {t:'OT',title:'Malachi',desc:'The final Old Testament call to return to God before the coming of Elijah.',tags:['return','faithfulness','giving']},
  {t:'NT',title:'Matthew',desc:'Jesus as the fulfillment of Old Testament prophecy - the King has come.',tags:['jesus','kingdom','fulfillment']},
  {t:'NT',title:'Mark',desc:'The action-packed gospel of Jesus - servant, healer, and Son of God.',tags:['jesus','action','servant']},
  {t:'NT',title:'Luke',desc:'A careful account of Jesus - his compassion for the poor and the outsider.',tags:['jesus','compassion','grace']},
  {t:'NT',title:'John',desc:'Jesus as the Word of God - believe and have life in his name.',tags:['jesus','belief','eternal life']},
  {t:'NT',title:'Acts',desc:'The Holy Spirit-empowered birth and spread of the early church.',tags:['spirit','church','missions']},
  {t:'NT',title:'Romans',desc:'The deep roots of the gospel - grace, faith, and life in the Spirit.',tags:['gospel','grace','theology']},
  {t:'NT',title:'1 Corinthians',desc:'Addressing division, gifts, and love in a messy but beloved church.',tags:['love','gifts','unity']},
  {t:'NT',title:'2 Corinthians',desc:'Paul\'s vulnerability and the strength that comes through weakness.',tags:['vulnerability','strength','ministry']},
  {t:'NT',title:'Galatians',desc:'Freedom from the law through grace - you are fully loved in Christ.',tags:['grace','freedom','identity']},
  {t:'NT',title:'Ephesians',desc:'The riches of life in Christ and how they shape every relationship.',tags:['identity','unity','relationships']},
  {t:'NT',title:'Philippians',desc:'Joy in every circumstance - contentment, peace, and pressing onward.',tags:['joy','contentment','peace']},
  {t:'NT',title:'Colossians',desc:'Christ is supreme over all things - let him fill every part of your life.',tags:['christ','supremacy','fullness']},
  {t:'NT',title:'1 Thessalonians',desc:'Encouragement to live faithfully while waiting for Christ\'s return.',tags:['hope','return','encouragement']},
  {t:'NT',title:'2 Thessalonians',desc:'Standing firm in the faith while awaiting the Day of the Lord.',tags:['perseverance','hope','end times']},
  {t:'NT',title:'1 Timothy',desc:'Practical guidance for leading and organizing a healthy church.',tags:['leadership','church','practical']},
  {t:'NT',title:'2 Timothy',desc:'Paul\'s final charge - preach the word and finish the race strong.',tags:['perseverance','preaching','legacy']},
  {t:'NT',title:'Titus',desc:'Sound teaching and godly living in every area of life.',tags:['character','leadership','practical']},
  {t:'NT',title:'Philemon',desc:'A short letter about forgiveness, reconciliation, and Christian brotherhood.',tags:['forgiveness','reconciliation','grace']},
  {t:'NT',title:'Hebrews',desc:'Jesus is greater - better covenant, better priest, better hope.',tags:['jesus','faith','perseverance']},
  {t:'NT',title:'James',desc:'Faith that works - practical Christianity lived out in everyday life.',tags:['faith','works','practical']},
  {t:'NT',title:'1 Peter',desc:'Hope and endurance for those suffering for their faith.',tags:['suffering','hope','identity']},
  {t:'NT',title:'2 Peter',desc:'Guarding against false teaching and growing in grace and knowledge.',tags:['discernment','growth','warning']},
  {t:'NT',title:'1 John',desc:'Love one another - walking in the light and assurance of salvation.',tags:['love','assurance','fellowship']},
  {t:'NT',title:'2 John',desc:'A brief charge to walk in love and truth and guard against deception.',tags:['truth','love','discernment']},
  {t:'NT',title:'3 John',desc:'Encouragement for faithful workers and a warning against pride.',tags:['hospitality','faithfulness','character']},
  {t:'NT',title:'Jude',desc:'Contend for the faith and resist those who distort God\'s grace.',tags:['discernment','perseverance','warning']},
  {t:'NT',title:'Revelation',desc:'The ultimate victory of Christ and the hope of a renewed creation.',tags:['hope','victory','end times']}
];

/* ============================================================
   NAVIGATION CONFIG
   ============================================================ */
var NAV_CONFIG = {
  ministry: [
    {section:'my ministry'},
    {id:'home',     ic:'üè†', lb:'dashboard'},
    {id:'groups',   ic:'üë•', lb:'all groups'},
    {id:'health',   ic:'üíö', lb:'group health'},
    {id:'min-res',  ic:'üìö', lb:'resources'},
    {id:'stats',    ic:'üìä', lb:'ministry stats'},
    {divider:'my group'},
    {id:'grp-home', ic:'üè†', lb:'group home'},
    {id:'meeting',  ic:'üìÖ', lb:'next meeting'},
    {id:'attend',   ic:'‚úÖ', lb:'attendance'},
    {id:'prayers',  ic:'üôè', lb:'prayer wall'},
    {id:'ice',      ic:'üí¨', lb:'icebreaker'},
    {id:'sched',    ic:'üóìÔ∏è', lb:'scheduling'},
    {id:'rotation', ic:'üè°', lb:'location rotation'},
    {id:'assess',   ic:'üíö', lb:'group health'},
    {id:'miles',    ic:'üèÜ', lb:'milestones'},
    {id:'resources',ic:'üìö', lb:'study resources'},
    {id:'members',  ic:'üë§', lb:'manage members'}
  ],
  leader: [
    {id:'home',     ic:'üè†', lb:'home'},
    {id:'meeting',  ic:'üìÖ', lb:'next meeting'},
    {id:'attend',   ic:'‚úÖ', lb:'attendance'},
    {id:'prayers',  ic:'üôè', lb:'prayer wall'},
    {id:'ice',      ic:'üí¨', lb:'icebreaker'},
    {id:'sched',    ic:'üóìÔ∏è', lb:'scheduling'},
    {id:'rotation', ic:'üè°', lb:'location rotation'},
    {id:'assess',   ic:'üíö', lb:'group health'},
    {id:'miles',    ic:'üèÜ', lb:'milestones'},
    {id:'resources',ic:'üìö', lb:'study resources'},
    {id:'members',  ic:'üë§', lb:'manage members'}
  ],
  member: [
    {id:'home',     ic:'üè†', lb:'home'},
    {id:'meeting',  ic:'üìÖ', lb:'next meeting'},
    {id:'prayers',  ic:'üôè', lb:'prayer wall'},
    {id:'ice',      ic:'üí¨', lb:'icebreaker'},
    {id:'sched',    ic:'üóìÔ∏è', lb:'scheduling poll'},
    {id:'assess',   ic:'üíö', lb:'group health'},
    {id:'miles',    ic:'üèÜ', lb:'milestones'},
    {id:'resources',ic:'üìö', lb:'study resources'}
  ]
};

var PAGE_TITLES = {
  home:'home', 'grp-home':'group home', groups:'all groups',
  health:'group health overview', 'min-res':'ministry resources',
  stats:'ministry stats', meeting:'next meeting', attend:'attendance',
  prayers:'prayer wall', ice:'icebreaker & connection', sched:'scheduling poll',
  rotation:'location rotation', assess:'group health check-in',
  miles:'milestones & badges', resources:'study resources', members:'manage members'
};

/* ============================================================
   HELPERS
   ============================================================ */
function initials(name){
  var p=name.trim().split(' ');
  return (p[0][0]+(p[1]?p[1][0]:'')).toUpperCase();
}

function genCode(prefix){
  var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',s='';
  for(var i=0;i<4;i++) s+=c[Math.floor(Math.random()*c.length)];
  return prefix+'-'+s;
}

function yrs(start){
  return Math.floor((Date.now()-new Date(start))/(365.25*24*3600*1000));
}

function timeOptions(){
  var s='';
  for(var h=0;h<24;h++){
    for(var m=0;m<60;m+=30){
      var h12=h%12||12, ap=h<12?'AM':'PM', ms=m?'30':'00';
      s+='<option>'+h12+':'+ms+' '+ap+'</option>';
    }
  }
  return s;
}

function isLeader(){
  return CU && (CU.type==='leader'||CU.type==='ministry');
}

/* ============================================================
   TOAST
   ============================================================ */
var toastTimer;
function toast(msg){
  var t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){t.classList.remove('show')},2800);
}

/* ============================================================
   MODAL
   ============================================================ */
function openModal(html){
  var box=document.getElementById('modal-box');
  box.innerHTML=html;
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal(){
  document.getElementById('modal-overlay').classList.remove('open');
}
function modalClickOutside(e){
  if(e.target===document.getElementById('modal-overlay')) closeModal();
}

/* ============================================================
   SIGN IN / OUT
   ============================================================ */
function showView(id){
  ['v-signin','v-ca1','v-ca2','v-ca3','v-confirm'].forEach(function(v){
    document.getElementById(v).style.display = v===id?'block':'none';
  });
}

async function doSignIn(){
  var email=document.getElementById('si-email').value.trim();
  var pw=document.getElementById('si-pw').value;
  if(!email||!pw){toast('please enter your email and password üòä');return;}
  var btn=document.getElementById('si-btn');
  btn.textContent='signing in...'; btn.disabled=true;
  try {
    var r=await sb.auth.signInWithPassword({email:email,password:pw});
    if(r.error){
      var msg=r.error.message||'unknown error';
      if(msg.includes('Invalid login')) msg='incorrect email or password';
      if(msg.includes('Email not confirmed')) msg='please check your email to confirm your account first üì¨';
      toast('sign in failed: '+msg+' üòï');
      btn.textContent='sign in'; btn.disabled=false;
      return;
    }
    await loadProfile(r.data.user);
  } catch(e){
    toast('error: '+e.message);
    btn.textContent='sign in'; btn.disabled=false;
  }
}

async function loadProfile(user){
  DEMO=false;
  var {data:p}=await sb.from('profiles').select('*').eq('id',user.id).single();
  if(!p){
    // Profile doesn't exist yet - create it
    var meta=user.user_metadata||{};
    await sb.from('profiles').insert({id:user.id,full_name:meta.full_name||user.email,role:meta.role||'member'});
    var r2=await sb.from('profiles').select('*').eq('id',user.id).single();
    p=r2.data;
  }
  if(!p){toast('error loading your profile - please try again üòï');return;}
  var typeMap={ministry:'ministry leader',leader:'group leader',member:'group member'};
  CU={
    id:user.id, email:user.email,
    name:p.full_name||user.email,
    init:initials(p.full_name||user.email),
    type:p.role||'member',
    role:typeMap[p.role]||'group member',
    groupId:p.group_id||null,
    ministryId:p.ministry_id||(p.role==='ministry'?user.id:null),
    churchName:p.church_name||'',
    groupResources:[], placeholderMembers:[]
  };
  GD={name:'',start:'',next:{day:'',time:'',loc:'',freq:'weekly'},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  enterApp();
}

async function doLogout(){
  await sb.auth.signOut();
  CU=null; GD=null; DEMO=false;
  document.getElementById('s-app').classList.remove('active');
  document.getElementById('s-login').classList.add('active');
  showView('v-signin');
}

/* ============================================================
   DEMO LOGIN
   ============================================================ */
function loginDemo(type){
  DEMO=true;
  var typeMap={ministry:'ministry leader',leader:'group leader',member:'group member'};
  CU={
    id:null,name:type==='ministry'?'Eric Peyton':type==='leader'?'Marcus Thompson':'Amy Chen',
    type:type, role:typeMap[type],
    groupId:'demo', ministryId:'demo',
    churchName:'Hope Community Church',
    groupCode:'GRP-THUR', minCode:'MIN-HOPE',
    groupResources:[], placeholderMembers:[{n:'Chris Wallace',r:'study coordinator',real:false}]
  };
  CU.init=initials(CU.name);
  GD=JSON.parse(JSON.stringify(DEMO_GD));
  PRAYERS=JSON.parse(JSON.stringify(DEMO_PRAYERS));
  votedSlots=new Set([2]);
  enterApp();
}

/* ============================================================
   APP ENTRY
   ============================================================ */
function enterApp(){
  document.getElementById('s-login').classList.remove('active');
  document.getElementById('s-app').classList.add('active');
  document.getElementById('sb-name').textContent=CU.name;
  document.getElementById('sb-role').textContent=CU.role;
  document.getElementById('sb-av').textContent=CU.init;
  document.getElementById('sb-role-lbl').textContent=CU.role;
  buildNav();
  goPage('home');
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function buildNav(){
  var items=NAV_CONFIG[CU.type]||NAV_CONFIG.member;
  var html='';
  items.forEach(function(item){
    if(item.section){
      html+='<div class="nav-sec">'+item.section+'</div>';
    } else if(item.divider){
      html+='<div class="nav-divider"></div><div class="nav-sec">'+item.divider+'</div>';
    } else {
      html+='<div class="ni" id="ni-'+item.id+'" onclick="goPage(\''+item.id+'\')">'
        +'<span class="ni-ic">'+item.ic+'</span><span>'+item.lb+'</span></div>';
    }
  });
  document.getElementById('sb-nav').innerHTML=html;
}

function goPage(id){
  document.querySelectorAll('.ni').forEach(function(el){el.classList.remove('active')});
  var nel=document.getElementById('ni-'+id);
  if(nel) nel.classList.add('active');
  document.getElementById('page-title').textContent=PAGE_TITLES[id]||id;
  document.getElementById('topbar-actions').innerHTML='';
  document.getElementById('page-content').innerHTML='';
  // Route
  var pages={
    home:     function(){CU.type==='ministry'?pgMinHome():pgGrpHome()},
    'grp-home':pgGrpHome,
    groups:   pgGroups,
    health:   pgMinHealth,
    'min-res':pgMinRes,
    stats:    pgStats,
    meeting:  pgMeeting,
    attend:   pgAttend,
    prayers:  pgPrayers,
    ice:      pgIce,
    sched:    pgSched,
    rotation: pgRotation,
    assess:   pgAssess,
    miles:    pgMiles,
    resources:pgResources,
    members:  pgMembers
  };
  if(pages[id]) pages[id]();
}

/* ============================================================
   HELPERS: PAGE CONTENT
   ============================================================ */
function pc(html){document.getElementById('page-content').innerHTML=html;}
function topAction(html){document.getElementById('topbar-actions').innerHTML=html;}
function empty(em,title,body,action){
  return '<div class="empty"><div class="empty-em">'+em+'</div>'
    +'<div class="empty-title">'+title+'</div>'
    +'<div class="empty-body">'+body+'</div>'
    +(action||'')+'</div>';
}

/* ============================================================
   PAGE: MINISTRY HOME
   ============================================================ */
function pgMinHome(){
  if(!DEMO){
    var code=CU.minCode||(CU.minCode=genCode('MIN'));
    pc('<div class="card" style="text-align:center;padding:40px 24px">'
      +'<div style="font-size:48px;margin-bottom:16px">‚õ™</div>'
      +'<div style="font-family:\'DM Serif Display\',serif;font-size:24px;color:var(--dark);margin-bottom:10px">welcome to groupify!</div>'
      +'<div style="font-size:14px;color:var(--muted);margin-bottom:24px;line-height:1.7;max-width:400px;margin-left:auto;margin-right:auto">your ministry dashboard will come to life as group leaders join and create their groups.</div>'
      +'<div class="invite-card" style="max-width:320px;margin:0 auto 16px">'
      +'<div class="invite-label">ministry invite code</div>'
      +'<div class="invite-code">'+code+'</div>'
      +'<div class="invite-note">share this with group leaders when they sign up</div>'
      +'<button class="btn btn-p btn-sm" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'code copied! üìã\')">copy code</button>'
      +'</div>'
      +'<button class="btn btn-s" onclick="goPage(\'min-res\')">üìö add study resources</button>'
      +'</div>');
    return;
  }
  pc('<div class="g4" style="margin-bottom:18px">'
    +statCard('‚õ™','5','active groups')
    +statCard('üë•','41','total members')
    +statCard('üôè','89','prayers this month')
    +statCard('‚ú®','23','answered prayers')
    +'</div>'
    +'<div class="g2">'
    +'<div><div class="card"><div class="card-header"><span class="card-title">group health overview</span>'
    +'<button class="btn btn-g btn-sm" onclick="goPage(\'health\')">see all ‚Üí</button></div>'
    +DEMO_GROUPS.map(function(g){return healthBar(g.n,g.h)}).join('')
    +'</div></div>'
    +'<div>'
    +'<div class="card"><div class="card-header"><span class="card-title">needs attention</span></div>'
    +DEMO_GROUPS.filter(function(g){return g.h<75}).map(function(g){
      return '<div style="padding:11px 0;border-bottom:1px solid var(--border)">'
        +'<div class="bold" style="font-size:14px">'+g.n+'</div>'
        +'<div style="font-size:13px;color:var(--muted);margin-top:2px">health: '+g.h+'% ¬∑ last met '+g.lm+'</div>'
        +'</div>';
    }).join('')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">quick actions</span></div>'
    +'<div style="display:grid;gap:9px">'
    +'<button class="btn btn-s" onclick="goPage(\'health\')">üíö view health assessments</button>'
    +'<button class="btn btn-g" onclick="goPage(\'min-res\')">üìö manage resources</button>'
    +'</div></div>'
    +'</div></div>');
}

function statCard(em,val,lbl){
  return '<div class="stat-card"><div class="stat-em">'+em+'</div>'
    +'<div class="stat-val">'+val+'</div><div class="stat-lbl">'+lbl+'</div></div>';
}

function healthBar(name,pct){
  var cls=pct<65?' low':pct<80?' med':'';
  return '<div class="health-row"><div class="health-row-header"><span style="font-size:14px">'+name+'</span><span style="font-size:13px;font-weight:600;color:var(--dark)">'+pct+'%</span></div>'
    +'<div class="health-bar-bg"><div class="health-bar-fill'+cls+'" style="width:'+pct+'%"></div></div></div>';
}

/* ============================================================
   PAGE: GROUP HOME
   ============================================================ */
function pgGrpHome(){
  if(!DEMO&&!CU.groupId){
    pc(empty('üë•','start your small group',
      'create your group to get started - add members, set your meeting schedule, track prayers, and more.',
      isLeader()?'<button class="btn btn-p" onclick="modalCreateGroup()">+ create my group</button>':
      '<div class="banner banner-green">your leader will share a group invite code - ask them for it to join their group on groupify.</div>'
    ));
    return;
  }
  var g=GD;
  var memberPrayers=DEMO?PRAYERS.slice(0,2):[];
  var stats=DEMO?g.stats:{meetings:0,answered:0,books:0};
  pc('<div class="mhero">'
    +'<div class="mhero-label">üìÖ '+g.name+'</div>'
    +'<div class="mhero-title">'+(g.next.day?g.next.day+' nights':'no meeting scheduled yet')+'</div>'
    +'<div class="mhero-details">'
    +(g.next.time?'<span class="mhero-detail">‚è∞ '+g.next.time+'</span>':'')
    +(g.next.loc?'<span class="mhero-detail">üìç '+g.next.loc+'</span>':'')
    +(g.next.freq?'<span class="mhero-detail">üîÅ '+g.next.freq+'</span>':'')
    +'</div>'
    +(isLeader()?'<div class="mhero-actions"><button class="btn btn-a" style="margin-top:16px" onclick="modalEditMeeting()">edit meeting details</button></div>':'')
    +'</div>'
    +'<div class="g2">'
    +'<div>'
    +'<div class="iq-card">'
    +'<div class="iq-label">üí¨ this meeting\'s icebreaker</div>'
    +'<div class="iq-text">"'+IQ[Math.floor(Math.random()*IQ.length)]+'"</div>'
    +'<button class="btn btn-s btn-sm" onclick="goPage(\'ice\')">see all questions ‚Üí</button>'
    +'</div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">üìñ current study</span>'
    +(isLeader()?'<button class="btn btn-g btn-sm" onclick="modalEditMeeting()">edit</button>':'')+'</div>'
    +(g.study
      ?'<div style="font-size:15px;font-weight:600;color:var(--dark);margin-bottom:6px">'+g.study+'</div>'
        +(g.hw?'<div style="font-size:13px;color:var(--mid);line-height:1.6"><strong>homework:</strong> '+g.hw+'</div>':'')
      :'<div style="font-size:14px;color:var(--muted);padding:4px 0">no study selected yet.'+(isLeader()?' <a onclick="goPage(\'resources\')">pick one ‚Üí</a>':'')+'</div>')
    +'</div>'
    +'</div>'
    +'<div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">üôè recent prayers</span>'
    +'<button class="btn btn-g btn-sm" onclick="goPage(\'prayers\')">see all ‚Üí</button></div>'
    +(memberPrayers.length===0
      ?'<div style="font-size:14px;color:var(--muted);padding:8px 0;text-align:center">no prayers yet - be the first üôè</div>'
      :memberPrayers.map(prayerItemHtml).join(''))
    +'</div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">üèÜ group stats</span>'
    +'<button class="btn btn-g btn-sm" onclick="goPage(\'miles\')">see all ‚Üí</button></div>'
    +'<div class="g3">'
    +'<div style="text-align:center;padding:12px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+stats.meetings+'</div><div style="font-size:12px;color:var(--muted)">meetings</div></div>'
    +'<div style="text-align:center;padding:12px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+yrs(g.start||new Date())+'</div><div style="font-size:12px;color:var(--muted)">years</div></div>'
    +'<div style="text-align:center;padding:12px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+stats.answered+'</div><div style="font-size:12px;color:var(--muted)">answered ‚ú®</div></div>'
    +'</div>'
    +'</div>'
    +'</div>'
    +'</div>');
}

/* ============================================================
   PAGE: MINISTRY - ALL GROUPS
   ============================================================ */
function pgGroups(){
  if(!DEMO){
    var code=CU.minCode||(CU.minCode=genCode('MIN'));
    pc('<div class="invite-card">'
      +'<div class="invite-label">ministry invite code</div>'
      +'<div class="invite-code">'+code+'</div>'
      +'<div class="invite-note">share with group leaders so they connect to your ministry when signing up</div>'
      +'<button class="btn btn-p btn-sm" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'copied! üìã\')">copy code</button>'
      +'</div>'
      +empty('üë•','no groups yet','groups will appear here as group leaders sign up and create their groups.',''));
    return;
  }
  pc('<div class="g4" style="margin-bottom:20px">'
    +statCard('üë•','5','active groups')
    +statCard('üôã','41','total members')
    +statCard('üìÖ','23','meetings this month')
    +statCard('üíö','75%','avg health score')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">all groups</span></div>'
    +DEMO_GROUPS.map(function(g){
      return '<div style="padding:14px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px">'
        +'<div style="flex:1"><div class="bold" style="font-size:14px">'+g.n+'</div>'
        +'<div style="font-size:12px;color:var(--muted);margin-top:2px">'+g.members+' members ¬∑ last met '+g.lm+'</div></div>'
        +'<div style="min-width:80px">'+healthBar('',g.h)+'</div>'
        +'<span class="badge '+(g.h>=80?'badge-green':g.h>=65?'badge-blue':'')+'">'+g.h+'%</span>'
        +'</div>';
    }).join('')
    +'</div>');
}

/* ============================================================
   PAGE: MINISTRY - GROUP HEALTH OVERVIEW
   ============================================================ */
function pgMinHealth(){
  if(!DEMO){
    pc(empty('üíö','no health data yet','health assessments will appear here once group members complete their first check-in.',''));
    return;
  }
  pc('<div class="g4" style="margin-bottom:20px">'
    +statCard('üíö','75%','avg health score')
    +statCard('‚úÖ','4/5','groups assessed')
    +statCard('üìà','+8%','vs last month')
    +statCard('‚ö†Ô∏è','2','need attention')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">health by group</span></div>'
    +DEMO_GROUPS.map(function(g){return healthBar(g.n,g.h)}).join('')
    +'</div>');
}

/* ============================================================
   PAGE: MINISTRY - RESOURCES
   ============================================================ */
function pgMinRes(){
  topAction('<button class="btn btn-p btn-sm" onclick="modalAddRes(\'ministry\')">+ add resource</button>');
  var res=DEMO?DEMO_RESOURCES:[];
  pc((res.length===0
    ?empty('üìö','no resources yet','add video series, books, Bible studies, or other resources for your groups.','<button class="btn btn-p" onclick="modalAddRes(\'ministry\')">+ add first resource</button>')
    :'<div class="card"><div class="card-header"><span class="card-title">ministry resources</span></div>'
      +res.map(function(r){return resCardHtml(r,false)}).join('')
      +'</div>'));
}

function resCardHtml(r, showStudyBtn){
  return '<div class="res-card">'
    +'<div class="res-type">'+r.type+'</div>'
    +'<div class="res-title">'+r.title+'</div>'
    +'<div class="res-desc">'+r.desc+'</div>'
    +'<div class="res-tags">'+r.tags.map(function(t){return '<span class="chip">'+t+'</span>'}).join('')+'</div>'
    +(showStudyBtn?'<div class="res-actions"><button class="btn btn-p btn-sm" onclick="setStudy(\''+r.title+'\')">üìñ set as current study</button></div>':'')
    +'</div>';
}

/* ============================================================
   PAGE: MINISTRY - STATS
   ============================================================ */
function pgStats(){
  if(!DEMO){pc(empty('üìä','no stats yet','stats will build up as your groups meet and members engage.',''));return;}
  pc('<div class="g4" style="margin-bottom:18px">'
    +statCard('üìÖ','23','meetings this month')
    +statCard('üôè','89','prayer requests')
    +statCard('‚ú®','23','answered prayers')
    +statCard('üìñ','12','books studied')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">monthly activity</span></div>'
    +'<div style="font-size:14px;color:var(--muted);padding:20px 0;text-align:center">activity charts coming soon üìä</div>'
    +'</div>');
}

/* ============================================================
   PAGE: NEXT MEETING
   ============================================================ */
function pgMeeting(){
  if(!DEMO&&!CU.groupId){
    pc(empty('üìÖ','no meeting set',
      isLeader()?'create your group first, then set your meeting details here.':'your group leader hasn\'t set a meeting time yet.',
      isLeader()?'<button class="btn btn-p" onclick="modalCreateGroup()">+ create my group</button>':''
    ));
    return;
  }
  if(isLeader()) topAction('<button class="btn btn-p btn-sm" onclick="modalEditMeeting()">edit details</button>');
  var g=GD;
  pc('<div class="mhero">'
    +'<div class="mhero-label">üìÖ next meeting</div>'
    +'<div class="mhero-title">'+(g.next.day||'day not set')+'</div>'
    +'<div class="mhero-details">'
    +(g.next.time?'<span class="mhero-detail">‚è∞ '+g.next.time+'</span>':'')
    +(g.next.loc?'<span class="mhero-detail">üìç '+g.next.loc+'</span>':'')
    +(g.next.freq?'<span class="mhero-detail">üîÅ '+g.next.freq+'</span>':'')
    +'</div></div>'
    +'<div class="card"><div class="card-header"><span class="card-title">üìñ study & homework</span>'
    +(isLeader()?'<button class="btn btn-g btn-sm" onclick="modalEditMeeting()">edit</button>':'')+'</div>'
    +(g.study
      ?'<div style="font-size:15px;font-weight:600;color:var(--dark);margin-bottom:8px">'+g.study+'</div>'
        +(g.hw?'<div style="font-size:14px;color:var(--mid);line-height:1.7"><strong>homework:</strong> '+g.hw+'</div>':'')
      :'<div style="font-size:14px;color:var(--muted)">no study selected yet.'+(isLeader()?' <a onclick="goPage(\'resources\')">pick one from study resources ‚Üí</a>':'')+'</div>')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">üí¨ icebreaker for this meeting</span></div>'
    +'<div class="iq-text" style="font-size:18px;margin-bottom:12px">"'+IQ[0]+'"</div>'
    +'<button class="btn btn-s btn-sm" onclick="goPage(\'ice\')">see all icebreakers ‚Üí</button>'
    +'</div>');
}

/* ============================================================
   PAGE: ATTENDANCE
   ============================================================ */
function pgAttend(){
  if(!DEMO&&!CU.groupId){pc(empty('‚úÖ','no group yet','attendance tracking will be available once your group is set up.',''));return;}
  var members=DEMO?DEMO_MEMBERS:[];
  if(!isLeader()){pc(empty('‚úÖ','attendance','only group leaders can take attendance.',''));return;}
  if(members.length===0){pc(empty('‚úÖ','no members yet','add members to your group to start tracking attendance.','<button class="btn btn-p" onclick="goPage(\'members\')">manage members ‚Üí</button>'));return;}
  topAction('<button class="btn btn-p btn-sm" onclick="saveAttendance()">save attendance</button>');
  pc('<div class="card">'
    +'<div class="card-header"><span class="card-title">mark attendance</span><span class="card-note">'+new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'</span></div>'
    +members.map(function(m,i){
      return '<div class="att-row">'
        +'<div class="m-av'+(m.real?'':' placeholder')+'">'+(m.real?m.i:'?')+'</div>'
        +'<div><div class="m-name">'+m.n+'</div><div class="m-role">'+m.r+'</div></div>'
        +'<div class="att-btns">'
        +'<button class="att-btn" id="att-p-'+i+'" onclick="markAtt('+i+',\'p\')">‚úì present</button>'
        +'<button class="att-btn" id="att-a-'+i+'" onclick="markAtt('+i+',\'a\')">‚úó absent</button>'
        +'</div></div>';
    }).join('')
    +'</div>');
}
function markAtt(i,status){
  ['p','a'].forEach(function(s){
    var btn=document.getElementById('att-'+s+'-'+i);
    if(btn) btn.className='att-btn'+(s===status?' '+(s==='p'?'present':'absent'):'');
  });
}
function saveAttendance(){closeModal();toast('attendance saved ‚úÖ');}

/* ============================================================
   PAGE: PRAYER WALL
   ============================================================ */
function pgPrayers(){
  topAction('<button class="btn btn-p btn-sm" onclick="modalAddPrayer()">+ add prayer</button>');
  if(!DEMO&&!CU.groupId){
    pc(empty('üôè','prayer wall','once your group is set up, members can share prayer requests here.',
      '<button class="btn btn-p btn-sm" onclick="modalAddPrayer()">+ add first prayer</button>'));
    return;
  }
  var list=DEMO?PRAYERS:[];
  if(list.length===0){
    pc(empty('üôè','no prayers yet','be the first to share something with your group!',
      '<button class="btn btn-p btn-sm" onclick="modalAddPrayer()">+ add prayer request</button>'));
    return;
  }
  var active=list.filter(function(p){return !p.ans});
  var answered=list.filter(function(p){return p.ans});
  pc('<div class="g2" style="margin-bottom:16px">'
    +'<div class="stat-card"><div class="stat-em">üôè</div><div class="stat-val">'+list.length+'</div><div class="stat-lbl">prayer requests</div></div>'
    +'<div class="stat-card"><div class="stat-em">‚ú®</div><div class="stat-val">'+answered.length+'</div><div class="stat-lbl">answered prayers</div></div>'
    +'</div>'
    +'<div class="tabs" id="prayer-tabs">'
    +'<div class="tab active" onclick="filterPrayers(\'all\',this)">all ('+list.length+')</div>'
    +'<div class="tab" onclick="filterPrayers(\'active\',this)">active ('+active.length+')</div>'
    +'<div class="tab" onclick="filterPrayers(\'answered\',this)">answered ('+answered.length+')</div>'
    +'</div>'
    +'<div class="card" id="prayer-list">'+prayerListHtml(list)+'</div>');
}
function prayerListHtml(list){
  return list.map(prayerItemHtml).join('');
}
function prayerItemHtml(p){
  return '<div class="prayer-item'+(p.ans?' answered':'')+'">'
    +'<div class="prayer-meta"><span class="prayer-author">'+p.au+'</span><span class="prayer-date">'+p.dt+'</span></div>'
    +'<div class="prayer-text">'+p.txt+'</div>'
    +'<div class="prayer-actions">'
    +'<button class="pray-btn'+(p.prayed?' prayed':'')+'" onclick="togPray('+p.id+',this)">üôè '+(p.prayed?'prayed!':'i prayed')+'</button>'
    +'<span class="pray-count">'+p.cnt+' praying</span>'
    +(p.ans?'<span class="badge badge-green">‚ú® answered!</span>':'')
    +(!p.ans&&isLeader()?'<button class="btn btn-s btn-sm" onclick="modalMarkAnswered('+p.id+')">mark answered</button>':'')
    +'</div></div>';
}
function togPray(id,btn){
  var p=PRAYERS.find(function(x){return x.id===id});
  if(!p) return;
  p.prayed=!p.prayed; p.cnt+=p.prayed?1:-1;
  btn.className='pray-btn'+(p.prayed?' prayed':'');
  btn.textContent='üôè '+(p.prayed?'prayed!':'i prayed');
  btn.nextElementSibling.textContent=p.cnt+' praying';
}
function filterPrayers(f,el){
  document.querySelectorAll('#prayer-tabs .tab').forEach(function(t){t.classList.remove('active')});
  el.classList.add('active');
  var list=f==='all'?PRAYERS:f==='answered'?PRAYERS.filter(function(p){return p.ans}):PRAYERS.filter(function(p){return !p.ans});
  document.getElementById('prayer-list').innerHTML=prayerListHtml(list);
}

/* ============================================================
   PAGE: ICEBREAKER
   ============================================================ */
var iceSkip=0;
function pgIce(){
  var meetingNum=(GD&&GD.stats?GD.stats.meetings:0);
  var qi=(meetingNum+iceSkip)%IQ.length;
  pc('<div class="iq-card" style="margin-bottom:20px">'
    +'<div class="iq-label">üí¨ this meeting\'s question</div>'
    +'<div class="iq-text">"'+IQ[qi]+'"</div>'
    +'<div class="iq-footer">'
    +'<span class="iq-tip">advances after each meeting is logged üåÄ</span>'
    +'<button class="btn btn-g btn-sm" onclick="iceSkip++;pgIce()">skip ‚Üí</button>'
    +'</div></div>'
    +'<div class="card"><div class="card-header"><span class="card-title">how to use this</span></div>'
    +'<div style="font-size:14px;color:var(--mid);line-height:1.8">'
    +'<p>üìå <strong>before your study:</strong> share this question and give everyone 1-2 minutes to think, then go around the group.</p>'
    +'<p style="margin-top:9px">üí° <strong>tip:</strong> the leader goes first to model vulnerability and set the tone.</p>'
    +'<p style="margin-top:9px">‚è±Ô∏è <strong>time:</strong> aim for 10-15 minutes max so you have time for your study.</p>'
    +'</div></div>'
    +'<div class="card"><div class="card-header"><span class="card-title">coming up</span></div>'
    +IQ.slice(qi+1,qi+4).map(function(q,i){
      return '<div style="padding:12px 0;border-bottom:1px solid var(--border);font-size:14px;color:var(--mid)">'
        +'<div style="font-size:11px;font-weight:600;color:var(--muted);margin-bottom:4px">in '+(i+1)+' meeting'+(i>0?'s':'')+'</div>'
        +'"'+q+'"</div>';
    }).join('')
    +'</div>');
}

/* ============================================================
   PAGE: SCHEDULING POLL
   ============================================================ */
function pgSched(){
  if(!DEMO&&!CU.groupId){pc(empty('üóìÔ∏è','no group yet','scheduling polls will be available once your group is set up.',''));return;}
  var slots=DEMO?DEMO_SCHED:[];
  if(isLeader()) topAction('<button class="btn btn-p btn-sm" onclick="modalAddSlot()">+ add time slot</button>');
  pc('<div class="card"><div class="card-header"><span class="card-title">vote for the best time</span><span class="card-note">pick all that work for you</span></div>'
    +(slots.length===0
      ?'<div style="text-align:center;padding:28px;color:var(--muted)">no time slots yet'+(isLeader()?' - add some above':'')+'.</div>'
      :slots.map(function(s){
        var pct=Math.round((s.votes/8)*100);
        var voted=votedSlots.has(s.id);
        return '<div class="poll-slot'+(voted?' voted':'')+'">'
          +'<div class="poll-bar-wrap">'
          +'<div class="poll-bar-label">'+s.day+' ¬∑ '+s.date+' at '+s.time+'</div>'
          +'<div class="poll-bar-bg"><div class="poll-bar-fill" style="width:'+pct+'%"></div></div>'
          +'<div class="poll-count">'+s.votes+' vote'+(s.votes!==1?'s':'')+'</div>'
          +'</div>'
          +'<button class="poll-vote'+(voted?' voted':'')+'" onclick="toggleVote('+s.id+',this)">'+(voted?'‚úì voted':'vote')+'</button>'
          +'</div>';
      }).join(''))
    +'</div>');
}
function toggleVote(id,btn){
  if(votedSlots.has(id)){
    votedSlots.delete(id);
    btn.className='poll-vote'; btn.textContent='vote';
    btn.closest('.poll-slot').classList.remove('voted');
    var slot=DEMO_SCHED.find(function(s){return s.id===id}); if(slot) slot.votes--;
  } else {
    votedSlots.add(id);
    btn.className='poll-vote voted'; btn.textContent='‚úì voted';
    btn.closest('.poll-slot').classList.add('voted');
    var slot=DEMO_SCHED.find(function(s){return s.id===id}); if(slot) slot.votes++;
  }
  toast('vote saved ‚úÖ');
}

/* ============================================================
   PAGE: LOCATION ROTATION
   ============================================================ */
var ROTATION=DEMO?[
  {n:'Marcus & Jenna T.',a:'5 Oak Lane'},{n:'Derek R.',a:'22 Pine St'},
  {n:'Amy C.',a:'101 Maple Ave'},{n:'Chris W.',a:'88 Birch Rd'}
]:[];
function pgRotation(){
  if(!DEMO&&!CU.groupId){pc(empty('üè°','location rotation','add group members\' addresses to rotate meeting locations.',''));return;}
  if(isLeader()) topAction('<button class="btn btn-p btn-sm" onclick="modalAddHost()">+ add host</button>');
  pc('<div class="card">'
    +'<div class="card-header"><span class="card-title">hosting rotation</span></div>'
    +(ROTATION.length===0
      ?'<div style="text-align:center;padding:24px;color:var(--muted)">no hosts added yet'+(isLeader()?' - add some above':'')+'.</div>'
      :ROTATION.map(function(h,i){
        return '<div class="member-row">'
          +'<div class="m-av" style="background:'+(i===0?'var(--accent)':'var(--brand)')+'">'+(i+1)+'</div>'
          +'<div><div class="m-name">'+h.n+'</div><div class="m-role">'+h.a+'</div></div>'
          +(i===0?'<span class="badge badge-green" style="margin-left:auto">next up!</span>':'')
          +'</div>';
      }).join(''))
    +'</div>');
}

/* ============================================================
   PAGE: GROUP HEALTH ASSESSMENT
   ============================================================ */
var asmDone=false;
function pgAssess(){
  if(asmDone){pgHealthResults();return;}
  if(!DEMO&&!CU.groupId){pc(empty('üíö','group health','complete your first assessment to see how your group is doing.',''));return;}
  pc('<div class="card">'
    +'<div style="font-family:\'DM Serif Display\',serif;font-size:22px;color:var(--dark);margin-bottom:6px">group health check-in</div>'
    +'<div style="font-size:14px;color:var(--muted);margin-bottom:24px">rate each area honestly - this helps your leader understand how the group is doing.</div>'
    +AQ.map(function(q,i){
      return '<div style="margin-bottom:22px">'
        +'<div style="font-size:14px;font-weight:500;color:var(--dark);margin-bottom:10px">'+(i+1)+'. '+q.q+'</div>'
        +'<div style="display:flex;align-items:center;gap:10px">'
        +'<span style="font-size:12px;color:var(--muted);width:80px;text-align:right">'+q.lo+'</span>'
        +'<div style="display:flex;gap:6px;flex:1;justify-content:center">'
        +[1,2,3,4,5].map(function(v){
          return '<button onclick="pickAsm('+i+','+v+',this)" id="asm-'+i+'-'+v+'" style="width:38px;height:38px;border-radius:50%;border:2px solid var(--border);background:transparent;font-size:14px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .18s">'+v+'</button>';
        }).join('')
        +'</div>'
        +'<span style="font-size:12px;color:var(--muted);width:80px">'+q.hi+'</span>'
        +'</div></div>';
    }).join('')
    +'<button class="btn btn-p btn-full" onclick="submitAssessment()">submit check-in</button>'
    +'</div>');
}
function pickAsm(qi,val,btn){
  asmAnswers[qi]=val;
  for(var v=1;v<=5;v++){
    var b=document.getElementById('asm-'+qi+'-'+v);
    if(b){b.style.background=v===val?'var(--brand)':'transparent';b.style.color=v===val?'#fff':'var(--muted)';b.style.borderColor=v===val?'var(--brand)':'var(--border)';}
  }
}
function submitAssessment(){
  if(Object.keys(asmAnswers).length<AQ.length){toast('please answer all questions üòä');return;}
  asmDone=true; pgHealthResults();
}
function pgHealthResults(){
  var total=Object.values(asmAnswers).reduce(function(a,b){return a+b},0);
  var pct=Math.round((total/(AQ.length*5))*100);
  var cls=pct>=80?'var(--brand)':pct>=60?'var(--accent)':'#E74C3C';
  pc('<div class="card" style="text-align:center;padding:32px 24px;margin-bottom:18px">'
    +'<div style="font-size:54px;font-weight:700;color:'+cls+';font-family:\'DM Serif Display\',serif">'+pct+'%</div>'
    +'<div style="font-size:16px;font-weight:600;color:var(--dark);margin-top:4px">overall group health</div>'
    +'<div style="font-size:14px;color:var(--muted);margin-top:6px">'+(pct>=80?'your group is thriving!':pct>=60?'good, with room to grow.':'some areas need attention.')+'</div>'
    +'</div>'
    +'<div class="card">'
    +AQ.map(function(q,i){
      var v=asmAnswers[i]||3;
      return '<div style="margin-bottom:16px">'
        +'<div style="font-size:13px;color:var(--dark);margin-bottom:6px">'+q.q+'</div>'
        +healthBar('',Math.round((v/5)*100))
        +'</div>';
    }).join('')
    +'<button class="btn btn-s btn-sm mt-10" onclick="asmDone=false;asmAnswers={};pgAssess()">retake assessment</button>'
    +'</div>');
}

/* ============================================================
   PAGE: MILESTONES
   ============================================================ */
function pgMiles(){
  if(!DEMO&&!CU.groupId){pc(empty('üèÜ','milestones','your group\'s milestones and badges will appear here as you meet together.',''));return;}
  var g=DEMO?GD:{start:new Date().toISOString(),stats:{meetings:0,answered:0,books:0}};
  var years=yrs(g.start||new Date());
  pc('<div class="card" style="margin-bottom:18px;background:linear-gradient(135deg,var(--brand-p),#fff);border-color:var(--brand-l)">'
    +'<div class="card-header"><span class="card-title">üåü your journey</span></div>'
    +'<div class="g3">'
    +'<div style="text-align:center;padding:14px;background:rgba(255,255,255,.7);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:28px;color:var(--dark)">'+(g.stats?g.stats.meetings:0)+'</div><div style="font-size:12px;color:var(--muted)">meetings</div></div>'
    +'<div style="text-align:center;padding:14px;background:rgba(255,255,255,.7);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:28px;color:var(--dark)">'+years+'</div><div style="font-size:12px;color:var(--muted)">years together</div></div>'
    +'<div style="text-align:center;padding:14px;background:rgba(255,255,255,.7);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:28px;color:var(--dark)">'+(g.stats?g.stats.answered:0)+'</div><div style="font-size:12px;color:var(--muted)">answered ‚ú®</div></div>'
    +'</div></div>'
    +'<div class="badge-grid">'
    +BADGES.map(function(b){
      return '<div class="milestone'+(b.e?' earned':' locked')+'">'
        +'<div class="milestone-em">'+b.em+'</div>'
        +'<div class="milestone-name">'+b.n+'</div>'
        +'<div class="milestone-desc">'+b.d+'</div>'
        +(b.e?'':'<div style="font-size:10px;color:var(--muted);margin-top:4px">locked</div>')
        +'</div>';
    }).join('')
    +'</div>');
}

/* ============================================================
   PAGE: STUDY RESOURCES
   ============================================================ */
var bibleFilter='all';
function pgResources(){
  if(isLeader()) topAction('<button class="btn btn-p btn-sm" onclick="modalAddRes(\'group\')">+ add resource</button>');
  var grpRes=CU.groupResources||[];
  pc((GD&&GD.study
    ?'<div class="invite-card" style="margin-bottom:0">'
      +'<div class="invite-label">üìñ currently studying</div>'
      +'<div style="font-size:16px;font-weight:600;color:var(--dark);margin-bottom:4px">'+GD.study+'</div>'
      +(GD.hw?'<div style="font-size:13px;color:var(--mid);margin-bottom:10px"><strong>homework:</strong> '+GD.hw+'</div>':'')
      +(isLeader()?'<button class="btn btn-s btn-sm" onclick="modalEditMeeting()">edit study details</button>':'')
      +'</div>'
    :'')
    +'<div class="card" style="margin-bottom:18px;background:linear-gradient(135deg,#FFF3E0,#FFF8F0);border-color:var(--accent-l)">'
    +'<div class="card-title" style="color:var(--accent);margin-bottom:8px">üß≠ get a recommendation</div>'
    +'<div style="font-size:14px;color:var(--mid);margin-bottom:12px">not sure what to study next? answer 3 quick questions and we\'ll suggest something.</div>'
    +'<button class="btn btn-a btn-sm" onclick="modalStudyQuiz()">get a recommendation ‚Üí</button>'
    +'</div>'
    +(grpRes.length>0
      ?'<div class="sec-label">group resources</div>'
        +grpRes.map(function(r){return resCardHtml(r,isLeader())}).join('')
      :'')
    +'<div class="sec-label">books of the bible</div>'
    +'<div class="tabs" id="bible-tabs" style="margin-bottom:14px">'
    +'<div class="tab'+(bibleFilter==='all'?' active':'')+'" onclick="filterBible(\'all\',this)">all (66)</div>'
    +'<div class="tab'+(bibleFilter==='OT'?' active':'')+'" onclick="filterBible(\'OT\',this)">old testament (39)</div>'
    +'<div class="tab'+(bibleFilter==='NT'?' active':'')+'" onclick="filterBible(\'NT\',this)">new testament (27)</div>'
    +'</div>'
    +'<div id="bible-grid">'
    +bibleHtml(BIBLE_BOOKS)
    +'</div>');
}
function bibleHtml(list){
  return list.map(function(b){
    return '<div class="res-card">'
      +'<div class="res-type">'+b.t+'</div>'
      +'<div class="res-title">'+b.title+'</div>'
      +'<div class="res-desc">'+b.desc+'</div>'
      +'<div class="res-tags">'+b.tags.map(function(t){return '<span class="chip">'+t+'</span>'}).join('')+'</div>'
      +(isLeader()?'<div class="res-actions"><button class="btn btn-p btn-sm mt-10" onclick="setStudy(\''+b.title+'\')">üìñ set as current study</button></div>':'')
      +'</div>';
  }).join('');
}
function filterBible(f,el){
  bibleFilter=f;
  document.querySelectorAll('#bible-tabs .tab').forEach(function(t){t.classList.remove('active')});
  el.classList.add('active');
  var list=f==='all'?BIBLE_BOOKS:BIBLE_BOOKS.filter(function(b){return b.t===f});
  document.getElementById('bible-grid').innerHTML=bibleHtml(list);
}
function setStudy(title){
  if(!GD) GD={name:'',start:'',next:{},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  GD.study=title;
  toast('"'+title+'" set as current study üìñ');
  pgResources();
}

/* ============================================================
   PAGE: MANAGE MEMBERS
   ============================================================ */
function pgMembers(){
  var code=DEMO?'GRP-THUR':(CU.groupCode||(CU.groupCode=genCode('GRP')));
  var realMembers=DEMO?DEMO_MEMBERS.filter(function(m){return m.real}):(CU.groupRealMembers||[]);
  var placeholders=DEMO?DEMO_MEMBERS.filter(function(m){return !m.real}):(CU.placeholderMembers||[]);
  var all=realMembers.concat(placeholders);
  topAction('<button class="btn btn-s btn-sm" style="margin-right:8px" onclick="modalAddPlaceholder()">+ add member</button>'
    +'<button class="btn btn-p btn-sm" onclick="modalInviteCode()">üîó invite code</button>');
  pc('<div class="invite-card" style="margin-bottom:18px">'
    +'<div class="invite-label">group invite code</div>'
    +'<div class="invite-code">'+code+'</div>'
    +'<div class="invite-note">share this with anyone you want in your group - they\'ll enter it when creating their account</div>'
    +'<button class="btn btn-p btn-sm" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'code copied! üìã\')">copy code</button>'
    +'</div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">members ('+all.length+')</span></div>'
    +(all.length===0
      ?'<div style="text-align:center;padding:24px;color:var(--muted);font-size:14px">no members yet - share your invite code or add a placeholder above.</div>'
      :all.map(function(m){
        var placeholder=!m.real;
        return '<div class="member-row">'
          +'<div class="m-av'+(placeholder?' placeholder':'')+'">'+(placeholder?'?':m.i)+'</div>'
          +'<div style="flex:1"><div class="m-name">'+m.n+(placeholder?' <span style="font-size:11px;font-weight:400;color:var(--muted)">(placeholder)</span>':'')+'</div>'
          +'<div class="m-role">'+m.r+'</div></div>'
          +'<div class="m-actions">'
          +(placeholder
            ?'<span class="badge badge-grey">not yet joined</span><button class="btn btn-g btn-sm" onclick="removePlaceholder(\''+m.n+'\')">remove</button>'
            :'<span class="badge badge-green">‚úì joined</span><button class="btn btn-g btn-sm" onclick="modalEditRole(\''+m.n+'\')">edit role</button>')
          +'</div></div>';
      }).join(''))
    +'</div>');
}
function removePlaceholder(name){
  CU.placeholderMembers=(CU.placeholderMembers||[]).filter(function(m){return m.n!==name});
  DEMO_MEMBERS.splice(DEMO_MEMBERS.findIndex(function(m){return m.n===name&&!m.real}),1);
  pgMembers(); toast('placeholder removed');
}

/* ============================================================
   MODALS
   ============================================================ */
function mClose(){return '<button class="modal-close" onclick="closeModal()">‚úï</button>';}

function modalCreateGroup(){
  openModal(mClose()+'<h2>üë• create your group</h2>'
    +'<div class="fg"><label>group name</label><input type="text" id="cg-name" placeholder="e.g. Thursday Night Crew"></div>'
    +'<div class="fg"><label>when did your group start?</label><input type="date" id="cg-start" value="'+new Date().toISOString().split('T')[0]+'"></div>'
    +'<div class="banner banner-green">üí° if your group started in the past, enter the real start date - you\'ll instantly earn milestone badges!</div>'
    +'<div class="fg"><label>meeting day</label><select id="cg-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>'
    +'<div class="fg"><label>meeting time</label><select id="cg-time">'+timeOptions()+'</select></div>'
    +'<div class="fg"><label>how often does your group meet?</label><select id="cg-freq"><option>weekly</option><option>every other week</option><option>monthly</option><option>irregular / varies</option></select></div>'
    +'<button class="btn btn-p btn-full" onclick="doCreateGroup()">create group üéâ</button>');
}

async function doCreateGroup(){
  var name=document.getElementById('cg-name').value.trim();
  if(!name){toast('please enter a group name üòä');return;}
  var start=document.getElementById('cg-start').value;
  var day=document.getElementById('cg-day').value;
  var time=document.getElementById('cg-time').value;
  var freq=document.getElementById('cg-freq').value;
  if(CU.id){
    var ins=await sb.from('groups').insert({
      name:name, start_date:start, meeting_day:day,
      meeting_time:time, frequency:freq, created_by:CU.id,
      ministry_id:CU.ministryId||null
    }).select().single();
    if(ins.error){toast('error: '+ins.error.message);return;}
    var gid=ins.data.id;
    await sb.from('profiles').update({group_id:gid}).eq('id',CU.id);
    var mem=await sb.from('group_members').insert({group_id:gid,user_id:CU.id,role:'leader'});
    if(mem.error){toast('group created but member link failed: '+mem.error.message);}
    CU.groupId=gid;
  }
  GD={name:name,start:start,next:{day:day,time:time,loc:'',freq:freq},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  closeModal();
  goPage(CU.type==='ministry'?'grp-home':'home');
  toast('group created! üéâ');
}

function modalEditMeeting(){
  var n=GD&&GD.next?GD.next:{};
  openModal(mClose()+'<h2>üìÖ edit meeting details</h2>'
    +'<div class="fg"><label>meeting day</label>'
    +'<select id="em-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>'
    +'<div class="fg"><label>meeting time</label><select id="em-time">'+timeOptions()+'</select></div>'
    +'<div class="fg"><label>location / host name</label><input type="text" id="em-loc" value="'+(n.loc||'')+'" placeholder="e.g. Marcus & Jenna\'s"></div>'
    +'<div class="fg"><label>frequency</label>'
    +'<select id="em-freq"><option>weekly</option><option>every other week</option><option>monthly</option><option>irregular / varies</option></select></div>'
    +'<hr class="divider">'
    +'<div style="font-size:13px;font-weight:600;color:var(--dark);margin-bottom:12px">üìñ study & homework</div>'
    +'<div class="fg"><label>current study / book</label><input type="text" id="em-study" value="'+(GD&&GD.study?GD.study:'')+'" placeholder="e.g. James, The Chosen Season 1"></div>'
    +'<div class="fg"><label>homework for next meeting</label><textarea rows="3" id="em-hw" placeholder="e.g. read chapters 3-4 and journal...">'+(GD&&GD.hw?GD.hw:'')+'</textarea></div>'
    +'<button class="btn btn-p btn-full" onclick="saveMeeting()">save changes</button>');
  setTimeout(function(){
    var ds=document.getElementById('em-day');
    var ts=document.getElementById('em-time');
    var fs=document.getElementById('em-freq');
    if(ds&&n.day) Array.from(ds.options).forEach(function(o){if(o.value===n.day)o.selected=true;});
    if(ts&&n.time) Array.from(ts.options).forEach(function(o){if(o.value===n.time)o.selected=true;});
    if(fs&&n.freq) Array.from(fs.options).forEach(function(o){if(o.value===n.freq)o.selected=true;});
  },50);
}
function saveMeeting(){
  if(!GD) GD={name:'',start:'',next:{},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  GD.next={
    day:document.getElementById('em-day').value,
    time:document.getElementById('em-time').value,
    loc:document.getElementById('em-loc').value,
    freq:document.getElementById('em-freq').value
  };
  GD.study=document.getElementById('em-study').value;
  GD.hw=document.getElementById('em-hw').value;
  closeModal();
  toast('meeting details saved üìÖ');
  // Refresh whichever page we're on
  var active=document.querySelector('.ni.active');
  if(active) goPage(active.id.replace('ni-',''));
}

function modalAddPrayer(){
  openModal(mClose()+'<h2>üôè add a prayer request</h2>'
    +'<div class="fg"><label>your prayer request</label><textarea rows="4" id="np" placeholder="share what\'s on your heart..."></textarea></div>'
    +'<div class="fg"><label>category (optional)</label><select><option>general</option><option>health</option><option>relationships</option><option>work / finances</option><option>praise & gratitude</option></select></div>'
    +'<button class="btn btn-p btn-full" onclick="submitPrayer()">post prayer request üôè</button>');
}
async function submitPrayer(){
  var t=document.getElementById('np').value.trim();
  if(!t){toast('please write your prayer request üòä');return;}
  if(CU.id&&CU.groupId){
    var r=await sb.from('prayers').insert({group_id:CU.groupId,user_id:CU.id,text:t,category:'general'});
    if(r.error){toast('error saving: '+r.error.message);return;}
  } else {
    PRAYERS.unshift({id:Date.now(),au:CU.name,txt:t,dt:'just now',ans:false,cnt:0,prayed:false});
  }
  closeModal(); pgPrayers(); toast('prayer request posted üôè');
}

function modalMarkAnswered(id){
  var p=PRAYERS.find(function(x){return x.id===id});
  if(!p) return;
  openModal(mClose()+'<h2>üéâ mark as answered</h2>'
    +'<div class="modal-sub">'+p.txt+'</div>'
    +'<div class="fg"><label>how did God answer this prayer?</label><textarea rows="3" id="ans-note" placeholder="share what happened (optional)..."></textarea></div>'
    +'<button class="btn btn-p btn-full" onclick="doMarkAnswered('+id+')">mark answered ‚ú®</button>');
}
function doMarkAnswered(id){
  var p=PRAYERS.find(function(x){return x.id===id});
  if(p){p.ans=true;p.anote=document.getElementById('ans-note').value;}
  closeModal(); pgPrayers(); toast('answered prayer logged! üéâ');
}

function modalAddPlaceholder(){
  openModal(mClose()+'<h2>üë§ add a member</h2>'
    +'<div class="modal-sub">add someone as a placeholder until they create their groupify account.</div>'
    +'<div class="fg"><label>full name</label><input type="text" id="ph-name" placeholder="e.g. Sarah Johnson"></div>'
    +'<div class="fg"><label>role</label><select id="ph-role">'+MEMBER_ROLES.map(function(r){return '<option>'+r+'</option>'}).join('')+'</select></div>'
    +'<button class="btn btn-p btn-full" onclick="savePlaceholder()">add member</button>');
}
function savePlaceholder(){
  var name=document.getElementById('ph-name').value.trim();
  var role=document.getElementById('ph-role').value;
  if(!name){toast('please enter a name üòä');return;}
  if(!CU.placeholderMembers) CU.placeholderMembers=[];
  CU.placeholderMembers.push({n:name,r:role,real:false});
  if(DEMO) DEMO_MEMBERS.push({n:name,r:role,i:initials(name),real:false});
  closeModal(); pgMembers(); toast(name+' added üë§');
}

function modalEditRole(name){
  openModal(mClose()+'<h2>edit role</h2>'
    +'<div class="fg"><label>role for '+name+'</label>'
    +'<select id="er-role">'+MEMBER_ROLES.map(function(r){return '<option>'+r+'</option>'}).join('')+'</select></div>'
    +'<button class="btn btn-p btn-full" onclick="closeModal();toast(\'role updated ‚úÖ\')">save</button>');
}

function modalInviteCode(){
  var code=DEMO?'GRP-THUR':(CU.groupCode||(CU.groupCode=genCode('GRP')));
  openModal(mClose()+'<h2>üîó group invite code</h2>'
    +'<div class="modal-sub">share this code with anyone you want in your group. they\'ll enter it when creating their groupify account.</div>'
    +'<div style="text-align:center;padding:24px;background:var(--brand-p);border-radius:var(--rsm);margin-bottom:18px">'
    +'<div style="font-size:36px;font-weight:700;color:var(--brand);letter-spacing:4px">'+code+'</div>'
    +'</div>'
    +'<button class="btn btn-p btn-full" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'code copied! üìã\')">copy code</button>');
}

function modalAddRes(scope){
  openModal(mClose()+'<h2>üìö add a resource</h2>'
    +'<div class="modal-sub">this resource will be added to your <strong>'+scope+'\'s</strong> list.</div>'
    +'<div class="fg"><label>title</label><input type="text" id="res-title" placeholder="resource name"></div>'
    +'<div class="fg"><label>type</label><select id="res-type"><option>Bible Study</option><option>Video Series</option><option>Book</option><option>Devotional</option></select></div>'
    +'<div class="fg"><label>description</label><textarea rows="3" id="res-desc" placeholder="brief description..."></textarea></div>'
    +'<button class="btn btn-p btn-full" onclick="saveResource(\''+scope+'\')">add resource</button>');
}
function saveResource(scope){
  var title=document.getElementById('res-title').value.trim();
  var type=document.getElementById('res-type').value;
  var desc=document.getElementById('res-desc').value.trim();
  if(!title){toast('please enter a title üòä');return;}
  var res={title:title,type:type,desc:desc,tags:[]};
  if(scope==='ministry'){ DEMO_RESOURCES.unshift(res); closeModal(); pgMinRes(); }
  else { if(!CU.groupResources) CU.groupResources=[]; CU.groupResources.unshift(res); closeModal(); pgResources(); }
  toast('resource added üìö');
}

function modalAddHost(){
  openModal(mClose()+'<h2>üè° add a host</h2>'
    +'<div class="fg"><label>name</label><input type="text" id="h-name" placeholder="e.g. Marcus & Jenna"></div>'
    +'<div class="fg"><label>address</label><input type="text" id="h-addr" placeholder="123 Main Street"></div>'
    +'<button class="btn btn-p btn-full" onclick="saveHost()">add host</button>');
}
function saveHost(){
  var n=document.getElementById('h-name').value.trim();
  var a=document.getElementById('h-addr').value.trim();
  if(!n){toast('please enter a name üòä');return;}
  ROTATION.push({n:n,a:a});
  closeModal(); pgRotation(); toast('host added üè°');
}

function modalAddSlot(){
  openModal(mClose()+'<h2>üóìÔ∏è add a time slot</h2>'
    +'<div class="fg"><label>day</label><select id="sl-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>'
    +'<div class="fg"><label>date</label><input type="text" id="sl-date" placeholder="e.g. March 5"></div>'
    +'<div class="fg"><label>time</label><select id="sl-time">'+timeOptions()+'</select></div>'
    +'<button class="btn btn-p btn-full" onclick="saveSlot()">add slot</button>');
}
function saveSlot(){
  var day=document.getElementById('sl-day').value;
  var date=document.getElementById('sl-date').value;
  var time=document.getElementById('sl-time').value;
  if(!date){toast('please enter a date üòä');return;}
  DEMO_SCHED.push({id:Date.now(),day:day,date:date,time:time,votes:0});
  closeModal(); pgSched(); toast('slot added üóìÔ∏è');
}

function modalStudyQuiz(){
  openModal(mClose()+'<h2>üß≠ study recommendation</h2>'
    +'<div class="fg"><label>what is your group\'s biggest focus right now?</label>'
    +'<select id="q-focus"><option>growing in faith</option><option>building community</option><option>serving others</option><option>navigating life challenges</option></select></div>'
    +'<div class="fg"><label>how long has your group been together?</label>'
    +'<select id="q-age"><option>just getting started</option><option>less than a year</option><option>1-3 years</option><option>3+ years</option></select></div>'
    +'<div class="fg"><label>what format does your group prefer?</label>'
    +'<select id="q-format"><option>video-based discussion</option><option>book study</option><option>Bible deep-dive</option><option>something lighter</option></select></div>'
    +'<button class="btn btn-a btn-full" onclick="showRec()">get my recommendation ‚Üí</button>');
}
function showRec(){
  var recs=[
    {type:'Bible Study',title:'James: Faith That Works',desc:'Perfect for groups ready to wrestle with practical, everyday faith. Short book, deep content.',tags:['faith','works','practical']},
    {type:'Video Series',title:'The Chosen - Season 1',desc:'A beautiful way to experience the life of Jesus together. Great for all stages of faith.',tags:['jesus','video','community']},
    {type:'Bible Study',title:'Philippians: Joy in Every Season',desc:'Four chapters packed with hope, contentment, and joy. Works for any group.',tags:['joy','hope','encouragement']}
  ];
  var r=recs[Math.floor(Math.random()*recs.length)];
  openModal(mClose()+'<h2>üß≠ our recommendation</h2>'
    +'<div class="res-card" style="margin-bottom:16px">'
    +'<div class="res-type">'+r.type+'</div>'
    +'<div class="res-title">'+r.title+'</div>'
    +'<div class="res-desc">'+r.desc+'</div>'
    +'<div class="res-tags">'+r.tags.map(function(t){return '<span class="chip">'+t+'</span>'}).join('')+'</div>'
    +'</div>'
    +'<button class="btn btn-p btn-full" onclick="setStudy(\''+r.title+'\');closeModal()">üìñ set as current study</button>'
    +'<button class="btn btn-g btn-full mt-10" onclick="modalStudyQuiz()">try again</button>');
}

/* ============================================================
   SIGNUP FLOW
   ============================================================ */
function pickRole(role){
  caRole=role;
  document.querySelectorAll('.role-opt').forEach(function(el){el.classList.remove('sel')});
  var el=document.getElementById('ro-'+role);
  if(el) el.classList.add('sel');
}
function caStep2(){
  if(!caRole){toast('please select a role to continue üòä');return;}
  showView('v-ca2');
}
function caStep3(){
  var fname=document.getElementById('ca-fname').value.trim();
  var lname=document.getElementById('ca-lname').value.trim();
  var email=document.getElementById('ca-email').value.trim();
  var pw=document.getElementById('ca-pw').value;
  var pw2=document.getElementById('ca-pw2').value;
  if(!fname||!lname){toast('please enter your name üòä');return;}
  if(!email){toast('please enter your email üòä');return;}
  if(pw.length<8){toast('password must be at least 8 characters üòä');return;}
  if(pw!==pw2){toast('passwords don\'t match üòä');return;}
  var body='';
  if(caRole==='ministry'){
    body='<div class="fg"><label>church or ministry name</label><input type="text" id="ca-church" placeholder="e.g. River Community Church"></div>'
      +'<div class="fg"><label>your title / role</label><input type="text" id="ca-title" placeholder="e.g. Small Groups Pastor"></div>';
  } else if(caRole==='leader'){
    body='<div class="fg"><label>group name</label><input type="text" id="ca-gname" placeholder="e.g. Thursday Night Crew"></div>'
      +'<div class="fg"><label>ministry invite code (optional)</label><input type="text" id="ca-mcode" placeholder="enter your ministry\'s code if you have one"></div>';
  } else {
    body='<div class="fg"><label>group invite code</label><input type="text" id="ca-icode" placeholder="enter the code your group leader gave you"></div>';
  }
  document.getElementById('ca3-body').innerHTML=body;
  showView('v-ca3');
}
async function caFinish(){
  var fname=document.getElementById('ca-fname').value.trim();
  var lname=document.getElementById('ca-lname').value.trim();
  var email=document.getElementById('ca-email').value.trim();
  var pw=document.getElementById('ca-pw').value;
  var btn=document.getElementById('ca-finish-btn');
  btn.textContent='creating account...'; btn.disabled=true;
  try {
    var meta={full_name:fname+' '+lname,role:caRole};
    if(caRole==='ministry'){
      meta.church_name=(document.getElementById('ca-church')||{value:''}).value.trim();
    } else if(caRole==='leader'){
      meta.ministry_code=(document.getElementById('ca-mcode')||{value:''}).value.trim();
    } else {
      meta.group_code=(document.getElementById('ca-icode')||{value:''}).value.trim();
    }
    var r=await sb.auth.signUp({email:email,password:pw,options:{data:meta,emailRedirectTo:'https://ebpeyt88.github.io/groupify/'}});
    if(r.error){toast('sign up failed: '+r.error.message+' üòï');btn.textContent='create account üéâ';btn.disabled=false;return;}
    showView('v-confirm');
  } catch(e){
    toast('error: '+e.message);
    btn.textContent='create account üéâ'; btn.disabled=false;
  }
}

/* ============================================================
   SESSION CHECK ON LOAD
   ============================================================ */
window.addEventListener('DOMContentLoaded', async function(){
  if(!sb) return;
  try {
    var r=await sb.auth.getSession();
    if(r.data&&r.data.session) await loadProfile(r.data.session.user);
  } catch(e){ console.log('Session check failed:',e); }
});
</script>
</body>
</html>
