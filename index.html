<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>groupify</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ============================================================
   DESIGN TOKENS
   ============================================================ */
:root {
  --brand:#2D6A4F; --brand-l:#52B788; --brand-p:#D8F3DC;
  --accent:#F4845F; --accent-l:#FDDCCC;
  --dark:#1B2D24; --mid:#4A6558; --text:#2C3E35; --muted:#7A9688;
  --border:#D4E8DC; --bg:#F5FAF7;
  --shadow:0 2px 12px rgba(45,106,79,.08);
  --shadow-lg:0 8px 32px rgba(45,106,79,.14);
  --r:16px; --rsm:10px;
}

/* ============================================================
   RESET & BASE
   ============================================================ */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:15px;line-height:1.5}
a{cursor:pointer;color:var(--brand);text-decoration:none;font-weight:500}
a:hover{text-decoration:underline}

/* ============================================================
   SCREENS
   ============================================================ */
.screen{display:none;min-height:100vh}
.screen.active{display:flex;flex-direction:column}
#s-app.active{flex-direction:row}

/* ============================================================
   AUTH / LOGIN
   ============================================================ */
#s-login{background:linear-gradient(145deg,#1B2D24 0%,#2D6A4F 60%,#52B788 100%);align-items:center;justify-content:center;padding:24px}
.lcard{background:#fff;border-radius:24px;padding:48px 40px;width:100%;max-width:420px;box-shadow:0 24px 64px rgba(0,0,0,.2)}
.llogo{font-family:'DM Serif Display',serif;font-size:46px;font-weight:400;color:var(--brand);text-align:center;margin-bottom:4px;letter-spacing:-1px}
.ltag{text-align:center;color:var(--muted);font-size:14px;margin-bottom:28px}
.lswitch{text-align:center;font-size:13px;color:var(--muted);margin-top:16px}

/* Step dots for signup flow */
.step-dots{display:flex;gap:8px;justify-content:center;margin-bottom:22px}
.step-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all .25s}
.step-dot.active{background:var(--brand);width:22px;border-radius:4px}

/* Role picker */
.role-grid{display:grid;gap:10px;margin-bottom:20px}
.role-opt{border:1.5px solid var(--border);border-radius:var(--rsm);padding:14px 16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px}
.role-opt:hover{border-color:var(--brand-l);background:var(--brand-p)}
.role-opt.sel{border-color:var(--brand);background:var(--brand-p)}
.role-opt-em{font-size:22px;flex-shrink:0}
.role-opt-title{font-size:14px;font-weight:600;color:var(--dark)}
.role-opt-sub{font-size:12px;color:var(--muted);margin-top:2px}

/* Demo buttons */
.demo-sep{border-top:1px solid var(--border);margin-top:24px;padding-top:20px;text-align:center}
.demo-sep p{font-size:12px;color:var(--muted);margin-bottom:10px}
.demo-btn{display:block;width:100%;padding:11px;border-radius:var(--rsm);font-size:14px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);background:var(--bg);color:var(--mid);text-align:center;transition:all .2s;margin-bottom:8px;font-family:inherit}
.demo-btn:hover{border-color:var(--brand-l);background:var(--brand-p);color:var(--brand)}

/* ============================================================
   FORMS
   ============================================================ */
.fg{margin-bottom:16px}
.fg label{display:block;font-size:13px;font-weight:500;color:var(--mid);margin-bottom:6px}
.fg input,.fg select,.fg textarea{width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:11px 15px;font-family:inherit;font-size:15px;color:var(--text);background:var(--bg);outline:none;transition:border-color .2s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--brand-l);background:#fff}
.fg textarea{resize:vertical;line-height:1.5}
.field-note{font-size:12px;color:var(--muted);margin-top:4px}

/* ============================================================
   BUTTONS
   ============================================================ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:11px 22px;border-radius:var(--rsm);font-family:inherit;font-size:15px;font-weight:500;cursor:pointer;border:none;transition:all .18s;white-space:nowrap}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-p{background:var(--brand);color:#fff}
.btn-p:hover:not(:disabled){background:var(--dark);transform:translateY(-1px);box-shadow:var(--shadow)}
.btn-s{background:var(--brand-p);color:var(--brand)}
.btn-s:hover:not(:disabled){background:var(--border)}
.btn-a{background:var(--accent);color:#fff}
.btn-a:hover:not(:disabled){background:#e06a45}
.btn-g{background:transparent;color:var(--mid);border:1.5px solid var(--border)}
.btn-g:hover:not(:disabled){background:var(--brand-p);color:var(--brand);border-color:var(--brand-l)}
.btn-sm{padding:7px 14px;font-size:13px}
.btn-full{width:100%}
.btn-row{display:flex;gap:10px}
.btn-row .btn-full{flex:1}

/* ============================================================
   APP SHELL - SIDEBAR
   ============================================================ */
.sidebar{width:256px;background:var(--dark);color:#fff;display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;position:sticky;top:0;height:100vh}
.sb-logo{padding:24px 22px 16px;font-family:'DM Serif Display',serif;font-weight:400;letter-spacing:-0.5px;font-size:28px;color:var(--brand-l);border-bottom:1px solid rgba(255,255,255,.07)}
.sb-logo small{display:block;font-size:11px;font-weight:400;color:rgba(255,255,255,.3);margin-top:-2px;letter-spacing:0}
.sb-user{padding:14px 22px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:10px}
.u-av{width:36px;height:36px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;color:#fff}
.u-name{font-size:14px;font-weight:500;color:#fff;line-height:1.3}
.u-role{font-size:11px;color:rgba(255,255,255,.38)}
.sb-nav{padding:12px 0;flex:1}
.nav-sec{padding:10px 22px 3px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,.28)}
.nav-divider{border-top:1px solid rgba(255,255,255,.07);margin:8px 0}
.ni{display:flex;align-items:center;gap:11px;padding:10px 22px;font-size:14px;color:rgba(255,255,255,.58);cursor:pointer;transition:all .15s;border-left:3px solid transparent}
.ni:hover{background:rgba(255,255,255,.06);color:#fff}
.ni.active{background:rgba(82,183,136,.14);color:var(--brand-l);border-left-color:var(--brand-l)}
.ni-ic{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.sb-foot{padding:14px 22px;border-top:1px solid rgba(255,255,255,.07)}

/* ============================================================
   APP SHELL - MAIN CONTENT
   ============================================================ */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:15px 28px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;position:sticky;top:0;z-index:10}
.topbar h1{font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark)}
#page-content{padding:24px 28px;flex:1}

/* ============================================================
   CARDS & LAYOUT
   ============================================================ */
.card{background:#fff;border-radius:var(--r);padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:18px}
.card:last-child{margin-bottom:0}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:15px;font-weight:600;color:var(--dark)}
.card-note{font-size:13px;color:var(--muted)}
.sec-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:12px;margin-top:4px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}

/* ============================================================
   STAT CARDS
   ============================================================ */
.stat-card{background:#fff;border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow);border:1px solid var(--border)}
.stat-em{font-size:24px;margin-bottom:6px}
.stat-val{font-family:'DM Serif Display',serif;font-size:32px;color:var(--dark);line-height:1}
.stat-lbl{font-size:12px;color:var(--muted);margin-top:4px}

/* ============================================================
   HERO / NEXT MEETING
   ============================================================ */
.mhero{background:linear-gradient(135deg,var(--brand) 0%,var(--brand-l) 100%);border-radius:var(--r);padding:26px;color:#fff;margin-bottom:18px;position:relative;overflow:hidden}
.mhero::before{content:'';position:absolute;right:-20px;top:-20px;width:140px;height:140px;background:rgba(255,255,255,.06);border-radius:50%}
.mhero::after{content:'';position:absolute;right:40px;bottom:-30px;width:90px;height:90px;background:rgba(255,255,255,.05);border-radius:50%}
.mhero-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.4px;opacity:.65;margin-bottom:7px}
.mhero-title{font-family:'DM Serif Display',serif;font-size:26px;margin-bottom:14px;position:relative}
.mhero-details{display:flex;flex-wrap:wrap;gap:6px 18px;position:relative}
.mhero-detail{font-size:14px;opacity:.9}
.mhero-actions{margin-top:16px;position:relative}

/* ============================================================
   ICEBREAKER CARD
   ============================================================ */
.iq-card{background:linear-gradient(135deg,var(--brand-p),#fff);border:1.5px solid var(--brand-l);border-radius:var(--r);padding:24px;margin-bottom:18px}
.iq-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--brand);margin-bottom:12px}
.iq-text{font-family:'DM Serif Display',serif;font-size:21px;color:var(--dark);line-height:1.45;margin-bottom:16px}
.iq-footer{display:flex;align-items:center;justify-content:space-between;gap:12px}
.iq-tip{font-size:13px;color:var(--mid)}

/* ============================================================
   TABS
   ============================================================ */
.tabs{display:flex;gap:4px;background:var(--bg);border-radius:var(--rsm);padding:4px;margin-bottom:18px;border:1px solid var(--border)}
.tab{flex:1;padding:8px 12px;border-radius:7px;font-size:13px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .18s;text-align:center}
.tab.active{background:#fff;color:var(--brand);box-shadow:var(--shadow)}
.tab:hover:not(.active){color:var(--mid)}

/* ============================================================
   MEMBERS LIST
   ============================================================ */
.member-row{display:flex;align-items:center;gap:14px;padding:13px 0;border-bottom:1px solid var(--border)}
.member-row:last-child{border-bottom:none}
.m-av{width:38px;height:38px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0}
.m-av.placeholder{background:var(--muted);opacity:.6}
.m-name{font-size:14px;font-weight:600;color:var(--dark)}
.m-role{font-size:12px;color:var(--muted);margin-top:2px}
.m-actions{margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0}

/* ============================================================
   BADGES & CHIPS
   ============================================================ */
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
.badge-green{background:var(--brand-p);color:var(--brand)}
.badge-blue{background:#E8F4FD;color:#2980B9}
.badge-grey{background:#f3f3f3;color:var(--muted)}
.chip{background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:12px;color:var(--mid)}

/* ============================================================
   RESOURCE CARDS
   ============================================================ */
.res-card{background:#fff;border:1.5px solid var(--border);border-radius:var(--rsm);padding:16px;margin-bottom:12px}
.res-type{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--brand);margin-bottom:5px}
.res-title{font-size:15px;font-weight:600;color:var(--dark);margin-bottom:5px}
.res-desc{font-size:13px;color:var(--mid);line-height:1.5;margin-bottom:10px}
.res-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
.res-actions{display:flex;gap:8px;flex-wrap:wrap}

/* ============================================================
   HEALTH / PROGRESS
   ============================================================ */
.health-row{margin-bottom:12px}
.health-row-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:14px}
.health-bar-bg{height:8px;background:var(--bg);border-radius:4px;border:1px solid var(--border)}
.health-bar-fill{height:100%;border-radius:4px;background:var(--brand-l);transition:width .5s ease}
.health-bar-fill.low{background:#E74C3C}
.health-bar-fill.med{background:#F39C12}

/* ============================================================
   MILESTONE BADGES
   ============================================================ */
.badge-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px}
.milestone{border-radius:var(--rsm);padding:18px 14px;text-align:center;border:1.5px solid var(--border);transition:all .2s}
.milestone.earned{background:var(--brand-p);border-color:var(--brand-l)}
.milestone.locked{background:#fafafa;opacity:.55}
.milestone-em{font-size:36px;margin-bottom:8px}
.milestone-name{font-size:13px;font-weight:600;color:var(--dark)}
.milestone-desc{font-size:11px;color:var(--muted);margin-top:3px}

/* ============================================================
   ATTENDANCE
   ============================================================ */
.att-row{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border)}
.att-row:last-child{border-bottom:none}
.att-btns{margin-left:auto;display:flex;gap:6px}
.att-btn{padding:6px 14px;border-radius:var(--rsm);font-size:13px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--mid);font-family:inherit;transition:all .15s}
.att-btn.present{background:#D8F3DC;border-color:var(--brand-l);color:var(--brand)}
.att-btn.absent{background:#FDDCCC;border-color:var(--accent-l);color:var(--accent)}

/* ============================================================
   PRAYER WALL
   ============================================================ */
.prayer-item{padding:14px 0;border-bottom:1px solid var(--border)}
.prayer-item:last-child{border-bottom:none}
.prayer-item.answered{background:linear-gradient(135deg,#fffdf5,#fff);border-left:3px solid #F1C40F;padding-left:12px;margin-left:-12px;border-bottom-color:transparent;border-radius:0 var(--rsm) var(--rsm) 0}
.prayer-meta{display:flex;justify-content:space-between;margin-bottom:6px}
.prayer-author{font-size:12px;font-weight:600;color:var(--brand)}
.prayer-date{font-size:12px;color:var(--muted)}
.prayer-text{font-size:14px;color:var(--text);line-height:1.6;margin-bottom:10px}
.prayer-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.pray-btn{background:transparent;border:none;font-size:13px;color:var(--muted);cursor:pointer;padding:4px 10px;border-radius:20px;transition:all .18s;font-family:inherit}
.pray-btn:hover,.pray-btn.prayed{background:var(--brand-p);color:var(--brand)}
.pray-count{font-size:12px;color:var(--muted)}

/* ============================================================
   SCHEDULE / POLL
   ============================================================ */
.poll-slot{background:#fff;border:1.5px solid var(--border);border-radius:var(--rsm);padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px}
.poll-slot.voted{border-color:var(--brand-l);background:var(--brand-p)}
.poll-bar-wrap{flex:1}
.poll-bar-label{font-size:13px;font-weight:500;color:var(--dark);margin-bottom:5px}
.poll-bar-bg{height:6px;background:var(--bg);border-radius:3px}
.poll-bar-fill{height:100%;border-radius:3px;background:var(--brand-l);transition:width .4s}
.poll-count{font-size:12px;color:var(--muted);margin-top:4px}
.poll-vote{padding:7px 14px;border-radius:var(--rsm);font-size:13px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--mid);font-family:inherit;transition:all .15s;flex-shrink:0}
.poll-vote.voted{background:var(--brand);color:#fff;border-color:var(--brand)}

/* ============================================================
   INVITE CODE DISPLAY
   ============================================================ */
.invite-card{background:var(--brand-p);border:1.5px solid var(--brand-l);border-radius:var(--r);padding:20px 22px;margin-bottom:18px}
.invite-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--brand);margin-bottom:8px}
.invite-code{font-size:30px;font-weight:700;color:var(--brand);letter-spacing:3px;margin-bottom:10px;font-family:'DM Sans',sans-serif}
.invite-note{font-size:13px;color:var(--mid);margin-bottom:12px;line-height:1.5}

/* ============================================================
   MODAL
   ============================================================ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal-box{background:#fff;border-radius:20px;padding:32px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 24px 64px rgba(0,0,0,.2)}
.modal-close{position:absolute;top:16px;right:16px;background:transparent;border:none;font-size:20px;color:var(--muted);cursor:pointer;line-height:1;padding:4px}
.modal-close:hover{color:var(--dark)}
.modal-title{font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark);margin-bottom:4px}
.modal-sub{font-size:14px;color:var(--muted);margin-bottom:20px;line-height:1.5}
.modal-divider{border:none;border-top:1px solid var(--border);margin:18px 0}
.modal-box h2{font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark);margin-bottom:18px}

/* ============================================================
   TOAST
   ============================================================ */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--dark);color:#fff;padding:12px 22px;border-radius:30px;font-size:14px;font-weight:500;z-index:2000;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ============================================================
   EMPTY STATES
   ============================================================ */
.empty{text-align:center;padding:52px 24px}
.empty-em{font-size:48px;margin-bottom:16px}
.empty-title{font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark);margin-bottom:10px}
.empty-body{font-size:14px;color:var(--muted);line-height:1.7;max-width:380px;margin:0 auto 22px}

/* ============================================================
   INFO BANNERS
   ============================================================ */
.banner{border-radius:var(--rsm);padding:14px 16px;font-size:13px;line-height:1.6;margin-bottom:16px}
.banner-green{background:var(--brand-p);color:var(--mid);border:1px solid var(--brand-l)}
.banner-orange{background:#FFF3E0;color:#8B4513;border:1px solid #FDDCCC}

/* ============================================================
   MOBILE RESPONSIVE
   ============================================================ */
.hamburger{display:none;background:transparent;border:none;cursor:pointer;padding:6px;border-radius:var(--rsm);flex-direction:column;gap:5px;align-items:center;justify-content:center}
.hamburger span{display:block;width:22px;height:2px;background:var(--dark);border-radius:2px;transition:all .25s}
.hamburger:hover span{background:var(--brand)}
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100}
.mob-overlay.open{display:block}

@media (max-width: 768px) {
  /* Hide desktop sidebar */
  .sidebar{display:none;position:fixed;left:0;top:0;height:100vh;z-index:200;transform:translateX(-100%);transition:transform .28s ease}
  .sidebar.mob-open{display:flex;transform:translateX(0)}

  /* Show hamburger in topbar */
  .hamburger{display:flex}

  /* Full-width main */
  #s-app.active{flex-direction:column}
  .main{width:100%;min-height:100vh}

  /* Tighter content padding */
  #page-content{padding:16px}
  .topbar{padding:12px 16px}
  .topbar h1{font-size:18px}

  /* Stack grids on small screens */
  .g2,.g3,.g4{grid-template-columns:1fr 1fr}
  .g4{grid-template-columns:1fr 1fr}

  /* Cards */
  .card{padding:16px;border-radius:12px}

  /* Milestone grid */
  .badge-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}

  /* Login card */
  .lcard{padding:32px 24px}

  /* Modal */
  .modal-overlay{align-items:flex-end;padding:0}
  .modal-box{border-radius:20px 20px 0 0;max-height:92vh;padding:28px 20px}
}

@media (max-width: 480px) {
  .g2,.g3,.g4{grid-template-columns:1fr}
  .btn-row{flex-direction:column}
  .topbar{padding:10px 14px}
  #page-content{padding:12px}
  .mhero{padding:18px}
  .mhero-title{font-size:20px}
  .iq-text{font-size:17px}
}

/* ============================================================
   UTILS
   ============================================================ */
.mb-0{margin-bottom:0!important}
.mt-10{margin-top:10px}
.mt-16{margin-top:16px}
.text-muted{color:var(--muted)}
.text-brand{color:var(--brand)}
.bold{font-weight:600}
hr.divider{border:none;border-top:1px solid var(--border);margin:18px 0}
</style>
</head>

<body>

<!-- ============================================================
     SCREEN: LOGIN / SIGNUP
     ============================================================ -->
<div class="screen active" id="s-login">
  <div class="lcard">

    <!-- Sign In View -->
    <div id="v-signin">
      <div class="llogo">groupify</div>
      <div class="ltag">small groups, made simpler</div>
      <div class="fg"><label>email</label><input type="email" id="si-email" placeholder="you@email.com" autocomplete="email"></div>
      <div class="fg"><label>password</label><input type="password" id="si-pw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
      <button class="btn btn-p btn-full" id="si-btn" onclick="doSignIn()">sign in</button>
      <div class="lswitch">don't have an account? <a onclick="showView('v-ca1')">create one</a></div>
      <div class="demo-sep">
        <p>or try a demo account</p>
        <button class="demo-btn" onclick="loginDemo('ministry')">‚õ™ demo ‚Äî ministry leader</button>
        <button class="demo-btn" onclick="loginDemo('leader')">üë• demo ‚Äî group leader</button>
        <button class="demo-btn" onclick="loginDemo('member')">üôã demo ‚Äî group member</button>
      </div>
    </div>

    <!-- Signup Step 1: Role -->
    <div id="v-ca1" style="display:none">
      <div class="llogo" style="font-size:34px;margin-bottom:4px">groupify</div>
      <div class="ltag">create your account</div>
      <div class="step-dots">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
        <div class="step-dot" id="dot3"></div>
      </div>
      <div style="font-size:15px;font-weight:600;color:var(--dark);margin-bottom:14px">what's your role?</div>
      <div class="role-grid">
        <div class="role-opt" id="ro-ministry" onclick="pickRole('ministry')">
          <div class="role-opt-em">‚õ™</div>
          <div><div class="role-opt-title">ministry leader</div><div class="role-opt-sub">oversee multiple groups, view stats & health</div></div>
        </div>
        <div class="role-opt" id="ro-leader" onclick="pickRole('leader')">
          <div class="role-opt-em">üë•</div>
          <div><div class="role-opt-title">group leader</div><div class="role-opt-sub">lead a small group, track meetings & members</div></div>
        </div>
        <div class="role-opt" id="ro-member" onclick="pickRole('member')">
          <div class="role-opt-em">üôã</div>
          <div><div class="role-opt-title">group member</div><div class="role-opt-sub">join a group, pray, connect & grow together</div></div>
        </div>
      </div>
      <button class="btn btn-p btn-full" onclick="caStep2()">continue ‚Üí</button>
      <div class="lswitch">already have an account? <a onclick="showView('v-signin')">sign in</a></div>
    </div>

    <!-- Signup Step 2: Info -->
    <div id="v-ca2" style="display:none">
      <div class="llogo" style="font-size:34px;margin-bottom:4px">groupify</div>
      <div class="ltag">create your account</div>
      <div class="step-dots">
        <div class="step-dot" id="dot1b"></div>
        <div class="step-dot active" id="dot2b"></div>
        <div class="step-dot" id="dot3b"></div>
      </div>
      <div class="fg"><label>first name</label><input type="text" id="ca-fname" placeholder="first name" autocomplete="given-name"></div>
      <div class="fg"><label>last name</label><input type="text" id="ca-lname" placeholder="last name" autocomplete="family-name"></div>
      <div class="fg"><label>email</label><input type="email" id="ca-email" placeholder="you@email.com" autocomplete="email"></div>
      <div class="fg"><label>password</label><input type="password" id="ca-pw" placeholder="at least 8 characters" autocomplete="new-password"></div>
      <div class="fg"><label>confirm password</label><input type="password" id="ca-pw2" placeholder="confirm your password" autocomplete="new-password"></div>
      <div class="btn-row">
        <button class="btn btn-g" onclick="showView('v-ca1')">‚Üê back</button>
        <button class="btn btn-p btn-full" onclick="caStep3()">continue ‚Üí</button>
      </div>
      <div class="lswitch">already have an account? <a onclick="showView('v-signin')">sign in</a></div>
    </div>

    <!-- Signup Step 3: Context (varies by role) -->
    <div id="v-ca3" style="display:none">
      <div class="llogo" style="font-size:34px;margin-bottom:4px">groupify</div>
      <div class="ltag">create your account</div>
      <div class="step-dots">
        <div class="step-dot" id="dot1c"></div>
        <div class="step-dot" id="dot2c"></div>
        <div class="step-dot active" id="dot3c"></div>
      </div>
      <div id="ca3-body"></div>
      <div class="btn-row" style="margin-top:16px">
        <button class="btn btn-g" onclick="showView('v-ca2')">‚Üê back</button>
        <button class="btn btn-p btn-full" id="ca-finish-btn" onclick="caFinish()">create account üéâ</button>
      </div>
      <div class="lswitch">already have an account? <a onclick="showView('v-signin')">sign in</a></div>
    </div>

    <!-- Email Confirmation Notice -->
    <div id="v-confirm" style="display:none;text-align:center;padding:12px 0">
      <div style="font-size:48px;margin-bottom:16px">üì¨</div>
      <div style="font-family:'DM Serif Display',serif;font-size:22px;color:var(--dark);margin-bottom:10px">check your email!</div>
      <div style="font-size:14px;color:var(--muted);line-height:1.7;margin-bottom:22px">we sent a confirmation link to your email address. click it to activate your account, then sign in.</div>
      <button class="btn btn-p btn-full" onclick="showView('v-signin')">go to sign in ‚Üí</button>
    </div>

  </div>
</div>

<!-- ============================================================
     SCREEN: APP
     ============================================================ -->
<div class="screen" id="s-app">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sb-logo">groupify<small id="sb-role-lbl">loading...</small></div>
    <div class="sb-user">
      <div class="u-av" id="sb-av">?</div>
      <div><div class="u-name" id="sb-name">...</div><div class="u-role" id="sb-role">...</div></div>
    </div>
    <nav class="sb-nav" id="sb-nav"></nav>
    <div class="sb-foot">

      <button class="btn btn-g btn-sm" onclick="doLogout()" style="width:100%;border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.5)">sign out</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <button class="hamburger" id="hamburger" onclick="openMobNav()" aria-label="open menu">
          <span></span><span></span><span></span>
        </button>
        <h1 id="page-title">home</h1>
      </div>
      <div id="topbar-actions"></div>
    </div>
    <div id="page-content"></div>
  </div>

</div>

<!-- MOBILE NAV OVERLAY -->
<div class="mob-overlay" id="mob-overlay" onclick="closeMobNav()"></div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="modalClickOutside(event)">
  <div class="modal-box" id="modal-box"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
'use strict';

/* ============================================================
   SUPABASE
   ============================================================ */
const SUPA_URL = 'https://yhwiabbbbzudtjknzzbl.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlod2lhYmJiYnp1ZHRqa256emJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTY4NjgsImV4cCI6MjA4NzYzMjg2OH0.P_86ElyvMF2q6HXlrmvhbbo-txcnnXKXckcYsGk_Ocs';
var sb;
try { sb = supabase.createClient(SUPA_URL, SUPA_KEY); } catch(e) { console.error('Supabase init failed:', e); }

/* ============================================================
   APP STATE
   ============================================================ */
var DEMO = false;   // true when using a demo account
var CU   = null;   // current user object
var GD   = null;   // group data object
var caRole = null; // selected role during signup

// Current user shape:
// { id, name, init, email, type:'ministry'|'leader'|'member',
//   role:'ministry leader'|'group leader'|'group member',
//   groupId, ministryId, churchName, groupCode, minCode, groupResources:[], placeholderMembers:[] }

// Group data shape:
// { name, start, next:{day,time,loc,freq}, study, hw, stats:{meetings,answered,books} }

/* ============================================================
   PHASE 2 FEATURE IDEAS (not yet built ‚Äî save for future)
   ============================================================
   - Spirit-Led milestones (code preserved, hidden for now)
   - Group discovery: members looking to join can browse open groups
   - Buy Me a Coffee / Venmo tip link for the app creator
   - Group social feed: members post photos & status updates,
     building a shared history/timeline just for the group
   - "Contact ministry leader" button: group leaders/members can
     email or message their ministry leader directly
   - "Report a bug" feature: a way for users to submit bug reports
     directly to the site owner/admin (e.g. via email or a form service)
   ============================================================ */

/* ============================================================
   DEMO DATA
   ============================================================ */
var DEMO_GROUPS = [
  {n:'Thursday Night Crew',h:87,lm:'3 days ago',members:6},
  {n:'Young Couples',h:72,lm:'1 week ago',members:8},
  {n:'Sunday Morning Men',h:91,lm:'5 days ago',members:5},
  {n:'Women of Faith',h:65,lm:'2 weeks ago',members:7},
  {n:'College Life',h:58,lm:'10 days ago',members:9}
];

var DEMO_MEMBERS = [
  {n:'Marcus Thompson',r:'leader',i:'MT',real:true},
  {n:'Jenna Thompson',r:'co-leader',i:'JT',real:true},
  {n:'Derek Richards',r:'host',i:'DR',real:true},
  {n:'Amy Chen',r:'prayer coordinator',i:'AC',real:true},
  {n:'Chris Wallace',r:'study coordinator',i:'CW',real:false}
];

var DEMO_PRAYERS = [
  {id:1,au:'Marcus T.',txt:'Praying for my mom\'s surgery next week. Would love the group to pray with us.',dt:'2 days ago',ans:false,cnt:4,prayed:false},
  {id:2,au:'Amy C.',txt:'Praise! Got the job offer I\'ve been praying about for months. God is faithful!',dt:'5 days ago',ans:true,cnt:7,prayed:true},
  {id:3,au:'Derek R.',txt:'My brother is going through a rough season. Please keep him in your prayers.',dt:'1 week ago',ans:false,cnt:3,prayed:false}
];

// MINISTRY_RESOURCES: shared across all views. Ministry leaders add/remove here.
// Starts with demo data in demo mode; starts empty for real accounts (populated on add).
var MINISTRY_RESOURCES = [
  {id:'mr1',type:'Video Series',title:'The Chosen - Season 1',desc:'Watch and discuss the life of Jesus through the eyes of those who knew him.',tags:['jesus','community','video','discussion','film']},
  {id:'mr2',type:'Bible Study',title:'Emotionally Healthy Spirituality',desc:'Discover the connection between emotional health and spiritual maturity.',tags:['growth','emotions','spiritual','health','relationships']},
  {id:'mr3',type:'Book',title:'The Ruthless Elimination of Hurry',desc:'A modern guide to slowing down and living fully in the pace of Jesus.',tags:['rest','rhythm','spiritual','pace','presence']}
];
// For real (non-demo) accounts, start with an empty list
var REAL_MINISTRY_RESOURCES = [];

function getMinistryResources(){
  return DEMO ? MINISTRY_RESOURCES : REAL_MINISTRY_RESOURCES;
}

var DEMO_GD = {
  name:'Thursday Night Crew',start:'2022-09-08',
  next:{day:'Thursday',date:'2026-03-05',time:'7:30 PM',loc:'Marcus & Jenna\'s',freq:'weekly'},
  study:'James: Faith That Works',hw:'Read chapters 3-4. Journal about a time your words caused unintended harm.',
  stats:{meetings:48,answered:12,books:6}
};

// PRAYERS ‚Äî starts with demo data in demo mode, empty for real accounts
var PRAYERS = [];
var votedSlots = new Set([2]);

/* ============================================================
   ICEBREAKER QUESTIONS
   ============================================================ */
var IQ = [
  'What is one thing you are grateful for this week that you almost overlooked?',
  'What is a memory from childhood that shaped who you are today?',
  'If you could have dinner with anyone in history, who would it be and why?',
  'What is something God has been teaching you lately?',
  'What is a dream or goal you have not told many people about?',
  'What is the best piece of advice you have ever received?',
  'What does rest look like for you - and are you getting enough of it?',
  'What book, podcast, or message has impacted you most in the last year?',
  'Where do you feel most alive and like yourself?',
  'What is one thing you wish others understood about you?',
  'When did you last feel genuinely surprised by God?',
  'What does your prayer life look like right now - honestly?',
  'What is something you are currently struggling with that the group could pray for?',
  'What is a verse or truth you keep coming back to in this season?',
  'Who in your life right now needs someone to show up for them?',
  'What did you want to be when you grew up, and how did that change?',
  'If your life had a theme song right now, what would it be and why?',
  'What is one habit or rhythm that has made your faith feel more alive?',
  'What is something you have changed your mind about in the last few years?',
  'How have you seen God work in an unexpected way recently?'
];

/* ============================================================
   MEMBER ROLES
   ============================================================ */
var MEMBER_ROLES = ['group member','leader','co-leader','prayer coordinator','service coordinator','study coordinator','host','social coordinator'];

/* ============================================================
   ASSESSMENT QUESTIONS
   ============================================================ */
// AQ is the active question set ‚Äî ministry leaders can edit it
var AQ_DEFAULT = [
  {q:'How connected do you feel to the other members of your group?',lo:'distant',hi:'deeply connected'},
  {q:'How safe do you feel sharing honestly about your life in this group?',lo:'unsafe',hi:'completely safe'},
  {q:'How engaged is your group in studying scripture together?',lo:'minimal',hi:'fully engaged'},
  {q:'How well does your group support each other through hard times?',lo:'not much',hi:'always there'},
  {q:'How likely are you to invite a friend to join this group?',lo:'not likely',hi:'definitely'}
];
var AQ = JSON.parse(JSON.stringify(AQ_DEFAULT));
var asmAnswers = {};
var lastHealthScore = 0;

/* ============================================================
   BADGES / MILESTONES
   ============================================================ */
// Milestone structure:
// type: 'meetings' | 'years' | 'prayers' | 'answered' | 'books' | 'health' | 'serving' | 'special'
// threshold: the value needed to earn it (for stat-based types)
// e: earned (computed at runtime based on actual stats)
var ALL_MILESTONES = [
  // --- MEETINGS ---
  {em:'üå±',n:'first meeting',       d:'held your very first group meeting',         type:'meetings',  threshold:1},
  {em:'üî•',n:'5 meetings',          d:'five meetings strong!',                      type:'meetings',  threshold:5},
  {em:'üîü',n:'10 meetings',         d:'double digits ‚Äî you\'re a real group now',   type:'meetings',  threshold:10},
  {em:'üìÖ',n:'25 meetings',         d:'25 meetings together',                       type:'meetings',  threshold:25},
  {em:'üèÖ',n:'50 meetings',         d:'50 meetings ‚Äî half a century!',              type:'meetings',  threshold:50},
  {em:'üíØ',n:'100 meetings',        d:'100 group meetings together',                type:'meetings',  threshold:100},
  {em:'üöÄ',n:'200 meetings',        d:'200 meetings and still going',               type:'meetings',  threshold:200},
  {em:'‚ö°',n:'365 meetings',        d:'a meeting a week for seven full years',      type:'meetings',  threshold:365},

  // --- TIME TOGETHER ---
  {em:'üóìÔ∏è',n:'1 year strong',       d:'celebrating one full year together',         type:'years',     threshold:1},
  {em:'üéâ',n:'3 years together',    d:'three incredible years doing life together', type:'years',     threshold:3},
  {em:'‚ù§Ô∏è',n:'5 year family',       d:'five years ‚Äî you\'re family now',            type:'years',     threshold:5},
  {em:'üå≥',n:'10 year legacy',      d:'a decade of community ‚Äî truly rare',         type:'years',     threshold:10},
  {em:'üëë',n:'generational group',  d:'15+ years of faithfulness together',         type:'years',     threshold:15},

  // --- PRAYER ---
  {em:'üôè',n:'first prayer',        d:'first prayer request shared',                type:'prayers',   threshold:1},
  {em:'üí¨',n:'10 prayers',          d:'10 prayer requests submitted',               type:'prayers',   threshold:10},
  {em:'üïäÔ∏è',n:'25 prayers',         d:'25 prayers lifted up together',              type:'prayers',   threshold:25},
  {em:'üìø',n:'50 prayers',          d:'50+ prayers submitted ‚Äî prayer warriors!',   type:'prayers',   threshold:50},
  {em:'üîî',n:'100 prayers',         d:'100 prayer requests shared as a group',      type:'prayers',   threshold:100},
  {em:'üåä',n:'250 prayers',         d:'250 prayers ‚Äî a river of intercession',      type:'prayers',   threshold:250},

  // --- ANSWERED PRAYER ---
  {em:'‚ú®',n:'first answered prayer',d:'your first prayer marked as answered',      type:'answered',  threshold:1},
  {em:'üåü',n:'5 answered prayers',  d:'five prayers answered and celebrated',       type:'answered',  threshold:5},
  {em:'üéØ',n:'dozen answered',      d:'12 answered prayers logged ‚Äî God is good!',  type:'answered',  threshold:12},
  {em:'üåà',n:'25 answered',         d:'25 answered prayers and counting',           type:'answered',  threshold:25},
  {em:'üèÜ',n:'50 answered',         d:'50 answered prayers ‚Äî a legacy of faith',    type:'answered',  threshold:50},

  // --- BOOKS / STUDIES ---
  {em:'üìñ',n:'first study',         d:'completed your first book or study',         type:'books',     threshold:1},
  {em:'üìö',n:'3 studies',           d:'three studies completed together',           type:'books',     threshold:3},
  {em:'üåç',n:'6 books',             d:'six books of the Bible studied',             type:'books',     threshold:6},
  {em:'üß†',n:'12 books',            d:'twelve studies ‚Äî a year\'s worth of depth',  type:'books',     threshold:12},
  {em:'üéì',n:'26 books',            d:'26 studies ‚Äî half the New Testament!',       type:'books',     threshold:26},
  {em:'üèõÔ∏è',n:'66 books',            d:'all 66 books of the Bible studied',          type:'books',     threshold:66},

  // --- HEALTH ---
  {em:'üíö',n:'health check',        d:'completed your first group health assessment', type:'health',  threshold:60},
  {em:'‚≠ê',n:'healthy group',       d:'scored 75+ on a group health check-in',       type:'health',  threshold:75},
  {em:'üèÜ',n:'health champion',     d:'scored 90+ on a group health check-in',       type:'health',  threshold:90},
  {em:'üíé',n:'elite community',     d:'scored 95+ on a group health check-in',       type:'health',  threshold:95},

  // --- SERVING ---
  {em:'ü´∂',n:'first serve',          d:'completed your first service project together',  type:'serving',   threshold:null},
  {em:'üõ†Ô∏è',n:'hands and feet',       d:'served together 3 times',                        type:'serving',   threshold:null},
  {em:'üå±',n:'seeds planted',        d:'five service projects completed',                type:'serving',   threshold:null},
  {em:'üèòÔ∏è',n:'community builders',   d:'served your local community 10 times',           type:'serving',   threshold:null},
  {em:'üåç',n:'beyond our walls',     d:'served a cause beyond your neighborhood',        type:'serving',   threshold:null},
  {em:'üî•',n:'on mission',           d:'made serving a regular rhythm of your group',    type:'serving',   threshold:null},

  // --- SPIRIT-LED (phase 2) ---
  {em:'üïØÔ∏è',n:'lit a candle',        d:'prayed for someone outside the group',       type:'special',  threshold:null},
  {em:'ü§ù',n:'open door',           d:'welcomed a new member into the group',       type:'special',  threshold:null},
  {em:'üåø',n:'new roots',           d:'hosted your first meeting',                  type:'special',  threshold:null},
  {em:'üé§',n:'story shared',        d:'a member shared their testimony',            type:'special',  threshold:null},
  {em:'üåè',n:'kingdom minded',      d:'prayed together for a global cause',         type:'special',  threshold:null},
  {em:'üéÅ',n:'generous hearts',     d:'served or gave together as a group',         type:'special',  threshold:null},
  {em:'üß©',n:'fully committed',     d:'every member attended the same meeting',     type:'special',  threshold:null},
  {em:'üì£',n:'word got out',        d:'a member invited a friend to the group',     type:'special',  threshold:null}
];

// Compute which milestones are earned and which are visible (progressive reveal)
// Track special badge earned state separately so it persists across redraws
var specialEarned = {};

function computeMilestones(stats, years, healthScore){
  var m=stats.meetings||0, a=stats.answered||0, b=stats.books||0;
  var p=PRAYERS.length;
  var h=healthScore||0;

  var byType={};
  ALL_MILESTONES.forEach(function(ms){
    if(!byType[ms.type]) byType[ms.type]=[];
    byType[ms.type].push(ms);
  });

  var result=[];
  Object.keys(byType).forEach(function(type){
    var group=byType[type];
    // Manual badge types ‚Äî stored in specialEarned keyed by name
    if(type==='special'||type==='serving'){
      group.forEach(function(ms){
        ms.earned = specialEarned[ms.n] || false;
        result.push(ms);
      });
      return;
    }
    var val= type==='meetings'?m : type==='years'?years : type==='prayers'?p : type==='answered'?a : type==='books'?b : h;
    var earnedCount=0;
    group.forEach(function(ms,i){
      ms.earned = ms.threshold!==null && val >= ms.threshold;
      if(ms.earned) earnedCount=i+1;
    });
    group.forEach(function(ms,i){
      if(ms.earned || i<=earnedCount+1) result.push(ms);
    });
  });
  return result;
}

/* ============================================================
   BIBLE BOOKS (all 66) ‚Äî 5 topic tags each
   ============================================================ */
var BIBLE_BOOKS = [
  {t:'OT',title:'Genesis',desc:'The beginning of all things - creation, the fall, and God\'s covenant with his people.',tags:['creation','covenant','beginnings','identity','family']},
  {t:'OT',title:'Exodus',desc:'God delivers his people from slavery and establishes his covenant at Sinai.',tags:['freedom','covenant','moses','deliverance','law']},
  {t:'OT',title:'Leviticus',desc:'Laws and rituals that set Israel apart as a holy people before God.',tags:['holiness','worship','law','sacrifice','purity']},
  {t:'OT',title:'Numbers',desc:'Israel\'s wilderness journey and the cost of faithlessness.',tags:['wilderness','faithfulness','journey','community','obedience']},
  {t:'OT',title:'Deuteronomy',desc:'Moses\' final words - a call to love God wholeheartedly and obey his commands.',tags:['obedience','love','renewal','covenant','legacy']},
  {t:'OT',title:'Joshua',desc:'God\'s faithfulness as Israel enters and conquers the promised land.',tags:['courage','faithfulness','promise','victory','obedience']},
  {t:'OT',title:'Judges',desc:'A cycle of sin, suffering, and salvation in the days before Israel\'s kings.',tags:['sin','redemption','leadership','cycles','deliverance']},
  {t:'OT',title:'Ruth',desc:'A beautiful story of loyalty, love, and redemption.',tags:['loyalty','redemption','love','faithfulness','family']},
  {t:'OT',title:'1 Samuel',desc:'The rise of Israel\'s monarchy and the calling of King David.',tags:['leadership','calling','trust','kingship','transition']},
  {t:'OT',title:'2 Samuel',desc:'David\'s reign - his triumphs, failures, and God\'s enduring grace.',tags:['grace','failure','kingship','consequences','restoration']},
  {t:'OT',title:'1 Kings',desc:'Solomon\'s wisdom and the divided kingdom.',tags:['wisdom','obedience','leadership','idolatry','consequences']},
  {t:'OT',title:'2 Kings',desc:'The fall of Israel and Judah - a warning about unfaithfulness.',tags:['faithfulness','consequences','history','judgment','exile']},
  {t:'OT',title:'1 Chronicles',desc:'A retelling of Israel\'s history with a focus on worship and the temple.',tags:['worship','history','temple','legacy','identity']},
  {t:'OT',title:'2 Chronicles',desc:'From Solomon\'s glory to the exile - the importance of following God.',tags:['revival','worship','consequences','reform','prayer']},
  {t:'OT',title:'Ezra',desc:'The return from exile and rebuilding of the temple.',tags:['restoration','worship','community','obedience','rebuilding']},
  {t:'OT',title:'Nehemiah',desc:'Rebuilding Jerusalem\'s walls and renewing the covenant community.',tags:['leadership','restoration','prayer','perseverance','community']},
  {t:'OT',title:'Esther',desc:'God\'s providential protection of his people through courage and faith.',tags:['courage','providence','identity','boldness','protection']},
  {t:'OT',title:'Job',desc:'Wrestling with suffering and encountering God\'s sovereignty.',tags:['suffering','sovereignty','faith','questions','endurance']},
  {t:'OT',title:'Psalms',desc:'150 songs of praise, lament, and trust - the prayer book of the Bible.',tags:['worship','prayer','emotion','praise','lament']},
  {t:'OT',title:'Proverbs',desc:'Practical wisdom for everyday life rooted in the fear of the Lord.',tags:['wisdom','practical','character','relationships','choices']},
  {t:'OT',title:'Ecclesiastes',desc:'Searching for meaning and finding that life\'s purpose is rooted in God.',tags:['meaning','purpose','wisdom','contentment','legacy']},
  {t:'OT',title:'Song of Solomon',desc:'A celebration of love, intimacy, and the beauty of relationship.',tags:['love','marriage','relationship','intimacy','beauty']},
  {t:'OT',title:'Isaiah',desc:'Prophecies of judgment and hope - pointing toward the coming Messiah.',tags:['prophecy','hope','messiah','justice','comfort']},
  {t:'OT',title:'Jeremiah',desc:'A prophet\'s heartbreak over Israel\'s unfaithfulness and God\'s coming restoration.',tags:['faithfulness','hope','lament','calling','perseverance']},
  {t:'OT',title:'Lamentations',desc:'Raw grief over Jerusalem\'s destruction and a prayer for God\'s mercy.',tags:['grief','mercy','lament','suffering','hope']},
  {t:'OT',title:'Ezekiel',desc:'Visions of God\'s glory and the promise of a renewed Israel.',tags:['prophecy','restoration','glory','judgment','spirit']},
  {t:'OT',title:'Daniel',desc:'Faithfulness under pressure and God\'s sovereignty over all kingdoms.',tags:['faithfulness','sovereignty','prophecy','courage','prayer']},
  {t:'OT',title:'Hosea',desc:'God\'s unfailing love for an unfaithful people - a picture of grace.',tags:['grace','love','restoration','forgiveness','covenant']},
  {t:'OT',title:'Joel',desc:'A call to repentance and the promise of God\'s Spirit poured out.',tags:['repentance','spirit','restoration','prayer','hope']},
  {t:'OT',title:'Amos',desc:'Justice for the poor and a warning to those who exploit the vulnerable.',tags:['justice','humility','warning','poverty','obedience']},
  {t:'OT',title:'Obadiah',desc:'A short prophecy against pride and a reminder that God defends his people.',tags:['pride','justice','deliverance','humility','nations']},
  {t:'OT',title:'Jonah',desc:'Running from God and discovering his relentless grace and mercy.',tags:['grace','mercy','missions','obedience','repentance']},
  {t:'OT',title:'Micah',desc:'Act justly, love mercy, walk humbly - the heart of what God requires.',tags:['justice','humility','mercy','prophecy','character']},
  {t:'OT',title:'Nahum',desc:'God\'s judgment on Nineveh and comfort for those who trust in him.',tags:['justice','comfort','sovereignty','judgment','trust']},
  {t:'OT',title:'Habakkuk',desc:'Honest questions and deep trust - learning to live by faith.',tags:['faith','trust','questions','suffering','worship']},
  {t:'OT',title:'Zephaniah',desc:'Warning of judgment and the joy of God singing over his people.',tags:['joy','judgment','restoration','hope','singing']},
  {t:'OT',title:'Haggai',desc:'A call to prioritize God\'s house and trust his provision.',tags:['priorities','faithfulness','worship','obedience','provision']},
  {t:'OT',title:'Zechariah',desc:'Visions of hope and the coming King who will reign in peace.',tags:['hope','messiah','prophecy','restoration','vision']},
  {t:'OT',title:'Malachi',desc:'The final Old Testament call to return to God before the coming of Elijah.',tags:['return','faithfulness','giving','covenant','repentance']},
  {t:'NT',title:'Matthew',desc:'Jesus as the fulfillment of Old Testament prophecy - the King has come.',tags:['jesus','kingdom','fulfillment','teaching','discipleship']},
  {t:'NT',title:'Mark',desc:'The action-packed gospel of Jesus - servant, healer, and Son of God.',tags:['jesus','action','servant','miracles','urgency']},
  {t:'NT',title:'Luke',desc:'A careful account of Jesus - his compassion for the poor and the outsider.',tags:['jesus','compassion','grace','prayer','inclusion']},
  {t:'NT',title:'John',desc:'Jesus as the Word of God - believe and have life in his name.',tags:['jesus','belief','eternal life','love','signs']},
  {t:'NT',title:'Acts',desc:'The Holy Spirit-empowered birth and spread of the early church.',tags:['spirit','church','missions','boldness','community']},
  {t:'NT',title:'Romans',desc:'The deep roots of the gospel - grace, faith, and life in the Spirit.',tags:['gospel','grace','theology','salvation','transformation']},
  {t:'NT',title:'1 Corinthians',desc:'Addressing division, gifts, and love in a messy but beloved church.',tags:['love','gifts','unity','church','holiness']},
  {t:'NT',title:'2 Corinthians',desc:'Paul\'s vulnerability and the strength that comes through weakness.',tags:['vulnerability','strength','ministry','suffering','generosity']},
  {t:'NT',title:'Galatians',desc:'Freedom from the law through grace - you are fully loved in Christ.',tags:['grace','freedom','identity','law','spirit']},
  {t:'NT',title:'Ephesians',desc:'The riches of life in Christ and how they shape every relationship.',tags:['identity','unity','relationships','calling','spiritual warfare']},
  {t:'NT',title:'Philippians',desc:'Joy in every circumstance - contentment, peace, and pressing onward.',tags:['joy','contentment','peace','humility','perseverance']},
  {t:'NT',title:'Colossians',desc:'Christ is supreme over all things - let him fill every part of your life.',tags:['christ','supremacy','fullness','theology','transformation']},
  {t:'NT',title:'1 Thessalonians',desc:'Encouragement to live faithfully while waiting for Christ\'s return.',tags:['hope','return','encouragement','holiness','community']},
  {t:'NT',title:'2 Thessalonians',desc:'Standing firm in the faith while awaiting the Day of the Lord.',tags:['perseverance','hope','end times','work','faithfulness']},
  {t:'NT',title:'1 Timothy',desc:'Practical guidance for leading and organizing a healthy church.',tags:['leadership','church','practical','character','doctrine']},
  {t:'NT',title:'2 Timothy',desc:'Paul\'s final charge - preach the word and finish the race strong.',tags:['perseverance','preaching','legacy','courage','mentorship']},
  {t:'NT',title:'Titus',desc:'Sound teaching and godly living in every area of life.',tags:['character','leadership','practical','doctrine','community']},
  {t:'NT',title:'Philemon',desc:'A short letter about forgiveness, reconciliation, and Christian brotherhood.',tags:['forgiveness','reconciliation','grace','equality','relationships']},
  {t:'NT',title:'Hebrews',desc:'Jesus is greater - better covenant, better priest, better hope.',tags:['jesus','faith','perseverance','covenant','worship']},
  {t:'NT',title:'James',desc:'Faith that works - practical Christianity lived out in everyday life.',tags:['faith','works','practical','speech','wisdom']},
  {t:'NT',title:'1 Peter',desc:'Hope and endurance for those suffering for their faith.',tags:['suffering','hope','identity','holiness','submission']},
  {t:'NT',title:'2 Peter',desc:'Guarding against false teaching and growing in grace and knowledge.',tags:['discernment','growth','warning','knowledge','patience']},
  {t:'NT',title:'1 John',desc:'Love one another - walking in the light and assurance of salvation.',tags:['love','assurance','fellowship','truth','obedience']},
  {t:'NT',title:'2 John',desc:'A brief charge to walk in love and truth and guard against deception.',tags:['truth','love','discernment','hospitality','warning']},
  {t:'NT',title:'3 John',desc:'Encouragement for faithful workers and a warning against pride.',tags:['hospitality','faithfulness','character','truth','community']},
  {t:'NT',title:'Jude',desc:'Contend for the faith and resist those who distort God\'s grace.',tags:['discernment','perseverance','warning','faith','mercy']},
  {t:'NT',title:'Revelation',desc:'The ultimate victory of Christ and the hope of a renewed creation.',tags:['hope','victory','end times','worship','perseverance']}
];

/* ============================================================
   BIBLE STUDIES
   Each book has sessions: { title, reading, questions:[5] }
   Hand-crafted for key books; auto-generated for the rest.
   Ministry leaders can edit any of these in-place.
   ============================================================ */
var BIBLE_STUDIES = {
  'James': {
    sessions:[
      {title:'Faith That Works',reading:'James 1:1‚Äì18',questions:['James says trials produce steadfastness (v.3). Describe a trial in your own life that ultimately grew something good in you ‚Äî what did it produce?','What does it mean practically to "ask God for wisdom" (v.5)? When is the last time you genuinely did that before making a decision?','James contrasts the person who doubts with the person who trusts (v.6‚Äì8). In what area of your life do you find it hardest to fully trust God right now?','Verses 9‚Äì11 flip the world\'s values upside-down ‚Äî the humble is lifted, the rich will fade. How does this challenge the way you think about success or security?','James says every good gift comes from the Father (v.17). What is one gift in your life you\'ve been taking for granted? How can you receive it with more gratitude?']},
      {title:'Doers of the Word',reading:'James 1:19‚Äì2:13',questions:['James tells us to be "quick to hear, slow to speak, slow to anger" (1:19). Which of those three is hardest for you personally, and why?','What does "pure religion" look like according to James 1:27? How does your daily life reflect or fall short of this description?','James takes favoritism very seriously (2:1‚Äì4). What forms does favoritism take in modern life ‚Äî and in the church? Have you ever been on the receiving end of it?','The "royal law" is to love your neighbor as yourself (2:8). Who is your hardest neighbor to love right now, and what would love actually look like toward them?','James says mercy triumphs over judgment (2:13). Share a time when someone showed you mercy when you deserved judgment. How did it change you?']},
      {title:'Faith and Works',reading:'James 2:14‚Äì3:12',questions:['James asks, "Can faith save him?" if it has no works (2:14). What does a living, active faith look like in your everyday week ‚Äî not just on Sundays?','Abraham\'s faith was demonstrated by action (2:21‚Äì23). What is one step of obedience you\'ve been putting off that would be evidence of your faith right now?','James says the tongue is like a small rudder that steers a whole ship (3:3‚Äì4). What patterns in your speech ‚Äî at home, at work, online ‚Äî most need God\'s transformation?','He says we use the same tongue to praise God and curse people (3:9‚Äì10). Reflect honestly: where does the disconnect show up most in your own speech?','If our words reveal our hearts, what do your most common words reveal about what is really going on inside you?']},
      {title:'Wisdom from Above',reading:'James 3:13‚Äì4:17',questions:['James describes two kinds of wisdom ‚Äî earthly and from above (3:15‚Äì17). Give a real example of each. Which kind are you operating from most in a current situation?','Quarrels come from "passions at war within us" (4:1). What unmet desire or fear tends to show up most in your conflicts with others?','James says we don\'t have because we don\'t ask, or we ask with wrong motives (4:2‚Äì3). How would you honestly describe your current prayer life ‚Äî its frequency and its focus?','The call to "draw near to God" (4:8) is personal and active. What is one concrete step you could take this week to draw nearer to God?','James warns against boasting about tomorrow (4:13‚Äì16). How does a "Lord willing" posture change the way you make plans, have ambitions, and talk about the future?']},
      {title:'Patience and Prayer',reading:'James 5',questions:['James ends with a call to patient waiting (5:7‚Äì8). What are you currently waiting on God for, and how are you doing emotionally in that waiting?','The prayer of a righteous person is "powerful and effective" (5:16). What does Elijah\'s example (5:17‚Äì18) tell you about what kind of person God answers ‚Äî and does that encourage or convict you?','James calls the elders to pray over the sick (5:14‚Äì15). What would it look like for your group to take healing prayer more seriously ‚Äî not as a formula, but as genuine faith?','Confessing sins to one another (5:16) is vulnerable and countercultural. What makes this hard in community, and what would need to be true about your group for it to happen?','James began by talking about trials and ends with restoring those who have wandered (5:19‚Äì20). Who in your life might be wandering that you could gently move toward this week?']}
    ]
  },
  'Philippians': {
    sessions:[
      {title:'Joy in Every Circumstance',reading:'Philippians 1:1‚Äì26',questions:['Paul writes from prison and is genuinely joyful (v.4). What is your honest relationship with joy right now ‚Äî is it present, absent, or something you have to fight for?','Paul says "to live is Christ, to die is gain" (v.21). What does that declaration mean to you personally? Does your life reflect that kind of single-focus?','He says his chains have "advanced the gospel" (v.12). Can you think of a constraint or hardship in your own life that God has used to open unexpected doors?','Paul prays that their love would "abound more and more in knowledge and discernment" (v.9). What is the difference between love that feels good and love that is wise?','How does having an eternal perspective (v.21‚Äì23) change the way you face hard days, disappointments, or unfair situations?']},
      {title:'The Mind of Christ',reading:'Philippians 1:27‚Äì2:18',questions:['Paul urges them to "stand firm in one spirit" (1:27). What does unity in your group, church, or family actually require from you ‚Äî not just in feeling, but in action?','The humility described in 2:3‚Äì4 is radical: consider others more significant than yourself. Where do you feel the most resistance to this in your own life?','The Christ hymn (2:6‚Äì11) describes Jesus going from glory to servant to exalted. What does his downward journey before exaltation say about the way God works in our lives?','Paul says to "work out your salvation with fear and trembling" (2:12). What does this active, ongoing nature of faith look like practically for you in this season?','He calls them to shine as lights in a crooked generation (2:15). Where in your daily life do you have the most opportunity to be a visible light right now?']},
      {title:'Pressing Forward',reading:'Philippians 3',questions:['Paul lists his impressive credentials and calls them "rubbish" compared to knowing Christ (3:8). What things do you tend to put your confidence in that might need the same reclassification?','He says he hasn\'t arrived but presses on (3:12‚Äì14). What does "pressing on" look like for you spiritually in this current season? What are you reaching toward?','Paul warns about people whose "god is their belly" and whose minds are on earthly things (3:19). What earthly thing most competes for your attention and heart right now?','Our citizenship is in heaven (3:20). How does that truth change how you relate to culture, politics, and the pursuit of comfort and belonging here?','Who in your life models the kind of mature faith Paul describes in this chapter? What specific quality in them do you want to imitate?']},
      {title:'The Peace That Passes Understanding',reading:'Philippians 4',questions:['Paul says to "rejoice always" (4:4) ‚Äî not sometimes. Is there a circumstance in your life right now where rejoicing feels impossible? What would it look like to try anyway?','"Be anxious for nothing" (4:6) is one of the most challenging commands in Scripture. What are you most anxious about right now, and have you brought it to God in prayer with thanksgiving?','The peace that "passes understanding" (4:7) is supernatural. Share a time when you experienced a peace that didn\'t make logical sense given your circumstances.','Verse 8 gives us a mental diet ‚Äî whatever is true, noble, right, pure, lovely. Honestly, what are you feeding your mind most consistently through media and thought patterns?','Paul says he has learned contentment in all circumstances (4:11). What is the hardest situation in which you need to learn contentment right now, and what would that look like?']}
    ]
  },
  'Romans': {
    sessions:[
      {title:'The Gospel We Need',reading:'Romans 1:1‚Äì32',questions:['Paul says he is "not ashamed of the gospel" (v.16). When do you find yourself most tempted to water it down, avoid it, or be embarrassed by it?','The gospel reveals "the righteousness of God" (v.17). Before you knew the gospel, what did you think righteousness meant? How has that understanding changed?','Paul says humanity has "exchanged the glory of God" for lesser things (v.23). What are the modern equivalents of this exchange ‚Äî what do people (and you) tend to worship instead of God?','The list in 1:29‚Äì31 is uncomfortable because it\'s so recognizable. Which items on that list do you see most commonly celebrated in culture today?','If everyone has seen evidence of God in creation (v.20) and is without excuse, how does that shape your approach to sharing your faith with people who claim they\'ve never encountered God?']},
      {title:'No One Is Righteous',reading:'Romans 2:1‚Äì3:31',questions:['Romans 2:1 says that when we judge others we condemn ourselves because we do the same things. Where do you most judge others for things you are guilty of yourself?','Paul describes a person who knows the law perfectly but doesn\'t live it (2:17‚Äì24). What is the gap between your stated beliefs and your actual daily life?','The real Jew, Paul says, is one who is inwardly transformed (2:28‚Äì29). What does inward transformation ‚Äî rather than outward performance ‚Äî look like in practice for you?','"All have sinned and fall short" (3:23) puts every human on equal footing. How does this truth change the way you look at people you consider very different from you ‚Äî morally, socially, spiritually?','Justification is a gift through Jesus (3:24). Do you tend to live as someone who has received this gift freely, or do you still function as though you need to earn it?']},
      {title:'Justified by Faith',reading:'Romans 4‚Äì5',questions:['Abraham believed God and it was credited as righteousness (4:3) ‚Äî before circumcision or the law. What does this tell us about how faith has always worked in God\'s economy?','Romans 4:18 says Abraham hoped "against hope." Describe a situation in your own life where you have had to hope against hope. What kept you going?','Paul says suffering produces perseverance ‚Üí character ‚Üí hope (5:3‚Äì4). Looking back, where have you seen this progression actually work itself out in your life?','"While we were still sinners, Christ died for us" (5:8). How does the timing of this gift ‚Äî before we cleaned up, before we believed ‚Äî affect how you receive and extend grace to others?','Adam brought sin and death; Christ brought grace and life (5:15‚Äì17). In what ways do you still live under Adam\'s story rather than Christ\'s?']},
      {title:'Dead to Sin, Alive to God',reading:'Romans 6‚Äì7',questions:['We are "dead to sin" (6:2) ‚Äî yet we don\'t always feel dead to it. What is the difference between positional truth and experiential reality, and how do you close that gap?','Paul says we are "slaves" to whatever we obey (6:16). What do your patterns of behavior reveal about what actually has mastery over you?','Romans 7:15 ‚Äî "I do not do what I want, but I do the very thing I hate" ‚Äî is one of the most honest verses in Scripture. Where do you most identify with this struggle right now?','Paul\'s anguished "Who will deliver me?" (7:24) is met immediately with "Thanks be to God through Jesus Christ" (7:25). How does the gospel interrupt your spiral of self-condemnation?','If the law could diagnose the problem but not fix it (7:7‚Äì12), what does that tell us about the limits of rules, willpower, and behavior modification as tools for transformation?']},
      {title:'Life in the Spirit',reading:'Romans 8',questions:['There is "no condemnation" for those in Christ (8:1). Is condemnation ‚Äî from God, from others, or from yourself ‚Äî something you still carry? What would it look like to set it down?','The Spirit who raised Jesus from the dead lives in you (8:11). What does it mean practically to live by that power rather than by willpower?','"All things work together for good" (8:28) is not a promise that all things are good, but that God works through them. Share an example from your life where you have seen this.','Nothing can separate us from the love of God (8:38‚Äì39). What things tend to make you feel most separated or distant from God ‚Äî and how does this passage answer that?','Romans 8 moves from "no condemnation" to "nothing can separate us." What would it look like to live with that kind of settled security in your identity this week?']},
      {title:'Living Sacrifices',reading:'Romans 12‚Äì15',questions:['Offer your body as a "living sacrifice" (12:1) ‚Äî holy and pleasing to God. What does daily, bodily surrender look like in your actual schedule, habits, and choices?','Don\'t be conformed to the world; be transformed by the renewing of your mind (12:2). Where is your mind most shaped by the world\'s categories right now?','Romans 12:9‚Äì21 is a portrait of love in action. Which item on that list feels most natural to you, and which feels most foreign?','Paul says to "bless those who persecute you" and "not repay evil for evil" (12:14,17). Bring a real situation to mind. How does this instruction land?','Chapters 14‚Äì15 are about strong and weak believers getting along. Where does your group or church have the most tension around secondary issues, and how do these chapters speak to it?']}
    ]
  },
  'John': {
    sessions:[
      {title:'The Word Became Flesh',reading:'John 1',questions:['John opens with "In the beginning was the Word" ‚Äî deliberately echoing Genesis 1. What does it mean to you that creation and redemption have the same author?','Jesus is described as "the true light, which gives light to everyone" (v.9). What does that mean for people who have never heard the gospel explicitly?','John the Baptist said "He must increase, but I must decrease" (3:30, though implied here in 1:27). Where in your life do you most need to make more room for Jesus and less for yourself?','Philip simply said "Come and see" (v.46) to Nathanael\'s skepticism. Who in your life could you invite to simply "come and see" ‚Äî without needing to have all the answers first?','Jesus called his first disciples with two words: "Follow me" (v.43). What does following Jesus cost you in your specific context right now ‚Äî relationally, professionally, or personally?']},
      {title:'Signs and New Birth',reading:'John 2‚Äì3',questions:['At the wedding in Cana, Jesus\' first miracle was providing more wine at a party (2:1‚Äì11). What does this tell you about the kind of God Jesus reveals ‚Äî and does it match your mental picture of him?','The temple cleansing (2:13‚Äì22) shows a passionate, confrontational Jesus. Are you more comfortable with the gentle Jesus or this Jesus? What does that preference reveal?','Nicodemus came "at night" (3:2). What are the things in your life that you tend to bring to Jesus only in private, or that you\'re reluctant to be seen as needing?','Jesus says you must be "born of water and Spirit" (3:5). What evidence in your life shows that a spiritual rebirth has happened ‚Äî that you are a genuinely new person?','"God so loved the world" (3:16) ‚Äî the whole world. How does the scope of God\'s love challenge the limits you put on who deserves grace, mercy, or the gospel?']},
      {title:'Living Water',reading:'John 4‚Äì5',questions:['The woman at the well had five husbands (4:18) and Jesus initiated a conversation with her ‚Äî crossing every social boundary of the day. Who are the people in your life that you might be avoiding in similar ways?','Jesus offered her "living water" so she would never thirst again (4:14). What are the things you currently run to for satisfaction that leave you thirsty again? What does it look like to drink from Jesus instead?','The disciples were surprised Jesus was talking to a woman (4:27). How do your cultural assumptions about who matters or who is worth your time get challenged by Jesus\' example?','Jesus healed a man who had been sick for 38 years (5:5). He asked, "Do you want to be healed?" Is there a place in your life where you\'re not sure you actually want to change?','The religious leaders persecuted Jesus for healing on the Sabbath (5:16). Where do you see religious routine or rule-keeping being valued more than actual human flourishing?']},
      {title:'Bread of Life',reading:'John 6',questions:['After feeding 5,000, the crowd followed Jesus for more bread (6:26). What are your primary motivations for following Jesus ‚Äî and are they focused on his gifts or on him?','"I am the bread of life" (6:35). What would it mean practically to come to Jesus and not hunger? What does it look like to make him your daily source rather than a weekly visit?','Many disciples walked away when the teaching got hard (6:66). Jesus asked the twelve, "Do you want to go too?" (6:67). How would you honestly answer that question in your current season?','Peter\'s answer was "Lord, to whom shall we go? You have the words of eternal life" (6:68). Has there been a moment in your faith where you reached a similar conclusion? What brought you there?','The crowd wanted to make Jesus king by force (6:15) on their own terms. Where are you most tempted to follow a version of Jesus who serves your agenda rather than the real one?']},
      {title:'I Am',reading:'John 8‚Äì10',questions:['"I am the light of the world" (8:12) ‚Äî not a light, but the light. What areas of your thinking, decision-making, or relationships most need the light of Jesus right now?','Jesus said the truth will "set you free" (8:32). What truth do you know that you are not yet free from ‚Äî because you know it but haven\'t fully believed or received it?','The Good Shepherd "lays down his life for the sheep" (10:11). How does it change your experience of everyday life to know that your shepherd is not running away, but running toward you?','Jesus said his sheep "know his voice" (10:4). How do you currently practice listening to God? What makes it easy or hard to hear him in the noise of your life?','The Pharisees were trying to stone Jesus and accusing him of blasphemy (10:31‚Äì33). What are the things people most commonly use to dismiss Jesus today ‚Äî and how do you respond?']},
      {title:'Resurrection and Glory',reading:'John 11‚Äì12',questions:['Jesus wept at Lazarus\'s tomb (11:35), even knowing he was about to raise him. What does the fact that Jesus weeps with us ‚Äî not just fix things for us ‚Äî mean for how you bring grief to him?','Martha said "I know he will rise again in the resurrection on the last day" (11:24) ‚Äî true but distant. Jesus replied "I am the resurrection." What is the difference between believing a doctrine and trusting a person?','Mary anointed Jesus\' feet with expensive perfume (12:3). Where in your life are you holding back your most extravagant devotion ‚Äî time, money, reputation ‚Äî from Jesus?','Jesus said "unless a grain of wheat falls into the earth and dies, it remains alone" (12:24). What needs to die in your life right now for something new to grow?','The crowd shouted "Hosanna" on Palm Sunday but called for crucifixion days later (12:13). What are the ways your own praise of Jesus is conditional or circumstantial?']},
      {title:'The Upper Room',reading:'John 13‚Äì14',questions:['Jesus washed his disciples\' feet ‚Äî including Judas (13:1‚Äì17). How does it feel to know that Jesus served someone he knew would betray him? What does that teach us about serving people in our own lives?','The "new commandment" is to love one another as Jesus loved ‚Äî sacrificially, without conditions (13:34). What makes this kind of love different from natural affection, and who in your life are you being called to love this way?','"Let not your hearts be troubled" (14:1) was spoken to people about to experience devastating loss. What does it mean to have peace that is not dependent on circumstances?','Jesus says "I am the way, the truth, and the life" (14:6). The exclusivity of this claim is offensive to many. How do you hold it with both conviction and compassion in conversation?','The promise of the Holy Spirit as "another Helper" (14:16) means the disciples wouldn\'t be alone. How aware are you of the Spirit\'s presence day-to-day? What would it mean to live more consciously with him?']},
      {title:'The Vine and the Resurrection',reading:'John 15‚Äì21',questions:['Jesus says "I am the vine; you are the branches" (15:5). Fruit doesn\'t come from effort ‚Äî it comes from staying connected. What does it look like to "abide" in Jesus in a practical, daily way?','He says "Greater love has no one than this, that someone lay down his life for his friends" (15:13). What is one relationship in your life where love is calling you to a real sacrifice or cost?','Peter denied Jesus three times and Jesus restored him three times (21:15‚Äì19). Have you experienced restoration after failure? What made it possible ‚Äî or what is preventing it for you right now?','Jesus\' final question to Peter was "Do you love me?" ‚Äî not "Are you qualified?" or "Have you fixed your mistakes?" What does this tell you about what Jesus values most?','John says the world couldn\'t contain all the books about what Jesus did (21:25). After studying the Gospel of John, what is the one thing about Jesus that most changes how you see him?']}
    ]
  },
  'Genesis': {
    sessions:[
      {title:'In the Beginning',reading:'Genesis 1:1‚Äì2:25',questions:['God created everything and called it "very good" (1:31). What does it mean for your life to see the physical world ‚Äî your body, your work, the earth ‚Äî as inherently good and worthy of care?','Humans are made in the "image of God" (1:26‚Äì27). What does that mean practically? How does it change the way you see yourself and the people around you ‚Äî especially difficult ones?','God rested on the seventh day (2:2‚Äì3). Rest is built into the fabric of creation. What does Sabbath rest look like in your life right now, and what makes it hard to practice?','The man and woman were "naked and not ashamed" (2:25) ‚Äî complete vulnerability without fear. What would it take for your closest relationships to have that quality? What prevents it?','Creation was spoken into existence by God\'s word (1:3). What does that say about the power of words ‚Äî God\'s and ours ‚Äî to create, shape, and call things into being?']},
      {title:'The Fall and Its Fractures',reading:'Genesis 3‚Äì4',questions:['The serpent\'s first move was to question what God said: "Did God actually say...?" (3:1). Where do you most notice your own internal questioning of what God has clearly said?','Adam and Eve hid from God after sinning (3:8). What do you tend to hide from God, or what makes you want to avoid him when you feel guilty or ashamed?','God\'s response to the fall included both judgment and mercy ‚Äî clothing them (3:21) and promising a redeemer (3:15). What does this dual response tell you about the character of God?','Cain asked "Am I my brother\'s keeper?" (4:9) ‚Äî the oldest attempt to avoid responsibility for others. Where are you most tempted to ask that same question in your own life?','Sin is described as crouching at the door, "desiring to have" Cain, but he must "rule over it" (4:7). What patterns of sin are crouching at your door right now, and what does ruling over them require?']},
      {title:'The Flood and a New Beginning',reading:'Genesis 6‚Äì9',questions:['God was "grieved" by human wickedness (6:6) ‚Äî an emotional response. What does it tell you about God that he grieves over sin rather than just judging it coolly?','Noah did "all that God commanded him" (6:22) in an era when no one else was. What does it cost to obey God when everyone around you is going in the opposite direction?','God made a covenant with Noah and all living creatures (9:9‚Äì11). The rainbow is a reminder of that promise. How do you use physical reminders to keep God\'s promises present in your daily life?','After the flood, Noah got drunk and there was family shame (9:20‚Äì23). Even the most faithful people fail. How do you handle the disappointing failures of people you respect or look up to?','The flood narrative is about both judgment and rescue. How do you hold both realities together in your understanding of God ‚Äî that he is both a God of justice and a God who saves?']},
      {title:'Abraham: The Father of Faith',reading:'Genesis 12, 15, 17, 22',questions:['God told Abram to "go" without telling him where (12:1). Have you ever sensed God calling you to take a step of obedience without knowing where it leads? What happened?','God promised Abram descendants as numerous as the stars (15:5) when he had no children. How do you hold onto a promise from God when your circumstances completely contradict it?','Abraham laughed when God promised him a son at age 99 (17:17). God didn\'t rebuke the laughter. What does this tell you about bringing honest, even incredulous, reactions to God?','The binding of Isaac (22) is one of the most difficult passages in the Bible. What do you think God was testing ‚Äî and what does Abraham\'s obedience reveal about the nature of trust?','Genesis 22:14: "The Lord will provide." Where do you need to see God provide something in your life right now that feels impossible? How do you hold that hope while you wait?']},
      {title:'Jacob: The Wrestler',reading:'Genesis 25, 27‚Äì28, 32‚Äì33',questions:['Jacob and Esau struggled together in the womb (25:22) and Jacob grabbed Esau\'s heel at birth (25:26). How do patterns established in a family system continue to shape people even into adulthood?','Jacob deceived his father to steal his brother\'s blessing (27). Is there a relationship in your life where you\'ve gotten something through deception or manipulation? What has that cost you?','At Bethel, Jacob saw the ladder to heaven and heard God\'s promise (28:10‚Äì17). Has there been a moment in your life where God broke through and you said "Surely God is in this place"?','Jacob wrestled with God and wouldn\'t let go until he received a blessing (32:26). What does this picture of persistent, grasping, wrestling prayer say about how God wants us to come to him?','After 20 years, Jacob feared meeting Esau (33). But Esau ran to him and embraced him (33:4). What broken relationship in your life might need the kind of initiated reconciliation Esau models here?']},
      {title:'Joseph: Betrayal to Redemption',reading:'Genesis 37, 39‚Äì41, 45, 50',questions:['Joseph was thrown into a pit by his own brothers (37:24). Have you experienced betrayal by people close to you? What did you do with that pain, and how has it shaped you?','Joseph was falsely accused and imprisoned (39:20), yet the Lord was "with Joseph" (39:21). How do you hold onto the presence of God in seasons that feel like unjust punishment?','Pharaoh gave Joseph a platform he couldn\'t have imagined from the prison floor (41:41). How has God ever prepared you through hardship for an opportunity you couldn\'t have handled without it?','Joseph wept when he finally revealed himself to his brothers (45:2). What does his response ‚Äî no accusation, only tears and grace ‚Äî tell you about what genuine forgiveness looks like?','Joseph\'s famous words: "You intended to harm me, but God intended it for good" (50:20). Is there a painful chapter of your story that you are beginning to see God was weaving toward something good?']}
    ]
  },
  'Psalms': {
    sessions:[
      {title:'Honest with God',reading:'Psalms 22, 42, 88',questions:['Psalm 22 begins "My God, my God, why have you forsaken me?" ‚Äî the cry Jesus quoted from the cross. Have you ever felt abandoned by God? What did you do with that feeling?','The psalmist in Psalm 42 talks to his own soul: "Why are you cast down, O my soul?" (v.5). What does it mean to preach truth to yourself when your emotions are telling you something different?','Psalm 88 is the darkest psalm ‚Äî it ends without resolution, in darkness (v.18). What does the fact that this psalm is in the Bible tell you about whether God welcomes our unanswered grief?','These psalms name suffering honestly rather than sanitizing it. How does your prayer life compare ‚Äî do you bring your raw, unfiltered feelings to God, or do you tend to "tidy up" your prayers?','Where in your life right now do you most need to move from pretending to God toward being fully honest with him? What would that prayer actually sound like?']},
      {title:'Praise and Worship',reading:'Psalms 8, 19, 100, 150',questions:['Psalm 8 moves from wonder at creation to wonder at humanity: "What is man that you are mindful of him?" (v.4). When is the last time you were genuinely awestruck ‚Äî by nature, by life, by God?','Psalm 19 says creation "declares the glory of God" (v.1) without words. Where in the created world do you most easily encounter God? How often do you make space for that?','Psalm 100 calls all the earth to worship. What does it mean that worship is a command, not just a feeling? How do you worship when you don\'t feel like it?','Psalm 150 ends the whole book with everything that breathes praising God. What does a life of praise ‚Äî not just occasional, but constant ‚Äî actually look like in your day-to-day context?','Choose one line from these psalms that you want to carry into this week. Share it and explain why it matters to you right now.']},
      {title:'Trust and Refuge',reading:'Psalms 23, 27, 46, 91',questions:['Psalm 23 is the most famous psalm. Which phrase in it is most meaningful to you right now ‚Äî "still waters," "valley of the shadow of death," "my cup overflows"? Why?','Psalm 27:1 ‚Äî "The Lord is my light and my salvation; whom shall I fear?" Fear is a dominant emotion in modern life. What are you most afraid of, and how does this psalm speak to it?','Psalm 46 says "God is our refuge and strength, a very present help in trouble" (v.1). Then it says "Be still, and know that I am God" (v.10). What would it look like to be still this week ‚Äî truly?','Psalm 91 promises protection, presence, and rescue. Have you experienced this in a tangible way? Are there times when it seemed like these promises weren\'t true?','What is the difference between refuge that means "hiding from problems" and refuge that means "finding strength to face them"? Which kind of refuge are you looking for from God right now?']},
      {title:'Forgiveness and Restoration',reading:'Psalms 32, 51, 130',questions:['Psalm 32:3‚Äì4 describes the physical toll of hidden, unconfessed sin: "my bones wasted away." Have you ever experienced the weight of guilt that isn\'t confessed? What did it feel like?','Psalm 51 is David\'s prayer after his adultery with Bathsheba. He asks for a "clean heart" and a "right spirit" (v.10). What is the relationship between genuine repentance and real transformation?','David says "Create in me a clean heart, O God" (51:10) ‚Äî using the word bara, the same word for creation in Genesis 1. What does it mean that restoration is described as a creative act?','Psalm 130:4 says "with you there is forgiveness, that you may be feared." Why does forgiveness produce reverence rather than taking God for granted? How does that work in your own heart?','Which of these three psalms most speaks to where you are right now? Read one verse from it aloud and tell the group why it matters to you today.']},
      {title:'Wisdom for Life',reading:'Psalms 1, 37, 73, 119:1‚Äì32',questions:['Psalm 1 contrasts the blessed person with the wicked through one key image: what you meditate on. What do you spend the most mental bandwidth on in an average day?','Psalm 37:4 says "Delight yourself in the Lord, and he will give you the desires of your heart." Is this a promise or a transformation? What does it mean for the "desires of your heart" to change?','Psalm 73 is the great crisis of faith psalm ‚Äî the writer almost falls because the wicked seem to be winning (v.2‚Äì3). What injustice or inequity most tempts you toward cynicism or bitterness?','The psalmist says his footing was restored when he "entered the sanctuary" (73:17) and gained an eternal perspective. How does shifting your perspective change what currently frustrates or discourages you?','Psalm 119 is the longest chapter in the Bible ‚Äî all about God\'s word. What role does Scripture actually play in your daily life, and what would it look like for it to play the role the psalmist describes?']},
      {title:'Lament and Hope',reading:'Psalms 3, 13, 34, 103',questions:['Psalm 13 asks "How long, O Lord?" four times in two verses. Is "how long?" a prayer you have prayed? What is the thing in your life right now that makes you ask that?','Psalm 34:18 says "The Lord is near to the brokenhearted." Not the put-together, not the joyful ‚Äî the brokenhearted. Who around you is brokenhearted right now, and what does this truth call you to do?','Psalm 34:19 says "Many are the afflictions of the righteous, but the Lord delivers him out of them all." This doesn\'t say afflictions won\'t come ‚Äî it says God delivers through them. How does that distinction matter?','Psalm 103 calls us to "forget not all his benefits" (v.2) and then lists them. What are the specific benefits of knowing God that you are most at risk of forgetting in your current season?','Looking back over this Psalms study: what is the biggest shift in how you think about prayer, honesty with God, or the life of faith that you want to carry forward?']}
    ]
  }
};

// Book lengths for auto-generating session counts
var BOOK_SESSION_COUNTS = {
  'Genesis':6,'Exodus':5,'Leviticus':3,'Numbers':4,'Deuteronomy':4,
  'Joshua':4,'Judges':4,'Ruth':3,'1 Samuel':5,'2 Samuel':4,
  '1 Kings':4,'2 Kings':4,'1 Chronicles':3,'2 Chronicles':3,
  'Ezra':3,'Nehemiah':3,'Esther':3,'Job':5,'Psalms':6,
  'Proverbs':4,'Ecclesiastes':3,'Song of Solomon':3,
  'Isaiah':6,'Jeremiah':6,'Lamentations':3,'Ezekiel':5,'Daniel':4,
  'Hosea':3,'Joel':2,'Amos':3,'Obadiah':2,'Jonah':3,'Micah':3,
  'Nahum':2,'Habakkuk':2,'Zephaniah':2,'Haggai':2,'Zechariah':3,'Malachi':2,
  'Matthew':7,'Mark':5,'Luke':7,'John':8,'Acts':6,
  'Romans':6,'1 Corinthians':5,'2 Corinthians':4,'Galatians':3,'Ephesians':4,
  'Philippians':4,'Colossians':3,'1 Thessalonians':3,'2 Thessalonians':2,
  '1 Timothy':3,'2 Timothy':3,'Titus':2,'Philemon':2,'Hebrews':5,
  'James':5,'1 Peter':3,'2 Peter':2,'1 John':3,'2 John':1,'3 John':1,
  'Jude':2,'Revelation':6
};

// Generate a basic study plan for books without hand-crafted content
function generateStudy(book){
  var meta=BIBLE_BOOKS.find(function(b){return b.title===book});
  if(!meta) return null;
  var numSessions=BOOK_SESSION_COUNTS[book]||3;
  // Simple chapter divisions (approximate)
  var sessions=[];
  for(var i=0;i<numSessions;i++){
    var sessionNum=i+1;
    sessions.push({
      title:'Session '+sessionNum+' ‚Äî '+book,
      reading:book+' (Part '+sessionNum+' of '+numSessions+')',
      questions:[
        'What stood out most to you in this passage, and why do you think it caught your attention?',
        'What does this passage reveal about the character or nature of God? How does that affect your understanding of him?',
        'Is there a command, warning, or invitation in this text that applies directly to your life right now? What would obedience look like?',
        'What is the hardest thing about this passage ‚Äî the thing that challenges, confuses, or unsettles you? Sit with it together as a group.',
        'What is one thing from today\'s passage that you want to carry into this week ‚Äî a truth to hold onto, a change to make, or a prayer to pray?'
      ]
    });
  }
  return {sessions:sessions, generated:true};
}

// Get study for a book ‚Äî custom if available, auto-generated otherwise
function getStudy(book){
  if(BIBLE_STUDIES[book]) return BIBLE_STUDIES[book];
  var generated=generateStudy(book);
  if(generated) BIBLE_STUDIES[book]=generated; // cache it
  return generated;
}

// Unified study lookup: checks ministry resources first, then BIBLE_STUDIES + auto-generate.
// Use this everywhere we need sessions for a given study title.
function getStudyForTitle(title){
  if(!title) return null;
  // Check ministry resources (they carry their own sessions array)
  var minRes=getMinistryResources();
  for(var i=0;i<minRes.length;i++){
    if(minRes[i].title===title&&minRes[i].sessions&&minRes[i].sessions.length>0){
      return {sessions:minRes[i].sessions};
    }
  }
  // Fall back to bible study (pre-built or auto-generated)
  return getStudy(title);
}

// Current study guide view state
var studyGuideBook=null;
var studyGuideFrom=null; // 'group' or 'ministry'

function viewStudyGuide(book, fromPage){
  studyGuideBook=book;
  studyGuideFrom=fromPage||'resources';
  var study=getStudy(book);
  if(!study){toast('study not found');return;}
  var bookMeta=BIBLE_BOOKS.find(function(b){return b.title===book})||{desc:'',tags:[]};
  var canEdit=CU&&CU.type==='ministry';

  document.getElementById('page-title').textContent=book+' ‚Äî study guide';
  topAction(
    (canEdit?'<button class="btn btn-g btn-sm" style="margin-right:8px" onclick="modalEditStudyGuide(\''+book.replace(/'/g,"\\'")+'\')">‚úèÔ∏è edit guide</button>':'')
    +'<button class="btn btn-s btn-sm" onclick="goPage(\''+studyGuideFrom+'\')">‚Üê back</button>'
  );

  var sessionsHtml=study.sessions.map(function(s,si){
    return '<div class="card" style="margin-bottom:18px">'
      +'<div class="card-header">'
      +'<div>'
      +'<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--brand);margin-bottom:3px">session '+(si+1)+' of '+study.sessions.length+'</div>'
      +'<div class="card-title">'+s.title+'</div>'
      +'<div style="font-size:13px;color:var(--mid);margin-top:3px">üìñ '+s.reading+'</div>'
      +'</div>'
      +'</div>'
      +'<div style="border-top:1px solid var(--border);padding-top:14px">'
      +'<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:12px">discussion questions</div>'
      +s.questions.map(function(q,qi){
        return '<div style="margin-bottom:14px;display:flex;gap:12px">'
          +'<div style="flex-shrink:0;width:26px;height:26px;border-radius:50%;background:var(--brand-p);color:var(--brand);font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;margin-top:1px">'+(qi+1)+'</div>'
          +'<div style="font-size:14px;color:var(--dark);line-height:1.7;padding-top:4px">'+q+'</div>'
          +'</div>';
      }).join('')
      +'</div>'
      +(isLeader()?'<div style="padding-top:4px"><button class="btn btn-s btn-sm" onclick="setStudyFromGuide(\''+book.replace(/'/g,"\\'")+'\')" >üìñ use this as my current study</button></div>':'')
      +'</div>';
  }).join('');

  pc('<div class="card" style="margin-bottom:18px;background:linear-gradient(135deg,var(--brand-p),#f8fff9);border-color:var(--brand-l)">'
    +'<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--brand);margin-bottom:6px">'+bookMeta.t+' ¬∑ '+study.sessions.length+'-session study</div>'
    +'<div style="font-family:\'DM Serif Display\',serif;font-size:28px;color:var(--dark);margin-bottom:8px">'+book+'</div>'
    +'<div style="font-size:14px;color:var(--mid);line-height:1.6;margin-bottom:12px">'+bookMeta.desc+'</div>'
    +'<div class="res-tags">'+bookMeta.tags.map(function(t){return '<span class="chip">'+t+'</span>'}).join('')+'</div>'
    +(study.generated?'<div class="banner banner-orange" style="margin-top:14px;margin-bottom:0">‚ö†Ô∏è This is an auto-generated outline with general discussion questions. '+(canEdit?'Click <strong>‚úèÔ∏è edit guide</strong> to customize the readings and questions for your groups.':'A ministry leader can edit and customize this guide.')+'</div>':'')
    +'</div>'
    +sessionsHtml);
}

function setStudyFromGuide(book){
  if(!GD) GD={name:'',start:'',next:{},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  GD.study=book;
  toast('"'+book+'" set as current study üìñ');
}

function modalEditStudyGuide(book){
  var study=getStudy(book);
  if(!study){toast('study not found');return;}

  var html=mClose()+'<h2>‚úèÔ∏è '+book+'</h2>'
    +'<div style="font-size:13px;color:var(--muted);margin-bottom:18px;line-height:1.6">edit sessions, readings, and discussion questions below. changes apply to all groups in your ministry.</div>';

  study.sessions.forEach(function(s,si){
    html+='<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--rsm);padding:14px;margin-bottom:12px">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
      +'<div style="font-size:12px;font-weight:600;color:var(--brand)">session '+(si+1)+'</div>'
      +(study.sessions.length>1?'<button onclick="deleteStudySession(\''+book.replace(/'/g,"\\'")+'\','+si+')" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:15px;padding:2px 4px">‚úï remove</button>':'')
      +'</div>'
      +'<div class="fg"><label>session title</label>'
      +'<input type="text" id="es-title-'+si+'" value="'+s.title.replace(/"/g,'&quot;').replace(/'/g,"&#39;")+'" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:9px 12px;font-family:inherit;font-size:14px;background:#fff"></div>'
      +'<div class="fg"><label>reading assignment</label>'
      +'<input type="text" id="es-reading-'+si+'" value="'+s.reading.replace(/"/g,'&quot;').replace(/'/g,"&#39;")+'" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:9px 12px;font-family:inherit;font-size:14px;background:#fff"></div>'
      +'<div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin:10px 0 8px">discussion questions</div>'
      +s.questions.map(function(q,qi){
        return '<div style="display:flex;gap:8px;margin-bottom:8px;align-items:flex-start">'
          +'<div style="flex-shrink:0;width:22px;height:22px;border-radius:50%;background:var(--brand-p);color:var(--brand);font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;margin-top:9px">'+(qi+1)+'</div>'
          +'<textarea id="es-q-'+si+'-'+qi+'" rows="2" style="flex:1;border:1.5px solid var(--border);border-radius:var(--rsm);padding:8px 10px;font-family:inherit;font-size:13px;background:#fff;resize:vertical;line-height:1.5">'+q.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</textarea>'
          +'</div>';
      }).join('')
      +'</div>';
  });

  html+='<button class="btn btn-s btn-full" style="margin-bottom:12px" onclick="addStudySession(\''+book.replace(/'/g,"\\'")+'\')">+ add session</button>'
    +'<button class="btn btn-p btn-full" onclick="saveStudyEdits(\''+book.replace(/'/g,"\\'")+'\')">save all changes</button>';
  openModal(html);
}

function deleteStudySession(book, si){
  var study=getStudy(book);
  if(!study||study.sessions.length<=1){toast('a study needs at least one session');return;}
  // Save any edits first so we don\'t lose typed content
  saveStudyEditsToMemory(book, study);
  study.sessions.splice(si,1);
  modalEditStudyGuide(book);
}

function addStudySession(book){
  var study=getStudy(book);
  if(!study) return;
  saveStudyEditsToMemory(book, study);
  study.sessions.push({
    title:'New Session',
    reading:book+' (reading TBD)',
    questions:['Question 1','Question 2','Question 3','Question 4','Question 5']
  });
  study.generated=false;
  modalEditStudyGuide(book);
  setTimeout(function(){
    var box=document.querySelector('.modal-box');
    if(box) box.scrollTop=box.scrollHeight;
  },50);
}

// Helper: read current form values into the study object without closing modal
function saveStudyEditsToMemory(book, study){
  if(!study) return;
  study.sessions.forEach(function(s,si){
    var tEl=document.getElementById('es-title-'+si);
    var rEl=document.getElementById('es-reading-'+si);
    if(tEl) s.title=tEl.value;
    if(rEl) s.reading=rEl.value;
    s.questions=s.questions.map(function(q,qi){
      var el=document.getElementById('es-q-'+si+'-'+qi);
      return el?el.value:q;
    });
  });
}

function saveStudyEdits(book){
  var study=getStudy(book);
  if(!study) return;
  saveStudyEditsToMemory(book, study);
  study.generated=false;
  closeModal();
  toast('study guide updated ‚úÖ');
  viewStudyGuide(book, studyGuideFrom||'resources');
}
var NAV_CONFIG = {
  ministry: [
    {section:'my ministry'},
    {id:'home',        ic:'üè†', lb:'dashboard'},
    {id:'groups',      ic:'üë•', lb:'all groups'},
    {id:'health',      ic:'üíö', lb:'group health'},
    {id:'min-res',     ic:'üìö', lb:'resources'},
    {id:'announce',    ic:'üì£', lb:'announcements'},
    {id:'stats',       ic:'üìä', lb:'ministry stats'},
    {divider:'my group'},
    {id:'grp-home',    ic:'üè†', lb:'group home'},
    {id:'meeting',     ic:'üìÖ', lb:'next meeting'},
    {id:'attend',      ic:'‚úÖ', lb:'attendance'},
    {id:'prayers',     ic:'üôè', lb:'prayer wall'},
    {id:'ice',         ic:'üí¨', lb:'icebreaker'},
    {id:'sched',       ic:'üóìÔ∏è', lb:'scheduling'},
    {id:'rotation',    ic:'üè°', lb:'location rotation'},
    {id:'assess',      ic:'üíö', lb:'group health'},
    {id:'miles',       ic:'üèÜ', lb:'milestones'},
    {id:'resources',   ic:'üìö', lb:'study resources'},
    {id:'members',     ic:'üë§', lb:'manage members'}
  ],
  leader: [
    {id:'home',        ic:'üè†', lb:'home'},
    {id:'meeting',     ic:'üìÖ', lb:'next meeting'},
    {id:'attend',      ic:'‚úÖ', lb:'attendance'},
    {id:'prayers',     ic:'üôè', lb:'prayer wall'},
    {id:'ice',         ic:'üí¨', lb:'icebreaker'},
    {id:'sched',       ic:'üóìÔ∏è', lb:'scheduling'},
    {id:'rotation',    ic:'üè°', lb:'location rotation'},
    {id:'assess',      ic:'üíö', lb:'group health'},
    {id:'miles',       ic:'üèÜ', lb:'milestones'},
    {id:'resources',   ic:'üìö', lb:'study resources'},
    {id:'members',     ic:'üë§', lb:'manage members'}
  ],
  member: [
    {id:'home',        ic:'üè†', lb:'home'},
    {id:'meeting',     ic:'üìÖ', lb:'next meeting'},
    {id:'prayers',     ic:'üôè', lb:'prayer wall'},
    {id:'ice',         ic:'üí¨', lb:'icebreaker'},
    {id:'sched',       ic:'üóìÔ∏è', lb:'scheduling poll'},
    {id:'assess',      ic:'üíö', lb:'group health'},
    {id:'miles',       ic:'üèÜ', lb:'milestones'},
    {id:'resources',   ic:'üìö', lb:'study resources'}
  ]
};

var PAGE_TITLES = {
  home:'home', 'grp-home':'group home', groups:'all groups',
  health:'group health overview', 'min-res':'ministry resources',
  announce:'announcements',
  stats:'ministry stats', meeting:'next meeting', attend:'attendance',
  prayers:'prayer wall', ice:'icebreaker & connection', sched:'scheduling poll',
  rotation:'location rotation', assess:'group health check-in',
  miles:'milestones & badges', resources:'study resources', members:'manage members'
};

/* ============================================================
   HELPERS
   ============================================================ */
function initials(name){
  var p=name.trim().split(' ');
  return (p[0][0]+(p[1]?p[1][0]:'')).toUpperCase();
}

function genCode(prefix, seed){
  // If seed provided, make deterministic so codes never change for same user
  if(seed){
    var hash=0;
    for(var ci=0;ci<seed.length;ci++) hash=((hash<<5)-hash)+seed.charCodeAt(ci)|0;
    var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',s='';
    var n=Math.abs(hash);
    for(var i=0;i<4;i++){s+=c[n%c.length];n=Math.floor(n/c.length)||1;}
    return prefix+'-'+s;
  }
  var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',s='';
  for(var i=0;i<4;i++) s+=c[Math.floor(Math.random()*c.length)];
  return prefix+'-'+s;
}

function yrs(start){
  return Math.floor((Date.now()-new Date(start))/(365.25*24*3600*1000));
}

function timeOptions(){
  var s='';
  for(var h=0;h<24;h++){
    for(var m=0;m<60;m+=30){
      var h12=h%12||12, ap=h<12?'AM':'PM', ms=m?'30':'00';
      s+='<option>'+h12+':'+ms+' '+ap+'</option>';
    }
  }
  return s;
}

function isLeader(){
  return CU && (CU.type==='leader'||CU.type==='ministry');
}

// Given a JS day-of-week number (0=Sun), find the next occurrence date string
function nextDateForDay(targetDay){
  var d=new Date();
  var diff=(targetDay-d.getDay()+7)%7||7;
  d.setDate(d.getDate()+diff);
  return d.toISOString().split('T')[0];
}

// Format a date string nicely: "2026-03-06" ‚Üí "Thursday, March 6"
function fmtDate(ds){
  if(!ds) return '';
  var d=new Date(ds+'T00:00:00');
  return d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
}

/* ============================================================
   TOAST
   ============================================================ */
var toastTimer;
function toast(msg){
  var t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){t.classList.remove('show')},2800);
}

/* ============================================================
   MODAL
   ============================================================ */
function openModal(html){
  var box=document.getElementById('modal-box');
  box.innerHTML=html;
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal(){
  document.getElementById('modal-overlay').classList.remove('open');
}
function modalClickOutside(e){
  if(e.target===document.getElementById('modal-overlay')) closeModal();
}

/* ============================================================
   MOBILE NAVIGATION
   ============================================================ */
function openMobNav(){
  document.getElementById('sb-nav') && document.querySelector('.sidebar').classList.add('mob-open');
  document.getElementById('mob-overlay').classList.add('open');
  document.querySelector('.sidebar').style.display='flex';
}
function closeMobNav(){
  document.querySelector('.sidebar').classList.remove('mob-open');
  document.getElementById('mob-overlay').classList.remove('open');
}

/* ============================================================
   SIGN IN / OUT
   ============================================================ */
function showView(id){
  ['v-signin','v-ca1','v-ca2','v-ca3','v-confirm'].forEach(function(v){
    document.getElementById(v).style.display = v===id?'block':'none';
  });
}

async function doSignIn(){
  var email=document.getElementById('si-email').value.trim();
  var pw=document.getElementById('si-pw').value;
  if(!email||!pw){toast('please enter your email and password üòä');return;}
  var btn=document.getElementById('si-btn');
  btn.textContent='signing in...'; btn.disabled=true;
  try {
    var r=await sb.auth.signInWithPassword({email:email,password:pw});
    if(r.error){
      var msg=r.error.message||'unknown error';
      if(msg.includes('Invalid login')) msg='incorrect email or password';
      if(msg.includes('Email not confirmed')) msg='please check your email to confirm your account first üì¨';
      toast('sign in failed: '+msg+' üòï');
      btn.textContent='sign in'; btn.disabled=false;
      return;
    }
    await loadProfile(r.data.user);
  } catch(e){
    toast('error: '+e.message);
    btn.textContent='sign in'; btn.disabled=false;
  }
}

async function loadProfile(user){
  DEMO=false;
  PRAYERS=[];

  // ‚îÄ‚îÄ Step 1: Load the auth profile from Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var {data:p}=await sb.from('profiles').select('*').eq('id',user.id).single();
  if(!p){
    var meta=user.user_metadata||{};
    await sb.from('profiles').insert({id:user.id,full_name:meta.full_name||user.email,role:meta.role||'member'});
    var r2=await sb.from('profiles').select('*').eq('id',user.id).single();
    p=r2.data;
  }
  if(!p){toast('error loading your profile ‚Äî please try again üòï');return;}

  // ‚îÄ‚îÄ Step 2: Load saved app data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Priority: localStorage first (always available), then Supabase app_data
  var lsK='gfy_'+user.id;
  var saved={};

  // Try localStorage first
  try{
    var raw=localStorage.getItem(lsK);
    if(raw){ var ls=JSON.parse(raw); if(ls&&ls.groupCode) saved=ls; }
  }catch(e){}

  // If localStorage had nothing, try Supabase app_data column
  if(!saved.groupCode){
    try{
      if(p.app_data){ var db=JSON.parse(p.app_data); if(db&&db.groupCode) saved=db; }
    }catch(e){}
  }

  // ‚îÄ‚îÄ Step 3: Invite codes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // For leaders/ministry: use the code stored in profiles.ministry_id if available
  // (written there on login). Fall back to deterministic hash of user.id.
  // This ensures the displayed code always matches what findLeaderByCode searches.
  // Codes are always deterministic ‚Äî derived from user.id
  var grpCode=genCode('GRP',user.id+'_grp');
  var minCode=genCode('MIN',user.id+'_min');

  // ‚îÄ‚îÄ Step 4: Reconstitute CU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var typeMap={ministry:'ministry leader',leader:'group leader',member:'group member'};
  CU={
    id:user.id, email:user.email,
    name:p.full_name||user.email,
    init:initials(p.full_name||user.email),
    type:p.role||'member',
    role:typeMap[p.role]||'group member',
    groupId:    saved.groupId || p.group_id || null,
    ministryId:(p.role==='ministry'?user.id:null),
    churchName:p.church_name||'',
    groupCode:  grpCode,
    minCode:    minCode,
    groupResources:     saved.groupResources||[],
    placeholderMembers: saved.placeholderMembers||[],
    groupRealMembers:   saved.groupRealMembers||[]
  };

  // ‚îÄ‚îÄ Step 5: Restore global state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(saved.ministryResources) REAL_MINISTRY_RESOURCES=saved.ministryResources;

  GD=(saved.GD&&saved.GD.name)
    ? saved.GD
    : {name:'',start:'',next:{day:'',time:'',loc:'',freq:'weekly'},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};

  if(saved.prayers)       PRAYERS=saved.prayers;
  if(saved.schedSlots)    SCHED_SLOTS=saved.schedSlots;
  if(saved.announcements) MINISTRY_ANNOUNCEMENTS=saved.announcements;

  // ‚îÄ‚îÄ Step 5b: Auto-join group if signup included an invite code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var pendingCode=(user.user_metadata||{}).group_code;
  if(pendingCode && !CU.groupId){
    await autoJoinGroup(pendingCode);
  }

  // ‚îÄ‚îÄ Step 5c: Leader/ministry ‚Äî pull real members from Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if((p.role==='leader'||p.role==='ministry') && CU.groupId){
    try{
      var {data:memberRows}=await sb.from('profiles')
        .select('id,full_name,role')
        .eq('group_id', user.id)
        .neq('id', user.id);
      if(memberRows&&memberRows.length>0){
        var existing=CU.groupRealMembers||[];
        memberRows.forEach(function(m){
          var already=existing.find(function(e){return e.id===m.id;});
          if(!already){
            existing.push({id:m.id,n:m.full_name,r:'group member',i:initials(m.full_name),real:true});
          }
        });
        CU.groupRealMembers=existing;
      }
    }catch(e){ console.log('member fetch error:',e); }
  }

  // ‚îÄ‚îÄ Step 5d: Member ‚Äî fetch group data from leader if GD is empty ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Members have group_id = leader's user ID; pull the leader's GD so they see the group
  if(p.role==='member' && CU.groupId && (!GD||!GD.name)){
    try{
      var {data:leaderProf}=await sb.from('profiles').select('app_data').eq('id',CU.groupId).single();
      if(leaderProf&&leaderProf.app_data){
        var leaderSaved=JSON.parse(leaderProf.app_data);
        if(leaderSaved&&leaderSaved.GD&&leaderSaved.GD.name) GD=leaderSaved.GD;
      }
    }catch(e){ console.log('leader GD fetch error:',e); }
  }

  // ‚îÄ‚îÄ Step 6: Persist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  saveLocal();
  saveRemote();

  enterApp();
}

// ‚îÄ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Primary store: localStorage (synchronous, always works, survives logout)
// Secondary store: Supabase profiles.app_data (async, requires column to exist)
// On load: try Supabase first (shared across devices), fall back to localStorage

function buildPayload(){
  return {
    v:2,
    groupId:   CU.groupId,   // ‚Üê persisted so it survives logout
    groupCode: CU.groupCode,
    minCode:   CU.minCode,
    groupResources:    CU.groupResources||[],
    placeholderMembers:CU.placeholderMembers||[],
    groupRealMembers:  CU.groupRealMembers||[],
    ministryResources: REAL_MINISTRY_RESOURCES,
    GD:          GD,
    prayers:     PRAYERS,
    schedSlots:  typeof SCHED_SLOTS!=='undefined'?SCHED_SLOTS:[],
    announcements:MINISTRY_ANNOUNCEMENTS||[]
  };
}

function lsKey(){ return 'gfy_'+CU.id; }

// SYNC save to localStorage ‚Äî call this everywhere, instant, never fails
function saveLocal(){
  if(!CU||!CU.id||DEMO) return;
  try{ localStorage.setItem(lsKey(), JSON.stringify(buildPayload())); }
  catch(e){ console.warn('localStorage save failed:',e); }
}

// Async save to Supabase ‚Äî fire-and-forget background sync
function saveRemote(){
  if(!CU||!CU.id||DEMO||!sb) return;
  var payload=buildPayload();
  sb.from('profiles').update({app_data:JSON.stringify(payload)}).eq('id',CU.id)
    .then(function(r){ if(r.error) console.log('remote save skipped:',r.error.message); })
    .catch(function(e){ console.log('remote save error:',e); });
}

// saveAppData: write both stores. Called explicitly after big changes.
function saveAppData(){
  saveLocal();
  saveRemote();
  return Promise.resolve(); // keep async callers happy
}

// autoSave: lightweight hook for minor changes ‚Äî localStorage only, instant
function autoSave(){
  if(!DEMO&&CU&&CU.id){ saveLocal(); saveRemote(); }
}

async function doLogout(){
  await sb.auth.signOut();
  CU=null; GD=null; DEMO=false;
  document.getElementById('s-app').classList.remove('active');
  document.getElementById('s-login').classList.add('active');
  showView('v-signin');
}

/* ============================================================
   DEMO LOGIN
   ============================================================ */
function loginDemo(type){
  DEMO=true;
  var typeMap={ministry:'ministry leader',leader:'group leader',member:'group member'};
  CU={
    id:null,name:type==='ministry'?'Eric Peyton':type==='leader'?'Marcus Thompson':'Amy Chen',
    type:type, role:typeMap[type],
    groupId:'demo', ministryId:'demo',
    churchName:'Hope Community Church',
    groupCode:'GRP-THUR', minCode:'MIN-HOPE',
    groupResources:[], placeholderMembers:[{n:'Chris Wallace',r:'study coordinator',real:false}]
  };
  CU.init=initials(CU.name);
  GD=JSON.parse(JSON.stringify(DEMO_GD));
  PRAYERS=JSON.parse(JSON.stringify(DEMO_PRAYERS));
  votedSlots=new Set([2]);
  enterApp();
}

/* ============================================================
   APP ENTRY
   ============================================================ */
function enterApp(){
  document.getElementById('s-login').classList.remove('active');
  document.getElementById('s-app').classList.add('active');
  document.getElementById('sb-name').textContent=CU.name;
  document.getElementById('sb-role').textContent=CU.role;
  document.getElementById('sb-av').textContent=CU.init;
  document.getElementById('sb-role-lbl').textContent=CU.role;
  document.getElementById('s-app').style.paddingTop='';
  MY_SEEN_ANNOUNCEMENTS=new Set();
  buildNav();
  // Show view-bug-reports button for ministry leaders
  goPage('home');
  setTimeout(showAnnounceBanner, 400);
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function buildNav(){
  var items=NAV_CONFIG[CU.type]||NAV_CONFIG.member;
  var html='';
  items.forEach(function(item){
    if(item.section){
      html+='<div class="nav-sec">'+item.section+'</div>';
    } else if(item.divider){
      html+='<div class="nav-divider"></div><div class="nav-sec">'+item.divider+'</div>';
    } else {
      html+='<div class="ni" id="ni-'+item.id+'" onclick="goPage(\''+item.id+'\')">'
        +'<span class="ni-ic">'+item.ic+'</span><span>'+item.lb+'</span></div>';
    }
  });
  document.getElementById('sb-nav').innerHTML=html;
}

function goPage(id){
  closeMobNav();
  document.querySelectorAll('.ni').forEach(function(el){el.classList.remove('active')});
  var nel=document.getElementById('ni-'+id);
  if(nel) nel.classList.add('active');
  document.getElementById('page-title').textContent=PAGE_TITLES[id]||id;
  document.getElementById('topbar-actions').innerHTML='';
  document.getElementById('page-content').innerHTML='';
  // Route
  var pages={
    home:     function(){CU.type==='ministry'?pgMinHome():pgGrpHome()},
    'grp-home':pgGrpHome,
    groups:   pgGroups,
    health:   pgMinHealth,
    'min-res':pgMinRes,
    announce: pgAnnounce,
    stats:    pgStats,
    meeting:  pgMeeting,
    attend:   pgAttend,
    prayers:  pgPrayers,
    ice:      pgIce,
    sched:    pgSched,
    rotation: pgRotation,
    assess:   pgAssess,
    miles:    pgMiles,
    resources:pgResources,
    members:  pgMembers
  };
  if(pages[id]) pages[id]();
}

/* ============================================================
   HELPERS: PAGE CONTENT
   ============================================================ */
function pc(html){document.getElementById('page-content').innerHTML=html;}
function topAction(html){document.getElementById('topbar-actions').innerHTML=html;}
function empty(em,title,body,action){
  return '<div class="empty"><div class="empty-em">'+em+'</div>'
    +'<div class="empty-title">'+title+'</div>'
    +'<div class="empty-body">'+body+'</div>'
    +(action||'')+'</div>';
}

/* ============================================================
   PAGE: MINISTRY HOME
   ============================================================ */
function pgMinHome(){
  if(!DEMO){
    var code=CU.minCode||(CU.minCode=genCode('MIN'));
    if(!GD||!GD.name){
      pc('<div class="card" style="text-align:center;padding:40px 24px">'
        +'<div style="font-size:48px;margin-bottom:16px">‚õ™</div>'
        +'<div style="font-family:\'DM Serif Display\',serif;font-size:24px;color:var(--dark);margin-bottom:10px">welcome to groupify!</div>'
        +'<div style="font-size:14px;color:var(--muted);margin-bottom:24px;line-height:1.7;max-width:400px;margin-left:auto;margin-right:auto">your ministry dashboard will come to life as group leaders join and create their groups.</div>'
        +'<div class="invite-card" style="max-width:320px;margin:0 auto 16px">'
        +'<div class="invite-label">ministry invite code</div>'
        +'<div class="invite-code">'+code+'</div>'
        +'<div class="invite-note">share this with group leaders when they sign up</div>'
        +'<button class="btn btn-p btn-sm" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'code copied! üìã\')">copy code</button>'
        +'</div>'
        +'<button class="btn btn-s" onclick="goPage(\'min-res\')">üìö add study resources</button>'
        +'</div>');
      return;
    }
    // Fix #5: use real counts
    var s=GD.stats||{meetings:0,answered:0,books:0};
    var prayerCount=PRAYERS.length; // real count, not demo
    pc('<div class="g4" style="margin-bottom:18px">'
      +statCard('üë•','1','active group')
      +statCard('üôè',prayerCount,'prayers')
      +statCard('‚ú®',s.answered,'answered')
      +statCard('üíö',(lastHealthScore?lastHealthScore+'%':'‚Äî'),'health score')
      +'</div>'
      +'<div class="g2">'
      +'<div><div class="card"><div class="card-header"><span class="card-title">group health</span>'
      +'<button class="btn btn-g btn-sm" onclick="goPage(\'health\')">see details ‚Üí</button></div>'
      +(lastHealthScore
        ? healthBar(GD.name,lastHealthScore)
        : '<div style="font-size:14px;color:var(--muted);text-align:center;padding:14px 0">no assessment completed yet ‚Äî encourage your group to take the health check-in.</div>')
      +'</div>'
      +'<div class="card"><div class="card-header"><span class="card-title">quick actions</span></div>'
      +'<div style="display:grid;gap:9px">'
      +'<button class="btn btn-g" onclick="goPage(\'groups\')">üë• view all groups</button>'
      +'<button class="btn btn-g" onclick="goPage(\'min-res\')">üìö manage resources</button>'
      +'<button class="btn btn-g" onclick="goPage(\'health\')">üíö view group health</button>'
      +'</div></div></div>'
      +'<div><div class="card"><div class="card-header"><span class="card-title">ministry code</span></div>'
      +'<div class="invite-code" style="font-size:22px;letter-spacing:2px;color:var(--brand);margin-bottom:8px">'+code+'</div>'
      +'<div style="font-size:13px;color:var(--muted);margin-bottom:10px">share with group leaders so they connect to your ministry</div>'
      +'<button class="btn btn-g btn-sm" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'copied! üìã\')">copy code</button>'
      +'</div></div>'
      +'</div>');
    return;
  }
  pc('<div class="g4" style="margin-bottom:18px">'
    +statCard('‚õ™','5','active groups')
    +statCard('üë•','41','total members')
    +statCard('üôè','89','prayers this month')
    +statCard('‚ú®','23','answered prayers')
    +'</div>'
    +'<div class="g2">'
    +'<div><div class="card"><div class="card-header"><span class="card-title">group health overview</span>'
    +'<button class="btn btn-g btn-sm" onclick="goPage(\'health\')">see all ‚Üí</button></div>'
    +DEMO_GROUPS.map(function(g){return healthBar(g.n,g.h)}).join('')
    +'</div></div>'
    +'<div>'
    +'<div class="card"><div class="card-header"><span class="card-title">needs attention</span></div>'
    +DEMO_GROUPS.filter(function(g){return g.h<75}).map(function(g){
      return '<div style="padding:11px 0;border-bottom:1px solid var(--border)">'
        +'<div class="bold" style="font-size:14px">'+g.n+'</div>'
        +'<div style="font-size:13px;color:var(--muted);margin-top:2px">health: '+g.h+'% ¬∑ last met '+g.lm+'</div>'
        +'</div>';
    }).join('')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">quick actions</span></div>'
    +'<div style="display:grid;gap:9px">'
    +'<button class="btn btn-s" onclick="goPage(\'health\')">üíö view health assessments</button>'
    +'<button class="btn btn-g" onclick="goPage(\'min-res\')">üìö manage resources</button>'
    +'</div></div>'
    +'</div></div>');
}

function statCard(em,val,lbl){
  return '<div class="stat-card"><div class="stat-em">'+em+'</div>'
    +'<div class="stat-val">'+val+'</div><div class="stat-lbl">'+lbl+'</div></div>';
}

function healthBar(name,pct){
  var cls=pct<65?' low':pct<80?' med':'';
  return '<div class="health-row"><div class="health-row-header"><span style="font-size:14px">'+name+'</span><span style="font-size:13px;font-weight:600;color:var(--dark)">'+pct+'%</span></div>'
    +'<div class="health-bar-bg"><div class="health-bar-fill'+cls+'" style="width:'+pct+'%"></div></div></div>';
}

/* ============================================================
   PAGE: GROUP HOME
   ============================================================ */
function pgGrpHome(){
  if(!DEMO&&!CU.groupId){
    pc(empty('üë•','start your small group',
      'create your group to get started, or enter an invite code to join an existing group.',
      isLeader()
        ?'<button class="btn btn-p" onclick="modalCreateGroup()">+ create my group</button>'
        :'<button class="btn btn-p" onclick="modalJoinGroup()">üîó enter invite code</button>'
    ));
    return;
  }
  var g=GD;
  var memberPrayers=DEMO?PRAYERS.slice(0,2):[];
  var stats=DEMO?g.stats:{meetings:0,answered:0,books:0};
  if(isLeader()) topAction('<button class="btn btn-g btn-sm" onclick="modalRenameGroup()">‚úèÔ∏è rename group</button>');
  pc('<div class="mhero">'
    +'<div class="mhero-label">üìÖ '+g.name+'</div>'
    +'<div class="mhero-title">'+(g.next.date?fmtDate(g.next.date):g.next.day?g.next.day+' nights':'no meeting scheduled yet')+'</div>'
    +'<div class="mhero-details">'
    +(g.next.time?'<span class="mhero-detail">‚è∞ '+g.next.time+'</span>':'')
    +(g.next.loc?'<span class="mhero-detail">üìç '+g.next.loc+'</span>':'')
    +(g.next.freq?'<span class="mhero-detail">üîÅ '+g.next.freq+'</span>':'')
    +'</div>'
    +(isLeader()?'<div class="mhero-actions" style="display:flex;gap:8px;flex-wrap:wrap">'
      +'<button class="btn btn-a" onclick="modalEditMeeting()">edit meeting details</button>'
      +(GD&&GD.study&&getStudyForTitle(GD.study)?'<button class="btn btn-g" onclick="modalMarkMeetingDone()">‚úì meeting done</button>':'')
      +'</div>':'')
    +'</div>'
    +'<div class="g2">'
    +'<div>'
    +'<div class="iq-card">'
    +'<div class="iq-label">üí¨ this meeting\'s icebreaker</div>'
    +'<div class="iq-text">"'+currentIceQ()+'"</div>'
    +'<div style="display:flex;gap:8px;margin-top:10px">'
    +(iceSkip>0?'<button class="btn btn-g btn-sm" onclick="iceSkip--;pgGrpHome()">‚Üê back</button>':'')
    +'<button class="btn btn-g btn-sm" onclick="iceSkip++;pgGrpHome()">skip ‚Üí</button>'
    +'<button class="btn btn-s btn-sm" onclick="goPage(\'ice\')">see all ‚Üí</button>'
    +'</div>'
    +'</div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">üìñ current study</span>'
    +(isLeader()?'<button class="btn btn-g btn-sm" onclick="modalEditMeeting()">edit</button>':'')+'</div>'
    +(g.study
      ?'<div style="font-size:15px;font-weight:600;color:var(--dark);margin-bottom:6px">'+g.study+'</div>'
        +(g.hw?'<div style="font-size:13px;color:var(--mid);line-height:1.6"><strong>homework:</strong> '+g.hw+'</div>':'')
      :'<div style="font-size:14px;color:var(--muted);padding:4px 0">no study selected yet.'+(isLeader()?' <a onclick="goPage(\'resources\')">pick one ‚Üí</a>':'')+'</div>')
    +'</div>'
    +'</div>'
    +'<div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">üôè recent prayers</span>'
    +'<button class="btn btn-g btn-sm" onclick="goPage(\'prayers\')">see all ‚Üí</button></div>'
    +(memberPrayers.length===0
      ?'<div style="font-size:14px;color:var(--muted);padding:8px 0;text-align:center">no prayers yet - be the first üôè</div>'
      :memberPrayers.map(prayerItemHtml).join(''))
    +'</div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">üèÜ group stats</span>'
    +'<button class="btn btn-g btn-sm" onclick="goPage(\'miles\')">see all ‚Üí</button></div>'
    +'<div class="g3">'
    +'<div style="text-align:center;padding:12px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+stats.meetings+'</div><div style="font-size:12px;color:var(--muted)">meetings</div></div>'
    +'<div style="text-align:center;padding:12px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+yrs(g.start||new Date())+'</div><div style="font-size:12px;color:var(--muted)">years</div></div>'
    +'<div style="text-align:center;padding:12px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+stats.answered+'</div><div style="font-size:12px;color:var(--muted)">answered ‚ú®</div></div>'
    +'</div>'
    +'</div>'
    +'</div>'
    +'</div>');
}

/* ============================================================
   ANNOUNCEMENTS
   ============================================================ */
// Each: {id, text, author, dt, seen:Set(userId)} ‚Äî stored in ministryId's app_data
var MINISTRY_ANNOUNCEMENTS = DEMO ? [
  {id:1, text:'Welcome to groupify! üéâ We\'re excited to have your group using this tool. Reach out if you need anything.', author:'Eric Peyton', dt:'today', seenBy:[]},
  {id:2, text:'Reminder: all group leaders should complete a health check-in this month. Thank you!', author:'Eric Peyton', dt:'3 days ago', seenBy:[]}
] : [];
var MY_SEEN_ANNOUNCEMENTS = new Set(); // IDs the current user has dismissed

function pgAnnounce(){
  var isMin=CU.type==='ministry';
  if(isMin) topAction('<button class="btn btn-p btn-sm" onclick="modalAddAnnouncement()">üì£ post announcement</button>');

  var list=MINISTRY_ANNOUNCEMENTS;

  if(list.length===0){
    pc(empty('üì£','no announcements yet',
      isMin?'post an announcement to notify all group leaders and members in your ministry.':'no announcements from your ministry leader yet.',
      isMin?'<button class="btn btn-p" onclick="modalAddAnnouncement()">üì£ post first announcement</button>':''
    ));
    return;
  }

  var unseen=list.filter(function(a){return !MY_SEEN_ANNOUNCEMENTS.has(a.id);});
  var html='';

  if(unseen.length>0){
    html+='<div class="sec-label">üì¨ new ('+unseen.length+')</div>';
    html+=unseen.map(function(a){ return announcementCard(a,isMin,false); }).join('');
  }

  var seen=list.filter(function(a){return MY_SEEN_ANNOUNCEMENTS.has(a.id);});
  if(seen.length>0){
    html+='<div class="sec-label" style="margin-top:18px">üìÅ previous announcements</div>';
    html+=seen.map(function(a){ return announcementCard(a,isMin,true); }).join('');
  }

  pc(html);
}

function announcementCard(a, isMin, isSeen){
  return '<div class="card" style="margin-bottom:12px'+(isSeen?';opacity:.65':';border-color:var(--accent);border-width:2px')+'">'
    +'<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">'
    +'<div style="flex:1">'
    +(isSeen?'':'<span class="badge badge-green" style="margin-bottom:6px;display:inline-block">new</span><br>')
    +'<div style="font-size:15px;color:var(--dark);line-height:1.6;margin-bottom:8px">'+a.text+'</div>'
    +'<div style="font-size:12px;color:var(--muted)">‚Äî '+a.author+' ¬∑ '+a.dt+'</div>'
    +'</div>'
    +(isMin?'<button onclick="deleteAnnouncement('+a.id+')" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:17px;flex-shrink:0" title="delete">‚úï</button>':'')
    +'</div>'
    +(!isSeen?'<div style="margin-top:12px"><button class="btn btn-g btn-sm" onclick="dismissAnnouncement('+a.id+')">‚úì mark as seen</button></div>':'')
    +'</div>';
}

function dismissAnnouncement(id){
  MY_SEEN_ANNOUNCEMENTS.add(id);
  pgAnnounce();
  // Update or remove the top banner
  var remaining=MINISTRY_ANNOUNCEMENTS.filter(function(a){return !MY_SEEN_ANNOUNCEMENTS.has(a.id);});
  var banner=document.getElementById('announce-banner');
  if(remaining.length===0){
    if(banner) banner.remove();
    document.getElementById('s-app').style.paddingTop='';
  } else if(banner){
    // Update to show next unseen announcement
    var next=remaining[0];
    banner.querySelector('.announce-text').innerHTML='<strong>ministry announcement</strong> ‚Äî '+next.text;
    // Rebuild dismiss button with new id
    var dismissBtn=banner.querySelector('button');
    if(dismissBtn) dismissBtn.setAttribute('onclick','dismissAnnouncement('+next.id+')');
  }
}

function deleteAnnouncement(id){
  var idx=MINISTRY_ANNOUNCEMENTS.findIndex(function(a){return a.id===id;});
  if(idx>-1) MINISTRY_ANNOUNCEMENTS.splice(idx,1);
  pgAnnounce();
  autoSave();
}

function modalAddAnnouncement(){
  openModal(mClose()+'<h2>üì£ post announcement</h2>'
    +'<div class="modal-sub">this will appear as a highlighted banner for all group leaders and members in your ministry.</div>'
    +'<div class="fg"><label>announcement</label><textarea rows="4" id="ann-text" placeholder="e.g. Reminder: all groups should complete a health check-in this month..."></textarea></div>'
    +'<button class="btn btn-p btn-full" onclick="saveAnnouncement()">post announcement üì£</button>');
}
function saveAnnouncement(){
  var text=document.getElementById('ann-text').value.trim();
  if(!text){toast('please write your announcement üòä');return;}
  var a={id:Date.now(),text:text,author:CU.name,dt:'just now',seenBy:[]};
  MINISTRY_ANNOUNCEMENTS.unshift(a);
  closeModal(); pgAnnounce(); toast('announcement posted üì£');
  autoSave();
  showAnnounceBanner();
}

function showAnnounceBanner(){
  var unseen=MINISTRY_ANNOUNCEMENTS.filter(function(a){return !MY_SEEN_ANNOUNCEMENTS.has(a.id);});
  var existing=document.getElementById('announce-banner');
  if(existing) existing.remove();
  if(!unseen.length) return;
  var a=unseen[0];
  var banner=document.createElement('div');
  banner.id='announce-banner';
  banner.style.cssText='position:fixed;top:0;left:0;right:0;z-index:9999;background:var(--accent);color:#fff;padding:12px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 12px rgba(0,0,0,.18);font-size:14px;line-height:1.5';
  banner.innerHTML='<span style="font-size:20px">üì£</span>'
    +'<span class="announce-text" style="flex:1"><strong>ministry announcement</strong> ‚Äî '+a.text+'</span>'
    +'<button onclick="dismissAnnouncement('+a.id+')" style="background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:6px;padding:5px 12px;cursor:pointer;font-size:13px;white-space:nowrap">‚úì mark seen</button>'
    +(unseen.length>1?'<button onclick="goPage(\'announce\')" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:6px;padding:5px 10px;cursor:pointer;font-size:13px;white-space:nowrap">+'+( unseen.length-1)+' more</button>':'');
  document.body.appendChild(banner);
  // Offset the app content so banner doesn't cover it
  document.getElementById('s-app').style.paddingTop='52px';
}


/* ============================================================
   PAGE: MINISTRY - ALL GROUPS
   ============================================================ */
function pgGroups(){
  if(!DEMO){
    var code=CU.minCode||(CU.minCode=genCode('MIN'));
    var myGroups=[];
    if(GD&&GD.name){
      var yr=yrs(GD.start||new Date());
      var allM=(CU.groupRealMembers||[]).concat(CU.placeholderMembers||[]);
      myGroups.push({n:GD.name,members:allM.length||1,lm:'active',h:lastHealthScore||0,years:yr,real:true});
    }
    pc('<div class="invite-card">'
      +'<div class="invite-label">ministry invite code</div>'
      +'<div class="invite-code">'+code+'</div>'
      +'<div class="invite-note">share with group leaders so they connect to your ministry when signing up</div>'
      +'<button class="btn btn-p btn-sm" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'copied! üìã\')">copy code</button>'
      +'</div>'
      +(myGroups.length===0
        ? empty('üë•','no groups yet','groups will appear here as group leaders sign up and create their groups.','')
        : '<div class="g4" style="margin-bottom:18px">'
          +statCard('üë•',myGroups.length,'active group'+(myGroups.length!==1?'s':''))
          +statCard('üôã',myGroups.reduce(function(a,g){return a+g.members},0),'total members')
          +statCard('üìÖ','‚Äî','meetings this month')
          +statCard('üíö',(lastHealthScore?lastHealthScore+'%':'‚Äî'),'avg health score')
          +'</div>'
          +'<div class="card"><div class="card-header"><span class="card-title">your groups</span></div>'
          +myGroups.map(function(g){
            return '<div style="padding:14px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;cursor:pointer" onclick="viewMinGroup(\''+g.n.replace(/'/g,"\\'")+'\')">'
              +'<div style="flex:1"><div class="bold" style="font-size:14px">'+g.n+'</div>'
              +'<div style="font-size:12px;color:var(--muted);margin-top:2px">'+g.members+' member'+(g.members!==1?'s':'')+' ¬∑ '+g.years+' yr'+(g.years!==1?'s':'')+' old</div></div>'
              +(g.h?'<div style="min-width:80px">'+healthBar('',g.h)+'</div><span class="badge '+(g.h>=80?'badge-green':g.h>=65?'badge-blue':'')+'">'+g.h+'%</span>':'<span class="badge badge-grey">not assessed</span>')
              +'<span style="color:var(--muted);font-size:18px">‚Ä∫</span>'
              +'</div>';
          }).join('')
          +'</div>'));
    return;
  }
  // Demo mode
  pc('<div class="g4" style="margin-bottom:20px">'
    +statCard('üë•','5','active groups')
    +statCard('üôã','41','total members')
    +statCard('üìÖ','23','meetings this month')
    +statCard('üíö','75%','avg health score')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">all groups</span></div>'
    +DEMO_GROUPS.map(function(g){
      return '<div style="padding:14px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;cursor:pointer" onclick="viewMinGroup(\''+g.n+'\')">'
        +'<div style="flex:1"><div class="bold" style="font-size:14px">'+g.n+'</div>'
        +'<div style="font-size:12px;color:var(--muted);margin-top:2px">'+g.members+' members ¬∑ last met '+g.lm+'</div></div>'
        +'<div style="min-width:80px">'+healthBar('',g.h)+'</div>'
        +'<span class="badge '+(g.h>=80?'badge-green':g.h>=65?'badge-blue':'')+'">'+g.h+'%</span>'
        +'<span style="color:var(--muted);font-size:18px">‚Ä∫</span>'
        +'</div>';
    }).join('')
    +'</div>');
}

// Ministry leader: view a group's details (no prayer requests)
var DEMO_GROUP_DETAILS = {
  'Thursday Night Crew':{leader:'Marcus Thompson',study:'James: Faith That Works',members:['Marcus Thompson (leader)','Jenna Thompson (co-leader)','Derek Richards','Amy Chen','Chris Wallace (placeholder)'],meetings:48,answered:12,books:6,health:87,start:'2022-09-08'},
  'Young Couples':{leader:'Sarah & Mike Patel',study:'Emotionally Healthy Spirituality',members:['Sarah Patel (leader)','Mike Patel (co-leader)','Jordan Lee','Mia Torres','Caleb Brown','Priya Nair','Tom Yates','Dana Kim'],meetings:22,answered:5,books:3,health:72,start:'2023-11-01'},
  'Sunday Morning Men':{leader:'Pastor James',study:'Romans',members:['James Mitchell (leader)','Ray Soto','Aaron Webb','Danny Park','Eli Hughes'],meetings:61,answered:18,books:9,health:91,start:'2021-06-15'},
  'Women of Faith':{leader:'Carol Adams',study:'Psalms',members:['Carol Adams (leader)','Lynn Ho','Brenda Shaw','Tasha Green','Rachel Moore','Janet Kim','Sofia Cruz'],meetings:34,answered:8,books:5,health:65,start:'2023-03-20'},
  'College Life':{leader:'Tyler Nash',study:'John',members:['Tyler Nash (leader)','Aiden Cole','Emma Wright','Jake Brooks','Lily Chen','Nate Ford','Olivia Ross','Sam Park','Zoe Lane'],meetings:19,answered:3,books:2,health:58,start:'2024-08-25'}
};

function viewMinGroup(name){
  // For real account, show the leader's actual group
  var det;
  if(!DEMO && GD && GD.name===name){
    var allM=(CU.groupRealMembers||[]).concat(CU.placeholderMembers||[]);
    det={
      leader:CU.name||'you',
      study:GD.study||'none set',
      members:allM.map(function(m){return m.n+(m.r?' ('+m.r+')':'')+(m.real===false?' (placeholder)':'')}),
      meetings:(GD.stats&&GD.stats.meetings)||0,
      answered:(GD.stats&&GD.stats.answered)||0,
      books:(GD.stats&&GD.stats.books)||0,
      health:lastHealthScore||0,
      start:GD.start||new Date().toISOString()
    };
  } else {
    det=DEMO_GROUP_DETAILS[name]||{leader:'‚Äî',study:'‚Äî',members:[],meetings:0,answered:0,books:0,health:0,start:new Date().toISOString()};
  }

  document.getElementById('page-title').textContent=name;
  topAction('<button class="btn btn-s btn-sm" onclick="goPage(\'groups\')">‚Üê all groups</button>');

  var cls=det.health>=80?'var(--brand)':det.health>=60?'var(--accent)':'#E74C3C';
  pc('<div class="g4" style="margin-bottom:18px">'
    +statCard('üìÖ',det.meetings,'meetings')
    +statCard('‚ú®',det.answered,'answered prayers')
    +statCard('üìñ',det.books,'studies')
    +statCard('‚è≥',yrs(det.start)+'yr','together')
    +'</div>'
    +'<div class="g2">'
    +'<div>'
    +'<div class="card" style="margin-bottom:18px">'
    +'<div class="card-header"><span class="card-title">group info</span></div>'
    +'<div style="padding:10px 0;border-bottom:1px solid var(--border)"><div style="font-size:12px;color:var(--muted);margin-bottom:2px">leader</div><div style="font-weight:600">'+det.leader+'</div></div>'
    +'<div style="padding:10px 0;border-bottom:1px solid var(--border)"><div style="font-size:12px;color:var(--muted);margin-bottom:2px">current study</div><div style="font-weight:600">'+det.study+'</div></div>'
    +'<div style="padding:10px 0"><div style="font-size:12px;color:var(--muted);margin-bottom:2px">group started</div><div style="font-weight:600">'+new Date(det.start).toLocaleDateString('en-US',{month:'long',year:'numeric'})+'</div></div>'
    +'</div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">health score</span></div>'
    +(det.health>0
      ?'<div style="font-size:48px;font-weight:700;color:'+cls+';font-family:\'DM Serif Display\',serif;text-align:center;padding:16px 0">'+det.health+'%</div>'
        +healthBar('',det.health)
      :'<div style="text-align:center;padding:20px;color:var(--muted);font-size:14px">no assessment completed yet</div>')
    +'</div>'
    +'</div>'
    +'<div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">members ('+det.members.length+')</span></div>'
    +(det.members.length===0
      ?'<div style="padding:16px;color:var(--muted);font-size:14px">no members yet</div>'
      :det.members.map(function(m){
        var isPlaceholder=m.indexOf('placeholder')>-1;
        var ini=m.charAt(0).toUpperCase();
        return '<div class="member-row">'
          +'<div class="m-av'+(isPlaceholder?' placeholder':'')+'">'+ini+'</div>'
          +'<div style="flex:1"><div class="m-name">'+m+'</div></div>'
          +'</div>';
      }).join(''))
    +'</div>'
    +'</div>'
    +'</div>');
}

/* ============================================================
   PAGE: MINISTRY - GROUP HEALTH OVERVIEW
   ============================================================ */
function pgMinHealth(){
  // Fix #6: This is the MINISTRY health overview ‚Äî shows all groups' scores, not the check-in form.
  // Fix #7: Add survey editor button for ministry leaders.
  topAction('<button class="btn btn-g btn-sm" onclick="modalEditSurvey()">‚úèÔ∏è edit survey questions</button>');

  if(!DEMO){
    // Build groups list from real data
    var groups=[];
    if(GD&&GD.name) groups.push({n:GD.name, h:lastHealthScore||0, assessed:lastHealthScore>0});

    if(groups.length===0){
      pc(empty('üíö','no health data yet','health assessments will appear here once group members complete their first check-in.',
        '<button class="btn btn-p btn-sm" onclick="goPage(\'assess\')">take your first check-in ‚Üí</button>'));
      return;
    }
    var assessed=groups.filter(function(g){return g.assessed});
    var avg=assessed.length?Math.round(assessed.reduce(function(a,g){return a+g.h},0)/assessed.length):0;
    var attn=groups.filter(function(g){return g.h>0&&g.h<75});

    pc('<div class="g4" style="margin-bottom:18px">'
      +statCard('üíö',avg?avg+'%':'‚Äî','avg health score')
      +statCard('‚úÖ',assessed.length+'/'+groups.length,'groups assessed')
      +statCard('üìà','‚Äî','vs last check-in')
      +statCard('‚ö†Ô∏è',attn.length,'need attention')
      +'</div>'
      +'<div class="card" style="margin-bottom:18px"><div class="card-header"><span class="card-title">health by group</span></div>'
      +groups.map(function(g){
        return g.assessed
          ? healthBar(g.n,g.h)

          : '<div style="padding:10px 0;font-size:14px;color:var(--muted)">'+g.n+' ‚Äî no assessment yet</div>';
      }).join('')
      +(attn.length?'<div class="banner banner-orange" style="margin-top:10px">‚ö†Ô∏è groups below 75% need attention. encourage your leaders to run a check-in.</div>':'')
      +'</div>'
      +'<div class="card"><div class="card-header"><span class="card-title">health survey questions</span>'
      +'<button class="btn btn-g btn-sm" onclick="modalEditSurvey()">‚úèÔ∏è edit</button></div>'
      +'<div style="font-size:13px;color:var(--mid);margin-bottom:10px">these are the questions your groups answer during health check-ins.</div>'
      +AQ.map(function(q,i){return '<div style="padding:10px 0;border-bottom:1px solid var(--border);font-size:14px;color:var(--dark)">'+(i+1)+'. '+q.q+'</div>'}).join('')
      +'</div>');
    return;
  }
  // Demo mode
  pc('<div class="g4" style="margin-bottom:20px">'
    +statCard('üíö','75%','avg health score')
    +statCard('‚úÖ','4/5','groups assessed')
    +statCard('üìà','+8%','vs last month')
    +statCard('‚ö†Ô∏è','2','need attention')
    +'</div>'
    +'<div class="card" style="margin-bottom:18px"><div class="card-header"><span class="card-title">health by group</span></div>'
    +DEMO_GROUPS.map(function(g){return healthBar(g.n,g.h)}).join('')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">health survey questions</span>'
    +'<button class="btn btn-g btn-sm" onclick="modalEditSurvey()">‚úèÔ∏è edit</button></div>'
    +'<div style="font-size:13px;color:var(--mid);margin-bottom:10px">these are the questions your groups answer during health check-ins.</div>'
    +AQ.map(function(q,i){return '<div style="padding:10px 0;border-bottom:1px solid var(--border);font-size:14px;color:var(--dark)">'+(i+1)+'. '+q.q+'</div>'}).join('')
    +'</div>');
}

/* ============================================================
   PAGE: MINISTRY - RESOURCES
   ============================================================ */
function pgMinRes(){
  topAction('<button class="btn btn-p btn-sm" onclick="modalAddRes(\'ministry\')">+ add resource</button>');
  var res=getMinistryResources();
  var customHtml = res.length===0
    ? '<div class="banner banner-green" style="text-align:center">no custom resources yet ‚Äî add your first one above, or browse the Bible books below.</div>'
    : res.map(function(r){ return resCardHtml(r, isLeader(), true); }).join('');

  pc('<div class="card" style="margin-bottom:18px">'
    +'<div class="card-header"><span class="card-title">ministry resources</span>'
    +'<span class="card-note">visible to all groups in your ministry</span></div>'
    +customHtml
    +'</div>'
    +'<div class="sec-label">books of the bible ‚Äî default studies</div>'
    +'<div style="font-size:13px;color:var(--mid);margin-bottom:14px;line-height:1.6">all 66 books are available as default studies for any group. groups can set these as their current study from their resources page.</div>'
    +'<div class="tabs" id="min-bible-tabs" style="margin-bottom:14px">'
    +'<div class="tab active" onclick="filterMinBible(\'all\',this)">all (66)</div>'
    +'<div class="tab" onclick="filterMinBible(\'OT\',this)">old testament (39)</div>'
    +'<div class="tab" onclick="filterMinBible(\'NT\',this)">new testament (27)</div>'
    +'</div>'
    +'<div id="min-bible-grid">'
    +minBibleHtml(BIBLE_BOOKS)
    +'</div>');
}

function minBibleHtml(list){
  return list.map(function(b){
    var sessions=BOOK_SESSION_COUNTS[b.title]||3;
    var safe=b.title.replace(/'/g,"\\'");
    return '<div class="res-card">'
      +'<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">'
      +'<div style="flex:1">'
      +'<div class="res-type">'+b.t+' ¬∑ '+sessions+'-session study</div>'
      +'<div class="res-title">'+b.title+'</div>'
      +'<div class="res-desc">'+b.desc+'</div>'
      +'<div class="res-tags">'+b.tags.map(function(t){return '<span class="chip">'+t+'</span>'}).join('')+'</div>'
      +'</div>'
      +'</div>'
      +'<div class="res-actions" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">'
      +'<button class="btn btn-p btn-sm" onclick="viewStudyGuide(\''+safe+'\',\'min-res\')">üìñ view study guide</button>'
      +'<button class="btn btn-g btn-sm" onclick="modalEditStudyGuide(\''+safe+'\')">‚úèÔ∏è edit guide</button>'
      +'</div>'
      +'</div>';
  }).join('');
}

function filterMinBible(f,el){
  document.querySelectorAll('#min-bible-tabs .tab').forEach(function(t){t.classList.remove('active')});
  el.classList.add('active');
  var list=f==='all'?BIBLE_BOOKS:BIBLE_BOOKS.filter(function(b){return b.t===f});
  document.getElementById('min-bible-grid').innerHTML=minBibleHtml(list);
}

function resCardHtml(r, showStudyBtn, showDelete){
  var safeId=r.id||r.title.replace(/\s/g,'_');
  var safeTitle=r.title.replace(/'/g,"\\'");
  var sessionInfo=r.sessions&&r.sessions.length>0?' ¬∑ '+r.sessions.length+'-session study':'';
  return '<div class="res-card" id="rc-'+safeId+'">'
    +'<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">'
    +'<div style="flex:1">'
    +'<div class="res-type">'+r.type+sessionInfo+'</div>'
    +'<div class="res-title">'+r.title+'</div>'
    +'<div class="res-desc">'+r.desc+'</div>'
    +'<div class="res-tags">'+(r.tags||[]).map(function(t){return '<span class="chip">'+t+'</span>'}).join('')+'</div>'
    +(r.sessions&&r.sessions.length>0
      ?'<div style="margin-top:8px;font-size:12px;color:var(--mid)">'
        +r.sessions.map(function(s,i){return '<div style="padding:3px 0;border-bottom:1px solid var(--border)"><span style="color:var(--brand);font-weight:600">'+( i+1)+'.</span> '+s.title+(s.assignment?' <span style="color:var(--muted)">‚Äî '+s.assignment+'</span>':'')+'</div>'}).join('')
        +'</div>'
      :'')
    +'</div>'
    +(showDelete
      ?'<div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0">'
        +'<button onclick="modalEditMinRes(\''+safeId+'\')" style="background:transparent;border:none;color:var(--brand);cursor:pointer;font-size:13px;padding:2px 6px" title="edit resource">‚úèÔ∏è</button>'
        +'<button onclick="deleteMinRes(\''+safeTitle+'\')" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:2px 6px;line-height:1" title="remove resource">‚úï</button>'
        +'</div>'
      :'')
    +'</div>'
    +(showStudyBtn?'<div class="res-actions" style="margin-top:10px"><button class="btn btn-p btn-sm" onclick="setStudy(decodeURIComponent(this.dataset.t))" data-t="'+encodeURIComponent(r.title)+'" >üìñ set as current study</button></div>':'')
    +'</div>';
}

function deleteMinRes(title){
  var arr=DEMO?MINISTRY_RESOURCES:REAL_MINISTRY_RESOURCES;
  var idx=arr.findIndex(function(r){return r.title===title});
  if(idx>-1) arr.splice(idx,1);
  pgMinRes();
  toast('resource removed');
}

/* ============================================================
   PAGE: MINISTRY - STATS
   ============================================================ */
function pgStats(){
  if(!DEMO){
    var hasGroup=GD&&GD.name;
    if(!hasGroup){pc(empty('üìä','no stats yet','stats will build up as your groups meet and members engage.',''));return;}
    var s=GD.stats||{meetings:0,answered:0,books:0};
    pc('<div class="g4" style="margin-bottom:18px">'
      +statCard('üìÖ',s.meetings,'total meetings')
      +statCard('üôè',PRAYERS.length,'prayer requests')
      +statCard('‚ú®',s.answered,'answered prayers')
      +statCard('üìñ',s.books,'books studied')
      +'</div>'
      +'<div class="card"><div class="card-header"><span class="card-title">'+GD.name+'</span><span class="card-note">your group</span></div>'
      +'<div class="g3">'
      +'<div style="text-align:center;padding:14px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+s.meetings+'</div><div style="font-size:12px;color:var(--muted)">meetings held</div></div>'
      +'<div style="text-align:center;padding:14px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+yrs(GD.start||new Date())+'</div><div style="font-size:12px;color:var(--muted)">years together</div></div>'
      +'<div style="text-align:center;padding:14px;background:var(--bg);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:26px;color:var(--dark)">'+(lastHealthScore?lastHealthScore+'%':'‚Äî')+'</div><div style="font-size:12px;color:var(--muted)">health score</div></div>'
      +'</div></div>');
    return;
  }
  pc('<div class="g4" style="margin-bottom:18px">'
    +statCard('üìÖ','23','meetings this month')
    +statCard('üôè','89','prayer requests')
    +statCard('‚ú®','23','answered prayers')
    +statCard('üìñ','12','books studied')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">monthly activity</span></div>'
    +'<div style="font-size:14px;color:var(--muted);padding:20px 0;text-align:center">activity charts coming soon üìä</div>'
    +'</div>');
}

/* ============================================================
   PAGE: NEXT MEETING
   ============================================================ */
function pgMeeting(){
  if(!DEMO&&!CU.groupId){
    pc(empty('üìÖ','no meeting set',
      isLeader()?'create your group first, then set your meeting details here.':'your group leader hasn\'t set a meeting time yet.',
      isLeader()?'<button class="btn btn-p" onclick="modalCreateGroup()">+ create my group</button>':''
    ));
    return;
  }
  if(isLeader()) topAction('<button class="btn btn-p btn-sm" onclick="modalEditMeeting()">edit details</button>');
  var g=GD;
  pc('<div class="mhero">'
    +'<div class="mhero-label">üìÖ next meeting</div>'
    +'<div class="mhero-title">'+(g.next.date?fmtDate(g.next.date):g.next.day||'not scheduled yet')+'</div>'
    +'<div class="mhero-details">'
    +(g.next.time?'<span class="mhero-detail">‚è∞ '+g.next.time+'</span>':'')
    +(g.next.loc?'<span class="mhero-detail">üìç '+g.next.loc+'</span>':'')
    +(g.next.freq?'<span class="mhero-detail">üîÅ '+g.next.freq+'</span>':'')
    +'</div></div>'
    +'<div class="card"><div class="card-header"><span class="card-title">üìñ study & homework</span>'
    +(isLeader()?'<button class="btn btn-g btn-sm" onclick="modalEditMeeting()">edit</button>':'')+'</div>'
    +(g.study
      ?'<div style="font-size:15px;font-weight:600;color:var(--dark);margin-bottom:8px">'+g.study+'</div>'
        +(g.hw?'<div style="font-size:14px;color:var(--mid);line-height:1.7"><strong>homework:</strong> '+g.hw+'</div>':'')
      :'<div style="font-size:14px;color:var(--muted)">no study selected yet.'+(isLeader()?' <a onclick="goPage(\'resources\')">pick one from study resources ‚Üí</a>':'')+'</div>')
    +'</div>'
    +'<div class="card"><div class="card-header"><span class="card-title">üí¨ icebreaker for this meeting</span></div>'
    +'<div class="iq-text" style="font-size:18px;margin-bottom:12px">"'+currentIceQ()+'"</div>'
    +'<div style="display:flex;gap:8px">'
    +(iceSkip>0?'<button class="btn btn-g btn-sm" onclick="iceSkip--;pgMeeting()">‚Üê back</button>':'')
    +'<button class="btn btn-g btn-sm" onclick="iceSkip++;pgMeeting()">skip ‚Üí</button>'
    +'<button class="btn btn-s btn-sm" onclick="goPage(\'ice\')">see all ‚Üí</button>'
    +'</div>'
    +'</div>');
}

/* ============================================================
   PAGE: ATTENDANCE
   ============================================================ */
function pgAttend(){
  if(!DEMO&&!CU.groupId){pc(empty('‚úÖ','no group yet','attendance tracking will be available once your group is set up.',''));return;}
  // Fix #12: use ALL members ‚Äî real + placeholders ‚Äî not just demo members
  var members=DEMO?DEMO_MEMBERS:(
    (CU.groupRealMembers||[]).concat(CU.placeholderMembers||[])
  );
  if(!isLeader()){pc(empty('‚úÖ','attendance','only group leaders can take attendance.',''));return;}
  if(members.length===0){pc(empty('‚úÖ','no members yet','add members to your group to start tracking attendance.','<button class="btn btn-p" onclick="goPage(\'members\')">manage members ‚Üí</button>'));return;}
  var todayStr=new Date().toISOString().split('T')[0];
  topAction('<button class="btn btn-p btn-sm" onclick="saveAttendance()">save attendance</button>');
  pc('<div class="card" style="margin-bottom:14px">'
    +'<div class="card-header"><span class="card-title">attendance date</span></div>'
    +'<input type="date" id="att-date" value="'+todayStr+'" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--rsm);font-family:inherit;font-size:14px;margin-top:4px">'
    +'</div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">mark attendance</span></div>'
    +members.map(function(m,i){
      return '<div class="att-row">'
        +'<div class="m-av'+(m.real?'':' placeholder')+'">'+(m.real?m.i:'?')+'</div>'
        +'<div><div class="m-name">'+m.n+'</div><div class="m-role">'+m.r+'</div></div>'
        +'<div class="att-btns">'
        +'<button class="att-btn" id="att-p-'+i+'" onclick="markAtt('+i+',\'p\')">‚úì present</button>'
        +'<button class="att-btn" id="att-a-'+i+'" onclick="markAtt('+i+',\'a\')">‚úó absent</button>'
        +'</div></div>';
    }).join('')
    +'</div>');
}
function markAtt(i,status){
  ['p','a'].forEach(function(s){
    var btn=document.getElementById('att-'+s+'-'+i);
    if(btn) btn.className='att-btn'+(s===status?' '+(s==='p'?'present':'absent'):'');
  });
}
function saveAttendance(){
  var dateEl=document.getElementById('att-date');
  var dateStr=dateEl?dateEl.value:new Date().toISOString().split('T')[0];
  var d=new Date(dateStr+'T12:00:00');
  var label=d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  toast('attendance saved for '+label+' ‚úÖ');
}

/* ============================================================
   PAGE: PRAYER WALL
   ============================================================ */
function pgPrayers(){
  topAction('<button class="btn btn-p btn-sm" onclick="modalAddPrayer()">+ add prayer request</button>');
  // Prayer wall visible to all logged-in users
  // Always use PRAYERS ‚Äî it's populated for both demo (DEMO_PRAYERS) and real users (via submitPrayer)
  var list=PRAYERS.filter(function(p){return !p.archived});
  if(PRAYERS.length===0){
    pc(empty('üôè','no prayers yet','be the first to share something with your group!',''));
    return;
  }
  var active=list.filter(function(p){return !p.ans});
  var answered=list.filter(function(p){return p.ans});
  var archived=PRAYERS.filter(function(p){return p.archived});
  pc('<div class="g2" style="margin-bottom:16px">'
    +'<div class="stat-card"><div class="stat-em">üôè</div><div class="stat-val">'+list.length+'</div><div class="stat-lbl">prayer requests</div></div>'
    +'<div class="stat-card"><div class="stat-em">‚ú®</div><div class="stat-val">'+answered.length+'</div><div class="stat-lbl">answered prayers</div></div>'
    +'</div>'
    +'<div class="tabs" id="prayer-tabs">'
    +'<div class="tab active" onclick="filterPrayers(\'all\',this)">all ('+list.length+')</div>'
    +'<div class="tab" onclick="filterPrayers(\'active\',this)">active ('+active.length+')</div>'
    +'<div class="tab" onclick="filterPrayers(\'answered\',this)">answered ('+answered.length+')</div>'
    +(archived.length>0||isLeader()?'<div class="tab" onclick="filterPrayers(\'archived\',this)">archived ('+archived.length+')</div>':'')
    +'</div>'
    +'<div class="card" id="prayer-list">'+prayerListHtml(list)+'</div>');
}
function prayerListHtml(list){
  return list.map(prayerItemHtml).join('');
}
function prayerItemHtml(p){
  if(p.archived) return ''; // archived prayers don't render normally
  return '<div class="prayer-item'+(p.ans?' answered':'')+'">'
    +'<div class="prayer-meta"><span class="prayer-author">'+p.au+'</span><span class="prayer-date">'+p.dt+'</span></div>'
    +'<div class="prayer-text">'+p.txt+'</div>'
    +'<div class="prayer-actions">'
    +'<button class="pray-btn'+(p.prayed?' prayed':'')+'" onclick="togPray('+p.id+',this)">üôè '+(p.prayed?'prayed!':'i prayed')+'</button>'
    +'<span class="pray-count">'+p.cnt+' praying</span>'
    +(p.ans?'<span class="badge badge-green">‚ú® answered!</span>':'')
    +(!p.ans&&isLeader()?'<button class="btn btn-s btn-sm" onclick="modalMarkAnswered('+p.id+')">mark answered</button>':'')
    +(isLeader()?'<button class="btn btn-g btn-sm" onclick="archivePrayer('+p.id+')" title="archive this request">archive</button>':'')
    +'</div></div>';
}
function archivePrayer(id){
  var p=PRAYERS.find(function(x){return x.id===id});
  if(p){p.archived=true;}
  pgPrayers(); autoSave(); toast('prayer request archived');
}
function unarchivePrayer(id){
  var p=PRAYERS.find(function(x){return x.id===id});
  if(p){p.archived=false;}
  renderArchived(); autoSave();
}
function renderArchived(){
  var archived=PRAYERS.filter(function(p){return p.archived});
  document.getElementById('prayer-list').innerHTML=archived.length===0
    ?'<div style="padding:20px;text-align:center;color:var(--muted);font-size:14px">no archived requests</div>'
    :archived.map(function(p){
      return '<div class="prayer-item" style="opacity:.7">'
        +'<div class="prayer-meta"><span class="prayer-author">'+p.au+'</span><span class="prayer-date">'+p.dt+' ¬∑ archived</span></div>'
        +'<div class="prayer-text">'+p.txt+'</div>'
        +(isLeader()?'<div class="prayer-actions"><button class="btn btn-g btn-sm" onclick="unarchivePrayer('+p.id+')">restore</button></div>':'')
        +'</div>';
    }).join('');
}
function togPray(id,btn){
  var p=PRAYERS.find(function(x){return x.id===id});
  if(!p) return;
  p.prayed=!p.prayed; p.cnt+=p.prayed?1:-1;
  btn.className='pray-btn'+(p.prayed?' prayed':'');
  btn.textContent='üôè '+(p.prayed?'prayed!':'i prayed');
  btn.nextElementSibling.textContent=p.cnt+' praying';
}
function filterPrayers(f,el){
  document.querySelectorAll('#prayer-tabs .tab').forEach(function(t){t.classList.remove('active')});
  el.classList.add('active');
  if(f==='archived'){renderArchived();return;}
  var base=PRAYERS.filter(function(p){return !p.archived});
  var list=f==='all'?base:f==='answered'?base.filter(function(p){return p.ans}):base.filter(function(p){return !p.ans});
  document.getElementById('prayer-list').innerHTML=prayerListHtml(list);
}

/* ============================================================
   PAGE: ICEBREAKER
   ============================================================ */
// Shared icebreaker state ‚Äî used by group home, next meeting, and icebreaker pages
var iceSkip=0;
function currentIceIdx(){
  var meetingNum=(GD&&GD.stats?GD.stats.meetings:0);
  return ((meetingNum+iceSkip)%IQ.length+IQ.length)%IQ.length;
}
function currentIceQ(){ return IQ[currentIceIdx()]; }
function pgIce(){
  var qi=currentIceIdx();
  var canBack=iceSkip>0;
  pc('<div class="iq-card" style="margin-bottom:20px">'
    +'<div class="iq-label">üí¨ this meeting\'s question</div>'
    +'<div class="iq-text">"'+IQ[qi]+'"</div>'
    +'<div class="iq-footer">'
    +'<span class="iq-tip">advances after each meeting is logged üåÄ</span>'
    +'<div style="display:flex;gap:8px">'
    +(canBack?'<button class="btn btn-g btn-sm" onclick="iceSkip--;pgIce()">‚Üê back</button>':'')
    +'<button class="btn btn-g btn-sm" onclick="iceSkip++;pgIce()">skip ‚Üí</button>'
    +'</div></div></div>'
    +'<div class="card"><div class="card-header"><span class="card-title">how to use this</span></div>'
    +'<div style="font-size:14px;color:var(--mid);line-height:1.8">'
    +'<p>üìå <strong>before your study:</strong> share this question and give everyone 1-2 minutes to think, then go around the group.</p>'
    +'<p style="margin-top:9px">üí° <strong>tip:</strong> the leader goes first to model vulnerability and set the tone.</p>'
    +'<p style="margin-top:9px">‚è±Ô∏è <strong>time:</strong> aim for 10-15 minutes max so you have time for your study.</p>'
    +'</div></div>'
    +'<div class="card"><div class="card-header"><span class="card-title">coming up</span></div>'
    +IQ.slice(qi+1,qi+4).map(function(q,i){
      return '<div style="padding:12px 0;border-bottom:1px solid var(--border);font-size:14px;color:var(--mid)">'
        +'<div style="font-size:11px;font-weight:600;color:var(--muted);margin-bottom:4px">in '+(i+1)+' meeting'+(i>0?'s':'')+'</div>'
        +'"'+q+'"</div>';
    }).join('')
    +'</div>');
}

/* ============================================================
   PAGE: SCHEDULING POLL
   ============================================================ */
// Unified slot list ‚Äî demo starts with sample data, real accounts start empty
var SCHED_SLOTS=DEMO?[
  {id:1,day:'Tuesday',date:'March 4',time:'7:30 PM',votes:4},
  {id:2,day:'Wednesday',date:'March 5',time:'7:00 PM',votes:6},
  {id:3,day:'Thursday',date:'March 6',time:'7:30 PM',votes:3},
  {id:4,day:'Saturday',date:'March 8',time:'10:00 AM',votes:2}
]:[];

function pgSched(){
  if(!DEMO&&!CU.groupId){pc(empty('üóìÔ∏è','no group yet','scheduling polls will be available once your group is set up.',''));return;}
  if(isLeader()) topAction(
    '<button class="btn btn-p btn-sm" onclick="modalAddSlot()">+ add time slot</button>'
    +(SCHED_SLOTS.length>0?'<button class="btn btn-s btn-sm" style="margin-left:8px" onclick="publishPoll()">üì¢ publish poll</button>':'')
  );
  pc('<div class="card"><div class="card-header"><span class="card-title">vote for the best time</span><span class="card-note">pick all that work for you</span></div>'
    +(SCHED_SLOTS.length===0
      ?'<div style="text-align:center;padding:28px;color:var(--muted)">no time slots yet'+(isLeader()?' ‚Äî add some above':'')+'.</div>'
      :SCHED_SLOTS.map(function(s){
        var maxVotes=Math.max.apply(null,SCHED_SLOTS.map(function(x){return x.votes||0}))||1;
        var pct=Math.round(((s.votes||0)/maxVotes)*100);
        var voted=votedSlots.has(s.id);
        return '<div class="poll-slot'+(voted?' voted':'')+'">'
          +'<div class="poll-bar-wrap">'
          +'<div class="poll-bar-label">'+s.day+' ¬∑ '+s.date+' at '+s.time+'</div>'
          +'<div class="poll-bar-bg"><div class="poll-bar-fill" style="width:'+pct+'%"></div></div>'
          +'<div class="poll-count">'+(s.votes||0)+' vote'+((s.votes||0)!==1?'s':'')+'</div>'
          +'</div>'
          +'<button class="poll-vote'+(voted?' voted':'')+'" onclick="toggleVote('+s.id+',this)">'+(voted?'‚úì voted':'vote')+'</button>'
          +(isLeader()?'<button onclick="deleteSlot('+s.id+')" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:2px 4px;margin-left:4px" title="remove slot">‚úï</button>':'')
          +'</div>';
      }).join(''))
    +'</div>');
}
function toggleVote(id,btn){
  var slot=SCHED_SLOTS.find(function(s){return s.id===id});
  if(votedSlots.has(id)){
    votedSlots.delete(id);
    btn.className='poll-vote'; btn.textContent='vote';
    btn.closest('.poll-slot').classList.remove('voted');
    if(slot) slot.votes=Math.max(0,(slot.votes||1)-1);
  } else {
    votedSlots.add(id);
    btn.className='poll-vote voted'; btn.textContent='‚úì voted';
    btn.closest('.poll-slot').classList.add('voted');
    if(slot) slot.votes=(slot.votes||0)+1;
  }
  // Update count and bar width in DOM without full re-render
  var maxVotes=Math.max.apply(null,SCHED_SLOTS.map(function(x){return x.votes||0}))||1;
  SCHED_SLOTS.forEach(function(s){
    var slotEl=btn.closest('.card');
    if(!slotEl) return;
    var allSlots=slotEl.querySelectorAll('.poll-slot');
    allSlots.forEach(function(el){
      var voteBtn=el.querySelector('.poll-vote');
      if(!voteBtn) return;
      var elId=parseInt(voteBtn.getAttribute('onclick').match(/\d+/)[0]);
      if(isNaN(elId)) return;
      var es=SCHED_SLOTS.find(function(x){return x.id===elId});
      if(!es) return;
      var countEl=el.querySelector('.poll-count');
      var barEl=el.querySelector('.poll-bar-fill');
      if(countEl) countEl.textContent=(es.votes||0)+' vote'+((es.votes||0)!==1?'s':'');
      if(barEl) barEl.style.width=Math.round(((es.votes||0)/maxVotes)*100)+'%';
    });
  });
  toast('vote saved ‚úÖ');
}
function deleteSlot(id){
  var idx=SCHED_SLOTS.findIndex(function(s){return s.id===id});
  if(idx>-1) SCHED_SLOTS.splice(idx,1);
  votedSlots.delete(id);
  pgSched();
}
function publishPoll(){
  toast('poll shared with your group üì¢');
}

/* ============================================================
   PAGE: LOCATION ROTATION
   ============================================================ */
var ROTATION=DEMO?[
  {n:'Marcus & Jenna T.',a:'5 Oak Lane'},{n:'Derek R.',a:'22 Pine St'},
  {n:'Amy C.',a:'101 Maple Ave'},{n:'Chris W.',a:'88 Birch Rd'}
]:[];
function pgRotation(){
  if(!DEMO&&!CU.groupId){pc(empty('üè°','location rotation','add group members\' addresses to rotate meeting locations.',''));return;}
  if(isLeader()) topAction('<button class="btn btn-p btn-sm" onclick="modalAddHost()">+ add host</button>');
  pc('<div class="card">'
    +'<div class="card-header"><span class="card-title">hosting rotation</span>'
    +'<span class="card-note">drag to reorder ‚Äî first is next up</span></div>'
    +(ROTATION.length===0
      ?'<div style="text-align:center;padding:24px;color:var(--muted)">no hosts added yet'+(isLeader()?' ‚Äî add some above':'')+'.</div>'
      :ROTATION.map(function(h,i){
        return '<div class="member-row" id="rot-'+i+'">'
          +'<div class="m-av" style="background:'+(i===0?'var(--accent)':'var(--brand)')+'">'+(i+1)+'</div>'
          +'<div style="flex:1"><div class="m-name">'+h.n+'</div><div class="m-role">'+h.a+'</div></div>'
          +(i===0?'<span class="badge badge-green">next up!</span>':'')
          +(isLeader()
            ?'<div style="display:flex;gap:4px;margin-left:8px">'
              +(i>0?'<button onclick="rotMove('+i+','+(i-1)+')" style="background:var(--bg);border:1.5px solid var(--border);border-radius:6px;padding:3px 8px;cursor:pointer;font-size:13px" title="move up">‚Üë</button>':'<span style="width:30px"></span>')
              +(i<ROTATION.length-1?'<button onclick="rotMove('+i+','+(i+1)+')" style="background:var(--bg);border:1.5px solid var(--border);border-radius:6px;padding:3px 8px;cursor:pointer;font-size:13px" title="move down">‚Üì</button>':'<span style="width:30px"></span>')
              +'<button onclick="rotRemove('+i+')" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:15px;padding:2px 6px" title="remove">‚úï</button>'
              +'</div>'
            :'')
          +'</div>';
      }).join(''))
    +'</div>');
}
function rotMove(from,to){
  var tmp=ROTATION[from]; ROTATION[from]=ROTATION[to]; ROTATION[to]=tmp;
  pgRotation();
}
function rotRemove(i){
  ROTATION.splice(i,1);
  pgRotation(); toast('host removed');
}

/* ============================================================
   PAGE: GROUP HEALTH ASSESSMENT
   ============================================================ */
var asmDone=false;
function pgAssess(){
  if(asmDone){pgHealthResults();return;}
  if(!DEMO&&!CU.groupId){pc(empty('üíö','group health','complete your first assessment to see how your group is doing.',''));return;}
  // Ministry leaders get a button to edit the survey questions
  var editBtn=CU.type==='ministry'
    ?'<button class="btn btn-g btn-sm" onclick="modalEditSurvey()">‚úèÔ∏è edit questions</button>':'';
  topAction(editBtn);
  pc('<div class="card">'
    +'<div style="font-family:\'DM Serif Display\',serif;font-size:22px;color:var(--dark);margin-bottom:6px">group health check-in</div>'
    +'<div style="font-size:14px;color:var(--muted);margin-bottom:24px">rate each area honestly - this helps your leader understand how the group is doing.</div>'
    +AQ.map(function(q,i){
      return '<div style="margin-bottom:22px">'
        +'<div style="font-size:14px;font-weight:500;color:var(--dark);margin-bottom:10px">'+(i+1)+'. '+q.q+'</div>'
        +'<div style="display:flex;align-items:center;gap:10px">'
        +'<span style="font-size:12px;color:var(--muted);width:80px;text-align:right">'+q.lo+'</span>'
        +'<div style="display:flex;gap:6px;flex:1;justify-content:center">'
        +[1,2,3,4,5].map(function(v){
          return '<button onclick="pickAsm('+i+','+v+',this)" id="asm-'+i+'-'+v+'" style="width:38px;height:38px;border-radius:50%;border:2px solid var(--border);background:transparent;font-size:14px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .18s">'+v+'</button>';
        }).join('')
        +'</div>'
        +'<span style="font-size:12px;color:var(--muted);width:80px">'+q.hi+'</span>'
        +'</div></div>';
    }).join('')
    +'<button class="btn btn-p btn-full" onclick="submitAssessment()">submit check-in</button>'
    +'</div>');
}
function pickAsm(qi,val,btn){
  asmAnswers[qi]=val;
  for(var v=1;v<=5;v++){
    var b=document.getElementById('asm-'+qi+'-'+v);
    if(b){b.style.background=v===val?'var(--brand)':'transparent';b.style.color=v===val?'#fff':'var(--muted)';b.style.borderColor=v===val?'var(--brand)':'var(--border)';}
  }
}
function submitAssessment(){
  if(Object.keys(asmAnswers).length<AQ.length){toast('please answer all questions üòä');return;}
  var total=Object.values(asmAnswers).reduce(function(a,b){return a+b},0);
  lastHealthScore=Math.round((total/(AQ.length*5))*100);
  // Store in GD stats so milestones can see it
  if(GD&&GD.stats) GD.stats.health=lastHealthScore;
  asmDone=true; pgHealthResults();
}
function pgHealthResults(){
  var total=Object.values(asmAnswers).reduce(function(a,b){return a+b},0);
  var pct=lastHealthScore||Math.round((total/(AQ.length*5))*100);
  var cls=pct>=80?'var(--brand)':pct>=60?'var(--accent)':'#E74C3C';
  pc('<div class="card" style="text-align:center;padding:32px 24px;margin-bottom:18px">'
    +'<div style="font-size:54px;font-weight:700;color:'+cls+';font-family:\'DM Serif Display\',serif">'+pct+'%</div>'
    +'<div style="font-size:16px;font-weight:600;color:var(--dark);margin-top:4px">overall group health</div>'
    +'<div style="font-size:14px;color:var(--muted);margin-top:6px">'+(pct>=80?'your group is thriving!':pct>=60?'good, with room to grow.':'some areas need attention.')+'</div>'
    +'</div>'
    +'<div class="card">'
    +AQ.map(function(q,i){
      var v=asmAnswers[i]||3;
      return '<div style="margin-bottom:16px">'
        +'<div style="font-size:13px;color:var(--dark);margin-bottom:6px">'+q.q+'</div>'
        +healthBar('',Math.round((v/5)*100))
        +'</div>';
    }).join('')
    +'<button class="btn btn-s btn-sm mt-10" onclick="asmDone=false;asmAnswers={};pgAssess()">retake assessment</button>'
    +'</div>');
}

/* ============================================================
   PAGE: MILESTONES
   ============================================================ */
function pgMiles(){
  if(!DEMO&&!CU.groupId){pc(empty('üèÜ','milestones','your group\'s milestones and badges will appear here as you meet together.',''));return;}
  // Always use actual GD ‚Äî GD is populated for both demo and real users once a group exists
  var g=GD||{start:new Date().toISOString(),stats:{meetings:0,answered:0,books:0}};
  var yearsNum=yrs(g.start||new Date().toISOString());
  var stats=g.stats||{meetings:0,answered:0,books:0};
  var visible=computeMilestones(stats,yearsNum,DEMO?82:0);

  var earned=visible.filter(function(m){return m.earned;});
  var upcoming=visible.filter(function(m){return !m.earned&&m.type!=='special'&&m.type!=='serving';});
  var serving=visible.filter(function(m){return m.type==='serving';});
  // spirit-led (type==='special') hidden for phase 2

  var typeLabels={meetings:'meetings',years:'time together',prayers:'prayer',answered:'answered prayer',books:'studies',health:'group health',serving:'service'};

  // Group upcoming by type for nicer display
  var upByType={};
  upcoming.forEach(function(m){if(!upByType[m.type])upByType[m.type]=[];upByType[m.type].push(m);});

  pc('<div class="card" style="margin-bottom:18px;background:linear-gradient(135deg,var(--brand-p),#fff);border-color:var(--brand-l)">'
    +'<div class="card-header"><span class="card-title">üåü your journey</span></div>'
    +'<div class="g4">'
    +'<div style="text-align:center;padding:14px;background:rgba(255,255,255,.7);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:28px;color:var(--dark)">'+stats.meetings+'</div><div style="font-size:12px;color:var(--muted)">meetings</div></div>'
    +'<div style="text-align:center;padding:14px;background:rgba(255,255,255,.7);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:28px;color:var(--dark)">'+yearsNum+'</div><div style="font-size:12px;color:var(--muted)">years together</div></div>'
    +'<div style="text-align:center;padding:14px;background:rgba(255,255,255,.7);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:28px;color:var(--dark)">'+stats.answered+'</div><div style="font-size:12px;color:var(--muted)">answered ‚ú®</div></div>'
    +'<div style="text-align:center;padding:14px;background:rgba(255,255,255,.7);border-radius:var(--rsm)"><div style="font-family:\'DM Serif Display\',serif;font-size:28px;color:var(--dark)">'+earned.length+'</div><div style="font-size:12px;color:var(--muted)">badges earned</div></div>'
    +'</div></div>'

    // EARNED
    +(earned.length>0
      ?'<div class="sec-label">üèÜ earned badges ('+earned.length+')</div>'
        +'<div class="badge-grid" style="margin-bottom:22px">'
        +earned.map(function(b){
          return '<div class="milestone earned">'
            +'<div class="milestone-em">'+b.em+'</div>'
            +'<div class="milestone-name">'+b.n+'</div>'
            +'<div class="milestone-desc">'+b.d+'</div>'
            +'</div>';
        }).join('')
        +'</div>'
      :'')

    // UPCOMING (grouped by category)
    +(Object.keys(upByType).length>0
      ?'<div class="sec-label">üéØ next up ‚Äî keep going!</div>'
        +Object.keys(upByType).map(function(type){
          return '<div style="margin-bottom:18px">'
            +'<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--brand);margin-bottom:10px">'+typeLabels[type]+'</div>'
            +'<div class="badge-grid">'
            +upByType[type].map(function(b){
              var progVal=type==='meetings'?stats.meetings:type==='years'?yearsNum:type==='answered'?stats.answered:type==='books'?stats.books:0;
              var pct=b.threshold?Math.min(100,Math.round((progVal/b.threshold)*100)):0;
              return '<div class="milestone" style="border-style:dashed;opacity:.85">'
                +'<div class="milestone-em" style="opacity:.5">'+b.em+'</div>'
                +'<div class="milestone-name">'+b.n+'</div>'
                +'<div class="milestone-desc">'+b.d+'</div>'
                +(b.threshold
                  ?'<div style="margin-top:8px"><div style="height:4px;background:var(--border);border-radius:2px"><div style="height:100%;width:'+pct+'%;background:var(--brand-l);border-radius:2px;transition:width .4s"></div></div>'
                    +'<div style="font-size:10px;color:var(--muted);margin-top:3px">'+progVal+' / '+b.threshold+'</div></div>'
                  :'')
                +'</div>';
            }).join('')
            +'</div></div>';
        }).join('')
      :'')

    // SERVING MILESTONES
    +'<div class="sec-label">ü´∂ serving together</div>'
    +'<div style="font-size:13px;color:var(--mid);margin-bottom:12px;line-height:1.6">mark these when your group completes a service project together.'+(isLeader()?'':' your leader can mark these.')+'</div>'
    +'<div class="badge-grid">'
    +serving.map(function(b){
      return '<div class="milestone'+(b.earned?' earned':'')+'" '
        +(isLeader()?'onclick="toggleSpecial(\''+b.n+'\')" style="cursor:pointer" title="click to mark this milestone"':'')+' >'
        +'<div class="milestone-em">'+b.em+'</div>'
        +'<div class="milestone-name">'+b.n+'</div>'
        +'<div class="milestone-desc">'+b.d+'</div>'
        +(b.earned?'<div style="font-size:10px;color:var(--brand);margin-top:4px;font-weight:600">‚úì completed!</div>'
          :(isLeader()?'<div style="font-size:10px;color:var(--muted);margin-top:4px">click to mark done</div>':''))
        +'</div>';
    }).join('')
    +'</div>');
}

function toggleSpecial(name){
  specialEarned[name]=!specialEarned[name];
  toast(specialEarned[name]?'üéâ "'+name+'" milestone awarded!':'"'+name+'" milestone removed');
  pgMiles();
}

/* ============================================================
   PAGE: STUDY RESOURCES
   ============================================================ */
var bibleFilter='all';
function pgResources(){
  if(isLeader()) topAction('<button class="btn btn-p btn-sm" onclick="modalAddRes(\'group\')">+ add resource</button>');
  var grpRes=CU.groupResources||[];
  var minRes=getMinistryResources();

  pc((GD&&GD.study
    ?'<div class="invite-card" style="margin-bottom:18px">'
      +'<div class="invite-label">üìñ currently studying</div>'
      +'<div style="font-size:16px;font-weight:600;color:var(--dark);margin-bottom:4px">'+GD.study+'</div>'
      +(GD.hw?'<div style="font-size:13px;color:var(--mid);margin-bottom:10px"><strong>homework:</strong> '+GD.hw+'</div>':'')
      +(isLeader()?'<button class="btn btn-s btn-sm" onclick="modalEditMeeting()">edit study details</button>':'')
      +'</div>'
    :'')
    +'<div class="card" style="margin-bottom:18px;background:linear-gradient(135deg,#FFF3E0,#FFF8F0);border-color:var(--accent-l)">'
    +'<div class="card-title" style="color:var(--accent);margin-bottom:8px">üß≠ get a recommendation</div>'
    +'<div style="font-size:14px;color:var(--mid);margin-bottom:12px">not sure what to study next? answer 3 quick questions and we\'ll suggest something.</div>'
    +'<button class="btn btn-a btn-sm" onclick="modalStudyQuiz()">get a recommendation ‚Üí</button>'
    +'</div>'
    // Ministry resources section (shared by all groups)
    +(minRes.length>0
      ?'<div class="sec-label">üìå ministry resources</div>'
        +'<div style="font-size:13px;color:var(--mid);margin-bottom:12px">added by your ministry leader ‚Äî available to all groups</div>'
        +minRes.map(function(r){return resCardHtml(r,isLeader(),false);}).join('')
      :'')
    // Group-specific resources
    +(grpRes.length>0
      ?'<div class="sec-label" style="margin-top:6px">üìÇ group resources</div>'
        +grpRes.map(function(r){return resCardHtml(r,isLeader(),false);}).join('')
      :'')
    // Bible books
    +'<div class="sec-label" style="margin-top:6px">üìñ books of the bible</div>'
    +'<div class="tabs" id="bible-tabs" style="margin-bottom:14px">'
    +'<div class="tab'+(bibleFilter==='all'?' active':'')+'" onclick="filterBible(\'all\',this)">all (66)</div>'
    +'<div class="tab'+(bibleFilter==='OT'?' active':'')+'" onclick="filterBible(\'OT\',this)">old testament (39)</div>'
    +'<div class="tab'+(bibleFilter==='NT'?' active':'')+'" onclick="filterBible(\'NT\',this)">new testament (27)</div>'
    +'</div>'
    +'<div id="bible-grid">'
    +bibleHtml(BIBLE_BOOKS)
    +'</div>');
}
function bibleHtml(list){
  return list.map(function(b){
    var sessions=BOOK_SESSION_COUNTS[b.title]||3;
    var safe=b.title.replace(/'/g,"\\'");
    return '<div class="res-card">'
      +'<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">'
      +'<div style="flex:1">'
      +'<div class="res-type">'+b.t+' ¬∑ '+sessions+'-session study</div>'
      +'<div class="res-title">'+b.title+'</div>'
      +'<div class="res-desc">'+b.desc+'</div>'
      +'<div class="res-tags">'+b.tags.map(function(t){return '<span class="chip">'+t+'</span>'}).join('')+'</div>'
      +'</div>'
      +'</div>'
      +'<div class="res-actions" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">'
      +'<button class="btn btn-p btn-sm" onclick="viewStudyGuide(\''+safe+'\',\'resources\')">üìñ view study guide</button>'
      +(isLeader()?'<button class="btn btn-g btn-sm" onclick="setStudy(\''+safe+'\')">‚úì set as current study</button>':'')
      +'</div>'
      +'</div>';
  }).join('');
}
function filterBible(f,el){
  bibleFilter=f;
  document.querySelectorAll('#bible-tabs .tab').forEach(function(t){t.classList.remove('active')});
  el.classList.add('active');
  var list=f==='all'?BIBLE_BOOKS:BIBLE_BOOKS.filter(function(b){return b.t===f});
  document.getElementById('bible-grid').innerHTML=bibleHtml(list);
}
function setStudy(title){
  if(!GD) GD={name:'',start:'',next:{},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  GD.study=title;
  GD._studySession=0; // always reset to session 1 when switching studies
  // Auto-populate homework from first session (works for both bible studies and ministry resources)
  var study=getStudyForTitle(title);
  if(study&&study.sessions&&study.sessions.length>0){
    var s0=study.sessions[0];
    GD.hw='üìñ '+s0.reading+(s0.assignment?' ‚Äî '+s0.assignment:(s0.assignment||''));
  }
  autoSave();
  toast('"'+title+'" set as current study üìñ');
  pgResources();
}

/* ============================================================
   PAGE: MANAGE MEMBERS
   ============================================================ */
function pgMembers(){
  var code=DEMO?'GRP-THUR':(CU.groupCode||(CU.groupCode=genCode('GRP')));
  var realMembers=DEMO?DEMO_MEMBERS.filter(function(m){return m.real}):(CU.groupRealMembers||[]);
  var placeholders=DEMO?DEMO_MEMBERS.filter(function(m){return !m.real}):(CU.placeholderMembers||[]);
  var all=realMembers.concat(placeholders);
  topAction('<button class="btn btn-s btn-sm" style="margin-right:8px" onclick="modalAddPlaceholder()">+ add member</button>'
    +'<button class="btn btn-p btn-sm" onclick="modalInviteCode()">üîó invite code</button>');
  pc('<div class="invite-card" style="margin-bottom:18px">'
    +'<div class="invite-label">group invite code</div>'
    +'<div class="invite-code">'+code+'</div>'
    +'<div class="invite-note">share this with anyone you want in your group - they\'ll enter it when creating their account</div>'
    +'<button class="btn btn-p btn-sm" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'code copied! üìã\')">copy code</button>'
    +'</div>'
    +'<div class="card">'
    +'<div class="card-header"><span class="card-title">members ('+all.length+')</span></div>'
    +(all.length===0
      ?'<div style="text-align:center;padding:24px;color:var(--muted);font-size:14px">no members yet - share your invite code or add a placeholder above.</div>'
      :all.map(function(m){
        var placeholder=!m.real;
        return '<div class="member-row">'
          +'<div class="m-av'+(placeholder?' placeholder':'')+'">'+(placeholder?'?':m.i)+'</div>'
          +'<div style="flex:1"><div class="m-name">'+m.n+(placeholder?' <span style="font-size:11px;font-weight:400;color:var(--muted)">(placeholder)</span>':'')+'</div>'
          +'<div class="m-role">'+m.r+'</div></div>'
          +'<div class="m-actions">'
          +(placeholder
            ?'<span class="badge badge-grey">not yet joined</span>'
              +'<button class="btn btn-g btn-sm" onclick="modalEditRolePlaceholder(\''+m.n.replace(/'/g,"\\'")+'\')">edit role</button>'
              +'<button class="btn btn-g btn-sm" onclick="modalMergePlaceholder(\''+m.n.replace(/'/g,"\\'")+'\')">merge</button>'
              +'<button class="btn btn-g btn-sm" onclick="removePlaceholder(\''+m.n.replace(/'/g,"\\'")+'\')">remove</button>'
            :'<span class="badge badge-green">‚úì joined</span><button class="btn btn-g btn-sm" onclick="modalEditRole(\''+m.n.replace(/'/g,"\\'")+'\')">edit role</button>')
          +'</div></div>';
      }).join(''))
    +'</div>');
}
function removePlaceholder(name){
  CU.placeholderMembers=(CU.placeholderMembers||[]).filter(function(m){return m.n!==name});
  DEMO_MEMBERS.splice(DEMO_MEMBERS.findIndex(function(m){return m.n===name&&!m.real}),1);
  pgMembers(); toast('placeholder removed');
}

function modalMergePlaceholder(placeholderName){
  var realMembers=DEMO?DEMO_MEMBERS.filter(function(m){return m.real}):(CU.groupRealMembers||[]);
  openModal(mClose()
    +'<h2>üîó merge with real account</h2>'
    +'<div class="modal-sub">When a member joins using your invite code, link their real account to the placeholder <strong>'+placeholderName+'</strong> so their history and attendance carries over.</div>'
    +'<div class="fg"><label>real member\'s name (as they appear in your member list)</label>'
    +'<select id="merge-real">'
    +(realMembers.length===0
      ?'<option value="">no real members yet ‚Äî share your invite code first</option>'
      :realMembers.map(function(m){return '<option value="'+m.n+'">'+m.n+'</option>'}).join(''))
    +'</select></div>'
    +'<div class="banner banner-green" style="margin-top:4px">üí° the placeholder\'s name, role, and attendance history will be merged into the real account.</div>'
    +(realMembers.length>0
      ?'<button class="btn btn-p btn-full" onclick="doMerge(\''+placeholderName.replace(/'/g,"\\'")+'\')">merge accounts</button>'
      :'<button class="btn btn-g btn-full" onclick="closeModal()">ok, got it</button>')
  );
}
function doMerge(placeholderName){
  var sel=document.getElementById('merge-real');
  if(!sel||!sel.value){toast('please select a real member üòä');return;}
  var realName=sel.value;

  // Find placeholder data
  var phArr=DEMO?DEMO_MEMBERS:(CU.placeholderMembers||[]);
  var ph=phArr.find(function(m){return m.n===placeholderName&&m.real===false});

  // Find real member
  var realArr=DEMO?DEMO_MEMBERS:(CU.groupRealMembers||[]);
  var real=realArr.find(function(m){return m.n===realName&&m.real!==false});

  if(ph&&real){
    // Copy role from placeholder if real member has no custom role
    if(ph.r&&(!real.r||real.r==='group member')) real.r=ph.r;
    // Mark placeholder merged (remove it)
    if(DEMO){
      var idx=DEMO_MEMBERS.findIndex(function(m){return m.n===placeholderName&&!m.real});
      if(idx>-1) DEMO_MEMBERS.splice(idx,1);
    } else {
      CU.placeholderMembers=(CU.placeholderMembers||[]).filter(function(m){return m.n!==placeholderName});
    }
  }
  closeModal(); pgMembers();
  toast('‚úÖ '+placeholderName+' merged into '+realName+'\'s account');
}

/* ============================================================
   MODALS
   ============================================================ */
function mClose(){return '<button class="modal-close" onclick="closeModal()">‚úï</button>';}

function modalCreateGroup(){
  openModal(mClose()+'<h2>üë• create your group</h2>'
    +'<div class="fg"><label>group name</label><input type="text" id="cg-name" placeholder="e.g. Thursday Night Crew"></div>'
    +'<div class="fg"><label>when did your group start?</label><input type="date" id="cg-start" value="'+new Date().toISOString().split('T')[0]+'"></div>'
    +'<div class="banner banner-green">üí° if your group started in the past, enter the real start date - you\'ll instantly earn milestone badges!</div>'
    +'<div class="fg"><label>meeting day</label><select id="cg-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>'
    +'<div class="fg"><label>next meeting date</label><input type="date" id="cg-date" value="'+nextDateForDay(new Date().getDay())+'"></div>'
    +'<div class="fg"><label>meeting time</label><select id="cg-time">'+timeOptions()+'</select></div>'
    +'<div class="fg"><label>how often does your group meet?</label><select id="cg-freq"><option>weekly</option><option>every other week</option><option>monthly</option><option>irregular / varies</option></select></div>'
    +'<button class="btn btn-p btn-full" onclick="doCreateGroup()">create group üéâ</button>');
}

async function doCreateGroup(){
  var name=document.getElementById('cg-name').value.trim();
  if(!name){toast('please enter a group name üòä');return;}
  var start=document.getElementById('cg-start').value;
  var day=document.getElementById('cg-day').value;
  var date=document.getElementById('cg-date').value;
  var time=document.getElementById('cg-time').value;
  var freq=document.getElementById('cg-freq').value;

  // Use the leader's own user ID as the group ID ‚Äî simple, reliable, no extra table needed.
  // Members store this ID in their profiles.group_id to link to this group.
  CU.groupId=CU.id;
  // Also update profiles.group_id in Supabase so it survives without app_data column
  if(CU.id){
    sb.from('profiles').update({group_id:CU.id}).eq('id',CU.id).then(function(){}).catch(function(){});
  }

  GD={name:name,start:start,next:{day:day,date:date,time:time,loc:'',freq:freq},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  closeModal();
  autoSave();
  goPage(CU.type==='ministry'?'grp-home':'home');
  toast('group created! üéâ');
}

function modalRenameGroup(){
  if(!GD) return;
  openModal(mClose()+'<h2>‚úèÔ∏è rename group</h2>'
    +'<div class="fg"><label>group name</label><input type="text" id="rg-name" value="'+GD.name+'" placeholder="e.g. Thursday Night Crew"></div>'
    +'<button class="btn btn-p btn-full" onclick="saveGroupName()">save name</button>');
}
function saveGroupName(){
  var name=document.getElementById('rg-name').value.trim();
  if(!name){toast('please enter a group name üòä');return;}
  GD.name=name;
  autoSave();
  closeModal();
  toast('group renamed to "'+name+'" ‚úÖ');
  pgGrpHome();
}

function modalMarkMeetingDone(){
  var study=GD&&GD.study?getStudyForTitle(GD.study):null;
  var si=GD&&GD._studySession!=null?GD._studySession:0;
  var hasNext=study&&study.sessions&&si<study.sessions.length-1;
  var nextSession=hasNext?study.sessions[si+1]:null;
  openModal(mClose()+'<h2>‚úÖ meeting complete!</h2>'
    +'<div class="modal-sub">great job meeting together. '+(hasNext?'here\'s what\'s up next in your study:':'you\'ve completed all sessions in this study!')+'</div>'
    +(nextSession
      ?'<div style="background:var(--brand-p);border:1px solid var(--brand-l);border-radius:var(--rsm);padding:14px;margin-bottom:16px">'
        +'<div style="font-size:11px;font-weight:600;color:var(--brand);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">next up ‚Äî session '+(si+2)+'</div>'
        +'<div style="font-size:15px;font-weight:600;color:var(--dark);margin-bottom:4px">'+nextSession.title+'</div>'
        +'<div style="font-size:13px;color:var(--mid)">üìñ '+nextSession.reading+'</div>'
        +'</div>'
      :'<div class="banner banner-green" style="margin-bottom:16px">üéâ your group has completed the entire study! time to pick a new one.</div>')
    +(hasNext
      ?'<button class="btn btn-p btn-full" onclick="doMarkMeetingDone()">advance to session '+(si+2)+' ‚Üí</button>'
      :'<button class="btn btn-p btn-full" onclick="goPage(\'resources\');closeModal()">pick a new study ‚Üí</button>')
    +'<button class="btn btn-g btn-full" style="margin-top:8px" onclick="closeModal()">close</button>');
}
function doMarkMeetingDone(){
  if(!GD) return;
  var study=GD.study?getStudyForTitle(GD.study):null;
  if(!study||!study.sessions) return;
  var si=GD._studySession!=null?GD._studySession:0;
  var nextSi=Math.min(si+1,study.sessions.length-1);
  // Update stats
  if(!GD.stats) GD.stats={meetings:0,answered:0,books:0};
  GD.stats.meetings=(GD.stats.meetings||0)+1;
  // Advance session and pre-fill homework for next session
  GD._studySession=nextSi;
  var nextS=study.sessions[nextSi];
  GD.hw='üìñ '+nextS.reading+(nextS.assignment?' ‚Äî '+nextS.assignment:'');
  autoSave();
  closeModal();
  toast('session '+(nextSi+1)+' unlocked ‚Äî homework updated! üìñ');
  var active=document.querySelector('.ni.active');
  if(active) goPage(active.id.replace('ni-',''));
}

function modalEditMeeting(){
  var n=GD&&GD.next?GD.next:{};
  var todayVal=n.date||new Date().toISOString().split('T')[0];
  var studyName=GD&&GD.study?GD.study:'';
  var study=studyName?getStudyForTitle(studyName):null;
  var sessionNav='';
  if(study&&study.sessions&&study.sessions.length>0){
    var si=GD._studySession||0;
    var s=study.sessions[si];
    sessionNav='<div style="background:var(--brand-p);border:1px solid var(--brand-l);border-radius:var(--rsm);padding:12px 14px;margin-bottom:10px">'
      +'<div style="font-size:11px;font-weight:600;color:var(--brand);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">study guide ‚Äî session '+(si+1)+' of '+study.sessions.length+'</div>'
      +'<div style="font-size:14px;font-weight:600;color:var(--dark);margin-bottom:4px">'+s.title+'</div>'
      +'<div style="font-size:13px;color:var(--mid);margin-bottom:10px">üìñ '+s.reading+'</div>'
      +'<div style="display:flex;gap:8px">'
      +(si>0?'<button type="button" class="btn btn-g btn-sm" onclick="changeStudySession(-1)">‚Üê prev session</button>':'')
      +(si<study.sessions.length-1?'<button type="button" class="btn btn-g btn-sm" onclick="changeStudySession(1)">next session ‚Üí</button>':'')
      +'<button type="button" class="btn btn-s btn-sm" onclick="useThisSession('+si+')">use this session ‚Üì</button>'
      +'</div></div>';
  }
  openModal(mClose()+'<h2>üìÖ edit meeting details</h2>'
    +'<div class="fg"><label>meeting day</label>'
    +'<select id="em-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>'
    +'<div class="fg"><label>next meeting date</label><input type="date" id="em-date" value="'+todayVal+'"></div>'
    +'<div class="fg"><label>meeting time</label><select id="em-time">'+timeOptions()+'</select></div>'
    +'<div class="fg"><label>location / host name</label><input type="text" id="em-loc" value="'+(n.loc||'')+'" placeholder="e.g. Marcus & Jenna\'s"></div>'
    +'<div class="fg"><label>frequency</label>'
    +'<select id="em-freq"><option>weekly</option><option>every other week</option><option>monthly</option><option>irregular / varies</option></select></div>'
    +'<hr class="divider">'
    +'<div style="font-size:13px;font-weight:600;color:var(--dark);margin-bottom:12px">üìñ study & homework</div>'
    +sessionNav
    +'<div class="fg"><label>current study / book</label><input type="text" id="em-study" value="'+studyName+'" placeholder="e.g. James, The Chosen Season 1"></div>'
    +'<div class="fg"><label>homework / reading for next meeting</label><textarea rows="3" id="em-hw" placeholder="e.g. read chapters 3-4 and journal...">'+(GD&&GD.hw?GD.hw:'')+'</textarea></div>'
    +'<button class="btn btn-p btn-full" onclick="saveMeeting()">save changes</button>');
  setTimeout(function(){
    var ds=document.getElementById('em-day');
    var ts=document.getElementById('em-time');
    var fs=document.getElementById('em-freq');
    if(ds&&n.day) Array.from(ds.options).forEach(function(o){if(o.value===n.day)o.selected=true;});
    if(ts&&n.time) Array.from(ts.options).forEach(function(o){if(o.value===n.time)o.selected=true;});
    if(fs&&n.freq) Array.from(fs.options).forEach(function(o){if(o.value===n.freq)o.selected=true;});
  },50);
}
function changeStudySession(dir){
  if(!GD) return;
  var study=GD.study?getStudyForTitle(GD.study):null;
  if(!study) return;
  var si=Math.max(0,Math.min(study.sessions.length-1,(GD._studySession||0)+dir));
  GD._studySession=si;
  modalEditMeeting();
}
function useThisSession(si){
  if(!GD) return;
  var study=GD.study?getStudyForTitle(GD.study):null;
  if(!study||!study.sessions[si]) return;
  var s=study.sessions[si];
  var hwEl=document.getElementById('em-hw');
  if(hwEl) hwEl.value='üìñ '+s.reading+(s.assignment?' ‚Äî '+s.assignment:'');
}
function saveMeeting(){
  if(!GD) GD={name:'',start:'',next:{},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  var newStudy=document.getElementById('em-study').value;
  var studyChanged=newStudy!==GD.study;
  GD.next={
    day:document.getElementById('em-day').value,
    date:document.getElementById('em-date').value,
    time:document.getElementById('em-time').value,
    loc:document.getElementById('em-loc').value,
    freq:document.getElementById('em-freq').value
  };
  GD.study=newStudy;
  GD.hw=document.getElementById('em-hw').value;
  // If study changed, reset to session 0; otherwise session was already set by user interaction
  if(studyChanged){ GD._studySession=0; }
  closeModal();
  toast('meeting details saved üìÖ');
  autoSave();
  var active=document.querySelector('.ni.active');
  if(active) goPage(active.id.replace('ni-',''));
}

function modalAddPrayer(){
  openModal(mClose()+'<h2>üôè add a prayer request</h2>'
    +'<div class="fg"><label>your prayer request</label><textarea rows="4" id="np" placeholder="share what\'s on your heart..."></textarea></div>'
    +'<div class="fg"><label>category (optional)</label><select><option>general</option><option>health</option><option>relationships</option><option>work / finances</option><option>praise & gratitude</option></select></div>'
    +'<button class="btn btn-p btn-full" onclick="submitPrayer()">post prayer request üôè</button>');
}
function submitPrayer(){
  var t=document.getElementById('np').value.trim();
  if(!t){toast('please write your prayer request üòä');return;}
  // Always save locally ‚Äî this is the source of truth
  PRAYERS.unshift({id:Date.now(),au:CU.name,txt:t,dt:'just now',ans:false,cnt:0,prayed:false});
  closeModal(); pgPrayers(); toast('prayer request posted üôè');
  autoSave();
}

function modalMarkAnswered(id){
  var p=PRAYERS.find(function(x){return x.id===id});
  if(!p) return;
  openModal(mClose()+'<h2>üéâ mark as answered</h2>'
    +'<div class="modal-sub">'+p.txt+'</div>'
    +'<div class="fg"><label>how did God answer this prayer?</label><textarea rows="3" id="ans-note" placeholder="share what happened (optional)..."></textarea></div>'
    +'<button class="btn btn-p btn-full" onclick="doMarkAnswered('+id+')">mark answered ‚ú®</button>');
}
function doMarkAnswered(id){
  var p=PRAYERS.find(function(x){return x.id===id});
  if(p){p.ans=true;p.anote=document.getElementById('ans-note').value;}
  closeModal(); pgPrayers(); toast('answered prayer logged! üéâ');
  autoSave();
}

function modalAddPlaceholder(){
  openModal(mClose()+'<h2>üë§ add a member</h2>'
    +'<div class="modal-sub">add someone as a placeholder until they create their groupify account.</div>'
    +'<div class="fg"><label>full name</label><input type="text" id="ph-name" placeholder="e.g. Sarah Johnson"></div>'
    +'<div class="fg"><label>role</label><select id="ph-role">'+MEMBER_ROLES.map(function(r){return '<option>'+r+'</option>'}).join('')+'</select></div>'
    +'<button class="btn btn-p btn-full" onclick="savePlaceholder()">add member</button>');
}
function savePlaceholder(){
  var name=document.getElementById('ph-name').value.trim();
  var role=document.getElementById('ph-role').value;
  if(!name){toast('please enter a name üòä');return;}
  if(!CU.placeholderMembers) CU.placeholderMembers=[];
  CU.placeholderMembers.push({n:name,r:role,real:false});
  if(DEMO) DEMO_MEMBERS.push({n:name,r:role,i:initials(name),real:false});
  closeModal(); pgMembers(); toast(name+' added üë§');
  autoSave();
}

function modalEditRole(name){
  var realArr=DEMO?DEMO_MEMBERS:(CU.groupRealMembers||[]);
  var m=realArr.find(function(x){return x.n===name});
  var cur=m?m.r:'group member';
  openModal(mClose()+'<h2>edit role</h2>'
    +'<div class="fg"><label>role for '+name+'</label>'
    +'<select id="er-role">'+MEMBER_ROLES.map(function(r){return '<option'+(r===cur?' selected':'')+'>'+r+'</option>'}).join('')+'</select></div>'
    +'<button class="btn btn-p btn-full" onclick="saveRole(\''+name.replace(/'/g,"\\'")+'\',false)">save</button>');
}
function modalEditRolePlaceholder(name){
  var phArr=DEMO?DEMO_MEMBERS:(CU.placeholderMembers||[]);
  var m=phArr.find(function(x){return x.n===name&&x.real===false});
  var cur=m?m.r:'group member';
  openModal(mClose()+'<h2>edit role</h2>'
    +'<div class="fg"><label>role for '+name+'</label>'
    +'<select id="er-role">'+MEMBER_ROLES.map(function(r){return '<option'+(r===cur?' selected':'')+'>'+r+'</option>'}).join('')+'</select></div>'
    +'<button class="btn btn-p btn-full" onclick="saveRole(\''+name.replace(/'/g,"\\'")+'\',true)">save</button>');
}
function saveRole(name, isPlaceholder){
  var role=document.getElementById('er-role').value;
  if(isPlaceholder){
    var phArr=DEMO?DEMO_MEMBERS:(CU.placeholderMembers||[]);
    var m=phArr.find(function(x){return x.n===name&&x.real===false});
    if(m) m.r=role;
  } else {
    var realArr=DEMO?DEMO_MEMBERS:(CU.groupRealMembers||[]);
    var m=realArr.find(function(x){return x.n===name});
    if(m) m.r=role;
  }
  closeModal(); pgMembers(); toast('role updated ‚úÖ');
  autoSave();
}

// Called automatically on first login when user signed up with a group invite code.
// Finds the leader who owns that code and adds this member to their group.
// Find the leader who owns a given group invite code.
// Returns {id, full_name, data} or null.
async function findLeaderByCode(code){
  if(!code||!sb) return null;
  code=code.trim().toUpperCase();

  // DEBUG: check auth session first
  var sessionInfo='unknown';
  try{
    var sess=await sb.auth.getSession();
    sessionInfo=sess.data&&sess.data.session?'logged in as '+sess.data.session.user.email:'NO SESSION';
  }catch(e){ sessionInfo='session error: '+e.message; }

  // Fetch all leader/ministry profiles ‚Äî only columns that actually exist
  var {data:allProfiles, error:allErr}=await sb.from('profiles').select('id,full_name,role,app_data');

  // DEBUG modal ‚Äî remove after invite code is confirmed working
  var lines=[
    '<b>Auth:</b> '+sessionInfo+'<br>',
    '<b>Searching for:</b> '+code+'<br>',
    '<b>Error:</b> '+(allErr?allErr.message:'none')+'<br>',
    '<b>Rows returned:</b> '+((allProfiles||[]).length)+'<br><br>'
  ];
  (allProfiles||[]).forEach(function(pr){
    var appData={};
    try{ if(pr.app_data) appData=JSON.parse(pr.app_data); }catch(e){}
    var deterCode='';
    try{ deterCode=genCode('GRP',pr.id+'_grp'); }catch(e){}
    lines.push(
      '<div style="border:1px solid #ccc;padding:6px;margin-bottom:6px;font-size:11px;text-align:left">'
      +'<b>'+pr.full_name+'</b> ('+pr.role+')<br>'
      +'app_data.groupCode: '+(appData.groupCode||'null')+'<br>'
      +'deterCode: '+deterCode+'<br>'
      +'match appData: '+(appData.groupCode===code)+' | match deter: '+(deterCode===code)
      +'</div>'
    );
  });
  openModal('<div style="max-height:70vh;overflow-y:auto;padding:8px;text-align:left">'+lines.join('')+'<button class="btn btn-p btn-full" onclick="closeModal()">close</button></div>');

  if(allErr){ return null; }

  // Match app_data.groupCode
  for(var i=0;i<(allProfiles||[]).length;i++){
    var pr=allProfiles[i];
    if(pr.role==='leader'||pr.role==='ministry'){
      try{
        var d=pr.app_data?JSON.parse(pr.app_data):{};
        if(d.groupCode===code) return {id:pr.id, name:pr.full_name, data:d};
      }catch(e){}
    }
  }
  // Fallback: deterministic code (user hasn't logged in since deterministic fix)
  for(var i=0;i<(allProfiles||[]).length;i++){
    var pr=allProfiles[i];
    if((pr.role==='leader'||pr.role==='ministry') && genCode('GRP',pr.id+'_grp')===code){
      var d2={};
      try{ if(pr.app_data) d2=JSON.parse(pr.app_data); }catch(e){}
      return {id:pr.id, name:pr.full_name, data:d2};
    }
  }
  return null;
}

async function autoJoinGroup(code){
  if(!code||!sb) return;
  try{
    var leader=await findLeaderByCode(code);
    if(!leader){ console.log('autoJoinGroup: no leader found for code',code); return; }

    // Write to the member's OWN profiles row ‚Äî this is reliable because the column exists
    // group_id = leader's user ID, so the leader can find this member by querying profiles
    var r=await sb.from('profiles').update({group_id:leader.id}).eq('id',CU.id);
    if(r.error){ console.log('autoJoinGroup profile update error:',r.error.message); }

    // Set state in memory
    CU.groupId=leader.id;
    GD=leader.data.GD||{name:'',start:'',next:{day:'',time:'',loc:'',freq:'weekly'},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};

    // Clear the pending code from auth metadata so this doesn't re-run on next login
    sb.auth.updateUser({data:{group_code:''}}).then(function(){}).catch(function(){});

  }catch(e){ console.log('autoJoinGroup error:',e); }
}

function modalJoinGroup(){
  openModal(mClose()+'<h2>üîó join a group</h2>'
    +'<div class="modal-sub">enter the invite code your group leader gave you.</div>'
    +'<div class="fg"><label>group invite code</label><input type="text" id="jg-code" placeholder="e.g. GRP-ABCD" style="text-transform:uppercase;letter-spacing:2px"></div>'
    +'<button class="btn btn-p btn-full" onclick="doJoinGroup()">join group</button>');
}
async function doJoinGroup(){
  var code=document.getElementById('jg-code').value.trim().toUpperCase();
  if(!code){toast('please enter an invite code üòä');return;}
  if(DEMO){toast('demo mode ‚Äî in a real account this would connect you to the group');return;}

  toast('looking up group...');
  var leader=await findLeaderByCode(code);
  if(!leader){toast('code not found ‚Äî double-check with your group leader üòä');return;}

  // Write group_id to the member's own profiles row ‚Äî reliable, column definitely exists
  var r=await sb.from('profiles').update({group_id:leader.id}).eq('id',CU.id);
  if(r.error){toast('error joining group: '+r.error.message);return;}

  CU.groupId=leader.id;
  GD=leader.data.GD||{name:'',start:'',next:{day:'',time:'',loc:'',freq:'weekly'},study:'',hw:'',stats:{meetings:0,answered:0,books:0}};
  autoSave();
  closeModal();
  toast('you\'ve joined '+(GD.name||'the group')+'! üéâ');
  goPage('home');
}

function modalInviteCode(){
  var code=DEMO?'GRP-THUR':(CU.groupCode||(CU.groupCode=genCode('GRP')));
  openModal(mClose()+'<h2>üîó group invite code</h2>'
    +'<div class="modal-sub">share this code with anyone you want in your group. they\'ll enter it when creating their groupify account.</div>'
    +'<div style="text-align:center;padding:24px;background:var(--brand-p);border-radius:var(--rsm);margin-bottom:18px">'
    +'<div style="font-size:36px;font-weight:700;color:var(--brand);letter-spacing:4px">'+code+'</div>'
    +'</div>'
    +'<button class="btn btn-p btn-full" onclick="navigator.clipboard.writeText(\''+code+'\');toast(\'code copied! üìã\')">copy code</button>');
}

// Scratch state for ministry resource session building
var newResSessions=[];

function modalAddRes(scope){
  var label=scope==='ministry'?'all groups in your ministry':'your group only';
  newResSessions=[];
  openModal(mClose()+'<h2>üìö add a resource</h2>'
    +'<div class="modal-sub">this resource will be visible to <strong>'+label+'</strong>.</div>'
    +'<div class="fg"><label>title</label><input type="text" id="res-title" placeholder="e.g. The Chosen - Season 1"></div>'
    +'<div class="fg"><label>type</label><select id="res-type"><option>Bible Study</option><option>Video Series</option><option>Book</option><option>Devotional</option><option>Podcast</option><option>Other</option></select></div>'
    +'<div class="fg"><label>description</label><textarea rows="3" id="res-desc" placeholder="brief description of what this resource covers..."></textarea></div>'
    +'<div class="fg"><label>topic tags (optional, comma-separated)</label><input type="text" id="res-tags-input" placeholder="e.g. faith, prayer, community"></div>'
    +(scope==='ministry'
      ?'<div style="border-top:1px solid var(--border);margin:16px 0 12px"></div>'
        +'<div style="font-size:14px;font-weight:600;color:var(--dark);margin-bottom:4px">sessions (optional)</div>'
        +'<div style="font-size:13px;color:var(--muted);margin-bottom:12px">add sessions so groups can follow along week by week.</div>'
        +'<div id="new-sessions-list"></div>'
        +'<button class="btn btn-s btn-full" style="margin-bottom:14px" onclick="addNewResSession()">+ add session</button>'
      :'')
    +'<button class="btn btn-p btn-full" onclick="saveResource(\''+scope+'\')">add resource</button>');
}
function addNewResSession(){
  // Save any existing text inputs first
  newResSessions.forEach(function(s,i){
    var tEl=document.getElementById('nrs-title-'+i);
    var aEl=document.getElementById('nrs-assign-'+i);
    if(tEl) s.title=tEl.value;
    if(aEl) s.assignment=aEl.value;
  });
  newResSessions.push({title:'Session '+(newResSessions.length+1),assignment:''});
  renderNewSessions();
}
function removeNewResSession(i){
  newResSessions.forEach(function(s,j){
    var tEl=document.getElementById('nrs-title-'+j);
    var aEl=document.getElementById('nrs-assign-'+j);
    if(tEl) s.title=tEl.value;
    if(aEl) s.assignment=aEl.value;
  });
  newResSessions.splice(i,1);
  renderNewSessions();
}
function renderNewSessions(){
  var el=document.getElementById('new-sessions-list');
  if(!el) return;
  el.innerHTML=newResSessions.map(function(s,i){
    return '<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--rsm);padding:12px;margin-bottom:8px">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
      +'<div style="font-size:12px;font-weight:600;color:var(--brand)">session '+(i+1)+'</div>'
      +'<button onclick="removeNewResSession('+i+')" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:14px">‚úï</button>'
      +'</div>'
      +'<input type="text" id="nrs-title-'+i+'" value="'+s.title.replace(/"/g,'&quot;')+'" placeholder="session title" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:8px 10px;font-family:inherit;font-size:13px;background:#fff;margin-bottom:6px">'
      +'<input type="text" id="nrs-assign-'+i+'" value="'+s.assignment.replace(/"/g,'&quot;')+'" placeholder="reading or assignment (optional)" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:8px 10px;font-family:inherit;font-size:13px;background:#fff">'
      +'</div>';
  }).join('');
}
function saveResource(scope){
  var title=document.getElementById('res-title').value.trim();
  var type=document.getElementById('res-type').value;
  var desc=document.getElementById('res-desc').value.trim();
  var tagsEl=document.getElementById('res-tags-input');
  var tags=tagsEl?tagsEl.value.split(',').map(function(t){return t.trim();}).filter(Boolean):[];
  if(!title){toast('please enter a title üòä');return;}
  // Collect final session values
  if(scope==='ministry'){
    newResSessions.forEach(function(s,i){
      var tEl=document.getElementById('nrs-title-'+i);
      var aEl=document.getElementById('nrs-assign-'+i);
      if(tEl) s.title=tEl.value;
      if(aEl) s.assignment=aEl.value;
    });
  }
  var res={id:'mr'+Date.now(),title:title,type:type,desc:desc,tags:tags};
  if(newResSessions.length>0) res.sessions=JSON.parse(JSON.stringify(newResSessions));
  if(scope==='ministry'){
    var arr=DEMO?MINISTRY_RESOURCES:REAL_MINISTRY_RESOURCES;
    arr.unshift(res);
    closeModal(); pgMinRes();
  } else {
    if(!CU.groupResources) CU.groupResources=[];
    CU.groupResources.unshift(res);
    closeModal(); pgResources();
  }
  toast('resource added üìö');
  autoSave();
}

function modalEditMinRes(id){
  var arr=DEMO?MINISTRY_RESOURCES:REAL_MINISTRY_RESOURCES;
  var res=arr.find(function(r){return r.id===id});
  if(!res){toast('resource not found');return;}
  var html=mClose()+'<h2>‚úèÔ∏è edit resource</h2>'
    +'<div class="fg"><label>title</label><input type="text" id="er-title" value="'+res.title.replace(/"/g,'&quot;')+'"></div>'
    +'<div class="fg"><label>type</label><select id="er-type"><option>Bible Study</option><option>Video Series</option><option>Book</option><option>Devotional</option><option>Podcast</option><option>Other</option></select></div>'
    +'<div class="fg"><label>description</label><textarea rows="3" id="er-desc">'+res.desc+'</textarea></div>'
    +'<div style="border-top:1px solid var(--border);margin:14px 0 10px"></div>'
    +'<div style="font-size:14px;font-weight:600;color:var(--dark);margin-bottom:10px">sessions</div>'
    +'<div id="edit-sessions-list">'
    +(res.sessions||[]).map(function(s,i){
      return '<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--rsm);padding:12px;margin-bottom:8px">'
        +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
        +'<div style="font-size:12px;font-weight:600;color:var(--brand)">session '+(i+1)+'</div>'
        +'</div>'
        +'<input type="text" id="ers-title-'+i+'" value="'+s.title.replace(/"/g,'&quot;')+'" placeholder="session title" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:8px 10px;font-family:inherit;font-size:13px;background:#fff;margin-bottom:6px">'
        +'<input type="text" id="ers-assign-'+i+'" value="'+(s.assignment||'').replace(/"/g,'&quot;')+'" placeholder="assignment (optional)" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:8px 10px;font-family:inherit;font-size:13px;background:#fff">'
        +'</div>';
    }).join('')
    +'</div>'
    +'<button class="btn btn-s btn-full" style="margin-bottom:12px" onclick="addEditResSession(\''+id+'\')">+ add session</button>'
    +'<button class="btn btn-p btn-full" onclick="saveEditMinRes(\''+id+'\')">save changes</button>';
  // Set type dropdown after render
  openModal(html);
  setTimeout(function(){
    var sel=document.getElementById('er-type');
    if(sel) sel.value=res.type;
  },10);
}
function addEditResSession(id){
  var arr=DEMO?MINISTRY_RESOURCES:REAL_MINISTRY_RESOURCES;
  var res=arr.find(function(r){return r.id===id});
  if(!res) return;
  if(!res.sessions) res.sessions=[];
  // Save existing values
  res.sessions.forEach(function(s,i){
    var tEl=document.getElementById('ers-title-'+i);
    var aEl=document.getElementById('ers-assign-'+i);
    if(tEl) s.title=tEl.value;
    if(aEl) s.assignment=aEl.value;
  });
  res.sessions.push({title:'Session '+(res.sessions.length+1),assignment:''});
  modalEditMinRes(id);
}
function saveEditMinRes(id){
  var arr=DEMO?MINISTRY_RESOURCES:REAL_MINISTRY_RESOURCES;
  var res=arr.find(function(r){return r.id===id});
  if(!res) return;
  var titleEl=document.getElementById('er-title');
  var typeEl=document.getElementById('er-type');
  var descEl=document.getElementById('er-desc');
  if(titleEl) res.title=titleEl.value;
  if(typeEl) res.type=typeEl.value;
  if(descEl) res.desc=descEl.value;
  if(res.sessions){
    res.sessions.forEach(function(s,i){
      var tEl=document.getElementById('ers-title-'+i);
      var aEl=document.getElementById('ers-assign-'+i);
      if(tEl) s.title=tEl.value;
      if(aEl) s.assignment=aEl.value;
    });
  }
  closeModal(); pgMinRes(); toast('resource updated ‚úÖ');
  autoSave();
}

function modalAddHost(){
  openModal(mClose()+'<h2>üè° add a host</h2>'
    +'<div class="fg"><label>name</label><input type="text" id="h-name" placeholder="e.g. Marcus & Jenna"></div>'
    +'<div class="fg"><label>address</label><input type="text" id="h-addr" placeholder="123 Main Street"></div>'
    +'<button class="btn btn-p btn-full" onclick="saveHost()">add host</button>');
}
function saveHost(){
  var n=document.getElementById('h-name').value.trim();
  var a=document.getElementById('h-addr').value.trim();
  if(!n){toast('please enter a name üòä');return;}
  ROTATION.push({n:n,a:a});
  closeModal(); pgRotation(); toast('host added üè°');
}

function modalEditSurvey(){
  var html=mClose()+'<h2>‚úèÔ∏è edit health survey</h2>'
    +'<div style="font-size:14px;color:var(--muted);margin-bottom:18px;line-height:1.6">customize the questions your group members answer during health check-ins. changes apply to all your groups.</div>'
    +'<div id="sq-list">';
  AQ.forEach(function(q,i){
    html+='<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--rsm);padding:14px;margin-bottom:10px">'
      +'<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px">'
      +'<div style="font-size:12px;font-weight:600;color:var(--brand)">question '+(i+1)+'</div>'
      +'<button onclick="deleteSurveyQ('+i+')" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:0;line-height:1">‚úï</button>'
      +'</div>'
      +'<input type="text" value="'+q.q.replace(/"/g,'&quot;')+'" onchange="AQ['+i+'].q=this.value" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:9px 12px;font-family:inherit;font-size:14px;background:#fff;margin-bottom:8px">'
      +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
      +'<div><div style="font-size:11px;color:var(--muted);margin-bottom:4px">low label (left side)</div>'
      +'<input type="text" value="'+q.lo+'" onchange="AQ['+i+'].lo=this.value" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:8px 10px;font-family:inherit;font-size:13px;background:#fff"></div>'
      +'<div><div style="font-size:11px;color:var(--muted);margin-bottom:4px">high label (right side)</div>'
      +'<input type="text" value="'+q.hi+'" onchange="AQ['+i+'].hi=this.value" style="width:100%;border:1.5px solid var(--border);border-radius:var(--rsm);padding:8px 10px;font-family:inherit;font-size:13px;background:#fff"></div>'
      +'</div></div>';
  });
  html+='</div>'
    +'<button class="btn btn-s btn-full" style="margin-bottom:10px" onclick="addSurveyQ()">+ add question</button>'
    +'<button class="btn btn-g btn-sm" onclick="AQ=JSON.parse(JSON.stringify(AQ_DEFAULT));closeModal();toast(\'questions reset to defaults ‚úÖ\')">reset to defaults</button>'
    +'<button class="btn btn-p btn-full mt-10" onclick="closeModal();toast(\'survey updated ‚úÖ\')">save changes</button>';
  openModal(html);
}
function deleteSurveyQ(i){
  if(AQ.length<=2){toast('surveys need at least 2 questions üòä');return;}
  AQ.splice(i,1);
  modalEditSurvey();
}
function addSurveyQ(){
  AQ.push({q:'New question ‚Äî click to edit',lo:'low',hi:'high'});
  modalEditSurvey();
  setTimeout(function(){
    var list=document.getElementById('sq-list');
    if(list) list.scrollTop=list.scrollHeight;
  },50);
}

function modalAddSlot(){
  openModal(mClose()+'<h2>üóìÔ∏è add a time slot</h2>'
    +'<div class="fg"><label>day</label><select id="sl-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>'
    +'<div class="fg"><label>date</label><input type="text" id="sl-date" placeholder="e.g. March 5"></div>'
    +'<div class="fg"><label>time</label><select id="sl-time">'+timeOptions()+'</select></div>'
    +'<button class="btn btn-p btn-full" onclick="saveSlot()">add slot</button>');
}
function saveSlot(){
  var day=document.getElementById('sl-day').value;
  var date=document.getElementById('sl-date').value.trim();
  var time=document.getElementById('sl-time').value;
  if(!date){toast('please enter a date üòä');return;}
  SCHED_SLOTS.push({id:Date.now(),day:day,date:date,time:time,votes:0});
  closeModal(); pgSched(); toast('slot added üóìÔ∏è');
}

function modalStudyQuiz(){
  openModal(mClose()+'<h2>üß≠ study recommendation</h2>'
    +'<div class="fg"><label>what is your group\'s biggest focus right now?</label>'
    +'<select id="q-focus"><option>growing in faith</option><option>building community</option><option>serving others</option><option>navigating life challenges</option></select></div>'
    +'<div class="fg"><label>how long has your group been together?</label>'
    +'<select id="q-age"><option>just getting started</option><option>less than a year</option><option>1-3 years</option><option>3+ years</option></select></div>'
    +'<div class="fg"><label>what format does your group prefer?</label>'
    +'<select id="q-format"><option>video-based discussion</option><option>book study</option><option>Bible deep-dive</option><option>something lighter</option></select></div>'
    +'<button class="btn btn-a btn-full" onclick="showRec()">get my recommendation ‚Üí</button>');
}
function showRec(){
  var recs=[
    {type:'Bible Study',title:'James: Faith That Works',desc:'Perfect for groups ready to wrestle with practical, everyday faith. Short book, deep content.',tags:['faith','works','practical']},
    {type:'Video Series',title:'The Chosen - Season 1',desc:'A beautiful way to experience the life of Jesus together. Great for all stages of faith.',tags:['jesus','video','community']},
    {type:'Bible Study',title:'Philippians: Joy in Every Season',desc:'Four chapters packed with hope, contentment, and joy. Works for any group.',tags:['joy','hope','encouragement']}
  ];
  var r=recs[Math.floor(Math.random()*recs.length)];
  openModal(mClose()+'<h2>üß≠ our recommendation</h2>'
    +'<div class="res-card" style="margin-bottom:16px">'
    +'<div class="res-type">'+r.type+'</div>'
    +'<div class="res-title">'+r.title+'</div>'
    +'<div class="res-desc">'+r.desc+'</div>'
    +'<div class="res-tags">'+r.tags.map(function(t){return '<span class="chip">'+t+'</span>'}).join('')+'</div>'
    +'</div>'
    +'<button class="btn btn-p btn-full" onclick="setStudy(\''+r.title+'\');closeModal()">üìñ set as current study</button>'
    +'<button class="btn btn-g btn-full mt-10" onclick="modalStudyQuiz()">try again</button>');
}

/* ============================================================
   SIGNUP FLOW
   ============================================================ */
function pickRole(role){
  caRole=role;
  document.querySelectorAll('.role-opt').forEach(function(el){el.classList.remove('sel')});
  var el=document.getElementById('ro-'+role);
  if(el) el.classList.add('sel');
}
function caStep2(){
  if(!caRole){toast('please select a role to continue üòä');return;}
  showView('v-ca2');
}
function caStep3(){
  var fname=document.getElementById('ca-fname').value.trim();
  var lname=document.getElementById('ca-lname').value.trim();
  var email=document.getElementById('ca-email').value.trim();
  var pw=document.getElementById('ca-pw').value;
  var pw2=document.getElementById('ca-pw2').value;
  if(!fname||!lname){toast('please enter your name üòä');return;}
  if(!email){toast('please enter your email üòä');return;}
  if(pw.length<8){toast('password must be at least 8 characters üòä');return;}
  if(pw!==pw2){toast('passwords don\'t match üòä');return;}
  var body='';
  if(caRole==='ministry'){
    body='<div class="fg"><label>church or ministry name</label><input type="text" id="ca-church" placeholder="e.g. River Community Church"></div>'
      +'<div class="fg"><label>your title / role</label><input type="text" id="ca-title" placeholder="e.g. Small Groups Pastor"></div>';
  } else if(caRole==='leader'){
    body='<div class="fg"><label>group name</label><input type="text" id="ca-gname" placeholder="e.g. Thursday Night Crew"></div>'
      +'<div class="fg"><label>ministry invite code (optional)</label><input type="text" id="ca-mcode" placeholder="enter your ministry\'s code if you have one"></div>';
  } else {
    body='<div class="banner banner-green" style="margin-bottom:0">üëã almost there! after creating your account, you\'ll enter your group\'s invite code to connect.</div>';
  }
  document.getElementById('ca3-body').innerHTML=body;
  showView('v-ca3');
}
async function caFinish(){
  var fname=document.getElementById('ca-fname').value.trim();
  var lname=document.getElementById('ca-lname').value.trim();
  var email=document.getElementById('ca-email').value.trim();
  var pw=document.getElementById('ca-pw').value;
  var btn=document.getElementById('ca-finish-btn');
  btn.textContent='creating account...'; btn.disabled=true;
  try {
    var meta={full_name:fname+' '+lname,role:caRole};
    if(caRole==='ministry'){
      meta.church_name=(document.getElementById('ca-church')||{value:''}).value.trim();
    } else if(caRole==='leader'){
      meta.ministry_code=(document.getElementById('ca-mcode')||{value:''}).value.trim();
    }
    // No group_code at signup ‚Äî member enters invite code after login
    var r=await sb.auth.signUp({email:email,password:pw,options:{data:meta,emailRedirectTo:'https://ebpeyt88.github.io/groupify/'}});
    if(r.error){toast('sign up failed: '+r.error.message+' üòï');btn.textContent='create account üéâ';btn.disabled=false;return;}
    // Skip email confirmation screen (turned off in Supabase) ‚Äî go straight to sign in
    toast('account created! sign in to get started üéâ');
    showView('v-signin');
  } catch(e){
    toast('error: '+e.message);
    btn.textContent='create account üéâ'; btn.disabled=false;
  }
}

/* ============================================================
   SESSION CHECK ON LOAD
   ============================================================ */
window.addEventListener('DOMContentLoaded', async function(){
  if(!sb) return;
  try {
    var r=await sb.auth.getSession();
    if(r.data&&r.data.session) await loadProfile(r.data.session.user);
  } catch(e){ console.log('Session check failed:',e); }
});
</script>
</body>
</html>
